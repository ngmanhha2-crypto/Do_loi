<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BVST ‚Ä¢ L·ªçc l·ªói tr√πng th·ªùi gian X‚Äëquang (Offline)</title>
  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --brand:#0ea5e9; --brandDark:#0284c7; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
      --softWarn: rgba(245,158,11,.10); --softBrand: rgba(14,165,233,.10);
      --shadow: 0 12px 36px rgba(2,6,23,.08); --radius:18px;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{background:linear-gradient(90deg, rgba(14,165,233,.14), rgba(34,197,94,.10));
      border:1px solid var(--line); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow);
      display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:14px;background:#fff;border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--brandDark)}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .pill{border:1px solid var(--line); background:#fff; color:var(--muted); padding:6px 10px;border-radius:999px;font-size:12px}
    .grid{display:grid;grid-template-columns:420px 1fr;gap:14px;margin-top:14px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .card h2{font-size:14px;margin:0 0 10px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input[type="file"],input[type="number"],input[type="text"],select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;outline:none;background:#fff;font-size:14px}
    input[type="number"]{font-family:var(--mono)}
    .hint{margin-top:10px;padding:10px 12px;border-radius:14px;border-left:4px solid rgba(22,163,74,.7);
      background:rgba(22,163,74,.06);color:var(--muted);font-size:13px}
    .warnbox{margin-top:10px;padding:10px 12px;border-radius:14px;border-left:4px solid rgba(245,158,11,.8);
      background:rgba(245,158,11,.08);color:var(--muted);font-size:13px}
    .errbox{margin-top:10px;padding:10px 12px;border-radius:14px;border-left:4px solid rgba(239,68,68,.85);
      background:rgba(239,68,68,.06);color:#991b1b;font-size:13px;white-space:pre-wrap}
    .switches{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .sw{display:flex;align-items:center;gap:10px}
    .sw input{width:40px;height:22px;appearance:none;background:#cbd5e1;border-radius:999px;position:relative;outline:none;cursor:pointer;transition:.15s}
    .sw input:checked{background:rgba(14,165,233,.85)}
    .sw input:before{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:999px;background:#fff;transition:.15s}
    .sw input:checked:before{left:21px}
    .sw span{font-size:13px}

    .actions{position:sticky;top:12px;z-index:10;background:rgba(243,246,251,.75);backdrop-filter:blur(8px);
      padding:10px;border-radius:16px;border:1px solid rgba(226,232,240,.9);display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .btn{border:none;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer;font-size:14px;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:var(--brand);color:#fff}
    .btn-primary:hover{background:var(--brandDark)}
    .btn-secondary{background:#fff;border:1px solid var(--line);color:var(--ink)}
    .btn-secondary:hover{background:#f8fafc}
    .btn-success{background:var(--ok);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:980px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{border:1px solid var(--line);border-radius:16px;padding:12px;background:#fff}
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:24px;font-weight:900;letter-spacing:-.02em;margin-top:4px}
    .kpi .s{font-size:12px;color:var(--muted);margin-top:2px}
    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}

    .tablewrap{max-height:58vh;overflow:auto;border:1px solid var(--line);border-radius:16px;background:#fff;margin-top:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--line);
      padding:10px;text-align:left;font-size:12px;color:var(--muted);white-space:nowrap}
    tbody td{border-bottom:1px solid rgba(226,232,240,.7);padding:10px;font-size:13px;vertical-align:top}
    tbody tr.err{background:var(--softWarn)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:900;
      border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.18);color:#92400e;white-space:nowrap}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">BV</div>
        <div>
          <h1>L·ªçc l·ªói tr√πng th·ªùi gian ‚Äî Ca <b>X‚Äëquang</b> (Offline)</h1>
          <div class="sub">Kh√¥ng c·∫ßn Internet. Nh·∫≠n di·ªán ƒë√∫ng header d√π CSV c√≥ nhi·ªÅu d√≤ng ti√™u ƒë·ªÅ ph√≠a tr√™n.</div>
        </div>
      </div>
      <div class="row">
        <span class="pill">Ch·ªß ƒë·ªÅ s√°ng</span>
        <span class="pill">∆Øu ti√™n CSV</span>
        <span class="pill">T·ª± d√≤ header</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>1) T·∫£i d·ªØ li·ªáu</h2>
        <label>Ch·ªçn file d·ªØ li·ªáu</label>
        <input id="file" type="file" accept=".csv,.txt,.tsv" />
        <div class="hint">
          ‚úÖ D√πng <b>CSV UTF‚Äë8</b> (t·ª´ Excel). Trang s·∫Ω t·ª± t√¨m d√≤ng header (th∆∞·ªùng b·∫Øt ƒë·∫ßu b·∫±ng <span class="mono">STT, ‚Ä¶</span>) v√† b·ªè qua ph·∫ßn ti√™u ƒë·ªÅ ph√≠a tr√™n.
        </div>
        <div class="warnbox">
          N·∫øu file c√≥ d·∫•u ph·∫©y <span class="mono">,</span> ho·∫∑c ch·∫•m ph·∫©y <span class="mono">;</span> trang ƒë·ªÅu t·ª± nh·∫≠n.
        </div>

        <h2 style="margin-top:14px">2) Ti√™u ch√≠ & quy t·∫Øc l·ªói</h2>
        <div class="switches">
          <div class="sw">
            <input id="xqByService" type="checkbox" checked>
            <span>Nh·∫≠n di·ªán X‚Äëquang theo <b>T√™n DVKT</b> ch·ª©a ‚Äúx‚Äëquang / xq / x‚Äëray‚Äù</span>
          </div>
          <div class="sw">
            <input id="xqByMachine" type="checkbox" checked>
            <span>Nh·∫≠n di·ªán X‚Äëquang theo <b>M√£ m√°y</b> b·∫Øt ƒë·∫ßu ‚ÄúXQ‚Äù</span>
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:160px">
            <label>C·∫£nh b√°o ‚Äúth·ª±c hi·ªán d∆∞·ªõi‚Äù (ph√∫t)</label>
            <input id="minMinutes" type="number" value="6" min="1" step="1">
          </div>
          <div style="flex:1;min-width:160px">
            <label>L√†m tr√≤n ƒë·ªÉ so tr√πng (ph√∫t)</label>
            <input id="roundToMin" type="number" value="1" min="1" step="1">
          </div>
        </div>

        <div id="diag" class="errbox" style="display:none"></div>
      </div>

      <div class="card">
        <div class="actions">
          <button id="btnRun" class="btn btn-primary" disabled>üîé PH√ÇN T√çCH</button>
          <button id="btnExport" class="btn btn-success" disabled>‚¨áÔ∏è Xu·∫•t CSV l·ªói</button>
          <button id="btnClear" class="btn btn-secondary">üßπ Xo√°</button>
          <span class="mono muted">Tip: Ctrl + F ƒë·ªÉ t√¨m nhanh</span>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="t">T·ªïng d√≤ng ƒë·ªçc</div><div class="v" id="kpiRows">‚Äî</div><div class="s mono" id="kpiFile">File: ‚Äî</div></div>
          <div class="kpi"><div class="t">D√≤ng X‚Äëquang</div><div class="v" id="kpiXQ">‚Äî</div><div class="s">Theo ti√™u ch√≠ ƒëang b·∫≠t</div></div>
          <div class="kpi"><div class="t">S·ªë l·ªói</div><div class="v" id="kpiErrors">‚Äî</div><div class="s">Tr√πng / th·ªùi gian ng·∫Øn</div></div>
          <div class="kpi"><div class="t">Lo·∫°i l·ªói</div><div class="v" id="kpiTypes">‚Äî</div><div class="s">S·ªë nh√≥m l·ªói</div></div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <div style="flex:2;min-width:260px">
            <label>L·ªçc nhanh</label>
            <input id="q" type="text" placeholder="VD: Tr√πng th·ªùi gian b·∫Øt ƒë·∫ßu, XQ.2..., t√™n KTV, m√£ KCB..." />
          </div>
          <div style="flex:1;min-width:200px">
            <label>Lo·∫°i l·ªói</label>
            <select id="typeFilter"><option value="">(T·∫•t c·∫£)</option></select>
          </div>
          <div style="flex:1;min-width:200px">
            <label>S·∫Øp x·∫øp</label>
            <select id="sortBy">
              <option value="time">Th·ªùi gian</option>
              <option value="type">Lo·∫°i l·ªói</option>
              <option value="machine">M√£ m√°y ‚Üí Th·ªùi gian</option>
            </select>
          </div>
          <div style="flex:0;min-width:180px">
            <label>&nbsp;</label>
            <button id="btnCopySummary" class="btn btn-secondary" style="width:100%">üìã Copy t√≥m t·∫Øt</button>
          </div>
        </div>

        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Lo·∫°i l·ªói</th><th>M√¥ t·∫£</th><th>M√£ m√°y</th><th>Ng∆∞·ªùi TH</th><th>B√°c sƒ©</th>
                <th>M√£ KCB</th><th>DVKT</th><th>Bƒê</th><th>KT</th><th>Ph√∫t</th><th>D√≤ng li√™n quan</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="12" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫£i <b>CSV</b> v√† b·∫•m <b>PH√ÇN T√çCH</b>.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:8px;font-size:12px">
          <span class="badge" style="border-color: rgba(14,165,233,.3); background: var(--softBrand); color:#075985">Quy t·∫Øc</span>
          Tr√πng Bƒê: c√πng th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu (sau l√†m tr√≤n) v√† kh√°c m√£ m√°y ‚Ä¢ Tr√πng KT: c√πng th·ªùi ƒëi·ªÉm k·∫øt th√∫c ‚Ä¢ Th·ª±c hi·ªán &lt; ng∆∞·ª°ng ph√∫t.
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  let fileName="‚Äî", allRows=[], xqRows=[], errors=[];

  function diag(msg){
    const d=$("diag");
    d.style.display = msg ? "block" : "none";
    d.textContent = msg || "";
  }
  function safe(v){ return v==null ? "" : String(v); }

  function parseDateLoose(s){
    if (!s) return null;
    const t = Date.parse(s);
    if (!Number.isNaN(t)) return new Date(t);
    const m = String(s).trim().replace(/\s+/g," ").match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);
    if (m){
      let d=parseInt(m[1],10), mo=parseInt(m[2],10)-1, y=parseInt(m[3],10);
      if (y<100) y+=2000;
      let hh=m[4]?parseInt(m[4],10):0;
      const mm=m[5]?parseInt(m[5],10):0;
      const ss=m[6]?parseInt(m[6],10):0;
      const ap=m[7]?m[7].toUpperCase():null;
      if (ap==="PM" && hh<12) hh+=12;
      if (ap==="AM" && hh===12) hh=0;
      const dt=new Date(y,mo,d,hh,mm,ss);
      if (!Number.isNaN(dt.getTime())) return dt;
    }
    return null;
  }
  function fmt(dt){
    if (!dt) return "";
    try{
      return new Intl.DateTimeFormat("vi-VN", {
        timeZone:"Asia/Ho_Chi_Minh",
        year:"numeric",month:"2-digit",day:"2-digit",
        hour:"2-digit",minute:"2-digit"
      }).format(dt);
    }catch(e){ return dt.toLocaleString(); }
  }
  function minutesBetween(a,b){ return Math.round((b.getTime()-a.getTime())/60000); }
  function bucketTime(dt, roundToMin){
    if (!dt) return "";
    const bucket=Math.max(1,roundToMin)*60000;
    return String(Math.floor(dt.getTime()/bucket)*bucket);
  }

  function parseCSVSmart(text){
    const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim()!=="");
    if (!lines.length) return {headers:[], rows:[], headerIndex:-1};

    // delimiter detect from the first "structured" line (most commas/semicolons)
    let bestIdx=0, bestScore=-1, bestDelim=",";
    for (let i=0;i<Math.min(50,lines.length);i++){
      const l=lines[i];
      const comma=(l.match(/,/g)||[]).length;
      const semi=(l.match(/;/g)||[]).length;
      const tab=(l.match(/\t/g)||[]).length;
      const score=Math.max(comma,semi,tab);
      if (score>bestScore){ bestScore=score; bestIdx=i; bestDelim= tab>0 ? "\t" : (semi>comma ? ";" : ","); }
    }
    const delim = bestDelim;

    const splitLine = (line)=>{
      const out=[]; let cur="", inQ=false;
      for (let i=0;i<line.length;i++){
        const ch=line[i];
        if (ch === '"'){
          if (inQ && line[i+1] === '"'){ cur+='"'; i++; }
          else inQ=!inQ;
        }else if(!inQ && ch===delim){
          out.push(cur); cur="";
        }else cur+=ch;
      }
      out.push(cur);
      return out.map(s=>s.trim());
    };

    // find header line: contains "T√™n DVKT" and (Ng√†y th·ª±c hi·ªán/Ng√†y v√†o) and (Ng√†y k·∫øt qu·∫£/Ng√†y ra)
    let headerIndex=-1;
    for (let i=0;i<Math.min(200,lines.length);i++){
      const l = lines[i];
      const low = l.toLowerCase();
      const hasTen = low.includes("t√™n dvkt") || low.includes("ten dvkt") || low.includes("dvkt");
      const hasStart = low.includes("ng√†y th·ª±c hi·ªán") || low.includes("ngay thuc hien") || low.includes("ng√†y v√†o") || low.includes("ngay vao");
      const hasEnd = low.includes("ng√†y k·∫øt qu·∫£") || low.includes("ngay ket qua") || low.includes("ng√†y ra") || low.includes("ngay ra");
      if (hasTen && hasStart && hasEnd){
        headerIndex=i; break;
      }
    }
    if (headerIndex===-1) headerIndex=bestIdx; // fallback

    const headers = splitLine(lines[headerIndex]).map(h=>h.replace(/^\uFEFF/,"").trim());
    const rows=[];
    for (let r=headerIndex+1;r<lines.length;r++){
      const cols=splitLine(lines[r]);
      if (cols.every(c=>c==="")) continue;
      rows.push(cols);
    }
    return {headers, rows, headerIndex};
  }

  function normalizeHeader(h){
    return safe(h).trim().toLowerCase().replace(/\s+/g," ").replace(/[‚Äú‚Äù"]/g,'"');
  }
  function mapHeaders(headers){
    const idx={}; headers.forEach((h,i)=>{ idx[normalizeHeader(h)] = i; });
    const pick=(cands)=>{
      for (const c of cands){
        const k=normalizeHeader(c);
        if (k in idx) return idx[k];
      }
      for (const c of cands){
        const k=normalizeHeader(c);
        for (const key in idx){
          if (key.includes(k)) return idx[key];
        }
      }
      return -1;
    };
    return {
      ten: pick(["t√™n dvkt","ten dvkt","d·ªãch v·ª• k·ªπ thu·∫≠t","dvkt"]),
      maMay: pick(["m√£ m√°y","ma may","mamy"]),
      nguoiTH: pick(["ng∆∞·ªùi th·ª±c hi·ªán","nguoi thuc hien","ng∆∞·ªùi th","ktv"]),
      bacSi: pick(["b√°c sƒ©","bac si"]),
      maKCB: pick(["m√£ kcb","ma kcb"]),
      // IMPORTANT: accept both variants
      start: pick(["ng√†y th·ª±c hi·ªán yl","ng√†y th·ª±c hi·ªán","ngay thuc hien yl","ngay thuc hien","ng√†y v√†o","ngay vao"]),
      end: pick(["ng√†y k·∫øt qu·∫£","ngay ket qua","ng√†y ra","ngay ra"])
    };
  }

  function isXQ(row, byService, byMachine){
    const ten=safe(row.ten).toLowerCase();
    const ma=safe(row.maMay).trim().toUpperCase();
    const okService = byService ? (ten.includes("x-quang")||ten.includes("x quang")||ten.includes("xq")||ten.includes("x-ray")||ten.includes("xray")) : false;
    const okMachine = byMachine ? ma.startsWith("XQ") : false;
    if (byService && byMachine) return okService || okMachine;
    if (byService) return okService;
    if (byMachine) return okMachine;
    return true;
  }

  function mkErr(type,row,desc,relatedRows=[]){
    const dur=(row.start && row.end) ? minutesBetween(row.start,row.end) : null;
    return {
      type, desc,
      maMay: row.maMay, nguoiTH: row.nguoiTH, bacSi: row.bacSi, maKCB: row.maKCB, ten: row.ten,
      start: row.start, end: row.end, duration: dur,
      rownum: row.rownum,
      related: relatedRows.map(r=>r.rownum).join(", ")
    };
  }

  function analyze(){
    const minMinutes=Math.max(1, parseInt($("minMinutes").value||"6",10));
    const roundToMin=Math.max(1, parseInt($("roundToMin").value||"1",10));
    const byService=$("xqByService").checked;
    const byMachine=$("xqByMachine").checked;

    xqRows = allRows.filter(r=>isXQ(r,byService,byMachine));

    const out=[];
    // duration short
    for (const r of xqRows){
      if (r.start && r.end){
        const dur=minutesBetween(r.start,r.end);
        if (dur>=0 && dur<minMinutes){
          out.push(mkErr("Th·ª±c hi·ªán d∆∞·ªõi 6 ph√∫t", r, `Th·ªùi gian th·ª±c hi·ªán ${dur} ph√∫t < ${minMinutes} ph√∫t`, []));
        }
      }
    }
    // duplicate start across different machines
    const mapStart=new Map();
    for (const r of xqRows){
      if (!r.start) continue;
      const key=bucketTime(r.start, roundToMin);
      if (!mapStart.has(key)) mapStart.set(key, []);
      mapStart.get(key).push(r);
    }
    for (const [key,arr] of mapStart.entries()){
      if (arr.length<2) continue;
      const machines=new Set(arr.map(x=>safe(x.maMay).trim()).filter(Boolean));
      if (machines.size>=2){
        for (const r of arr){
          const others=arr.filter(x=>x!==r);
          const otherMachines=Array.from(new Set(others.map(x=>safe(x.maMay).trim()).filter(Boolean))).join(", ");
          out.push(mkErr("Tr√πng th·ªùi gian b·∫Øt ƒë·∫ßu", r, `C√πng Bƒê (${fmt(r.start)}) nh∆∞ng kh√°c m√°y. M√°y kh√°c: ${otherMachines||"(kh√¥ng r√µ)"}`, others));
        }
      }
    }
    // duplicate end time
    const mapEnd=new Map();
    for (const r of xqRows){
      if (!r.end) continue;
      const key=bucketTime(r.end, roundToMin);
      if (!mapEnd.has(key)) mapEnd.set(key, []);
      mapEnd.get(key).push(r);
    }
    for (const [key,arr] of mapEnd.entries()){
      if (arr.length<2) continue;
      for (const r of arr){
        const others=arr.filter(x=>x!==r);
        out.push(mkErr("Tr√πng th·ªùi gian k·∫øt th√∫c", r, `Tr√πng KT (${fmt(r.end)}) v·ªõi ${others.length} ca kh√°c`, others));
      }
    }

    // dedup
    const seen=new Set(); const ded=[];
    for (const e of out){
      const sig=[e.type,e.rownum,bucketTime(e.start,roundToMin),bucketTime(e.end,roundToMin),e.related].join("|");
      if (seen.has(sig)) continue;
      seen.add(sig); ded.push(e);
    }
    errors=ded;
  }

  function updateKPIs(){
    const types=new Set(errors.map(e=>e.type));
    $("kpiRows").textContent = allRows.length ? String(allRows.length) : "‚Äî";
    $("kpiXQ").textContent = xqRows.length ? String(xqRows.length) : "‚Äî";
    $("kpiErrors").textContent = String(errors.length || 0);
    $("kpiTypes").textContent = String(types.size || 0);
    $("kpiFile").textContent = "File: " + fileName;
  }

  function escapeHtml(s){ return safe(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[c])); }

  function fillTypeFilter(){
    const sel=$("typeFilter");
    const cur=sel.value;
    const types=Array.from(new Set(errors.map(e=>e.type))).sort();
    sel.innerHTML = '<option value="">(T·∫•t c·∫£)</option>' + types.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
    sel.value=cur;
  }

  function render(){
    const q=$("q").value.trim().toLowerCase();
    const typeF=$("typeFilter").value;
    const sortBy=$("sortBy").value;

    let items=errors.slice();
    if (typeF) items=items.filter(e=>e.type===typeF);
    if (q){
      items=items.filter(e=>{
        const blob=[e.type,e.desc,e.maMay,e.nguoiTH,e.bacSi,e.maKCB,e.ten,fmt(e.start),fmt(e.end),e.rownum,e.related].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }
    if (sortBy==="type") items.sort((a,b)=>a.type.localeCompare(b.type) || (a.start?.getTime()||0)-(b.start?.getTime()||0));
    else if (sortBy==="machine") items.sort((a,b)=>safe(a.maMay).localeCompare(safe(b.maMay)) || (a.start?.getTime()||0)-(b.start?.getTime()||0));
    else items.sort((a,b)=>(a.start?.getTime()||0)-(b.start?.getTime()||0));

    const tb=$("tbody");
    if (!items.length){
      tb.innerHTML = `<tr><td colspan="12" class="muted">Kh√¥ng c√≥ l·ªói theo b·ªô l·ªçc hi·ªán t·∫°i.</td></tr>`;
      return;
    }
    tb.innerHTML = items.map((e,i)=>`
      <tr class="err">
        <td class="mono">${i+1}</td>
        <td><span class="badge">${escapeHtml(e.type)}</span></td>
        <td>${escapeHtml(e.desc)}</td>
        <td class="mono">${escapeHtml(e.maMay)}</td>
        <td>${escapeHtml(e.nguoiTH)}</td>
        <td>${escapeHtml(e.bacSi)}</td>
        <td class="mono">${escapeHtml(e.maKCB)}</td>
        <td>${escapeHtml(e.ten)}</td>
        <td class="mono">${escapeHtml(fmt(e.start))}</td>
        <td class="mono">${escapeHtml(fmt(e.end))}</td>
        <td class="mono">${e.duration==null ? "" : e.duration}</td>
        <td class="mono">${escapeHtml(e.related || "")}</td>
      </tr>`).join("");
  }

  function exportCSV(){
    const headers=["LoaiLoi","MoTa","MaMay","NguoiTH","BacSi","MaKCB","TenDVKT","BatDau","KetThuc","Phut","Dong","DongLienQuan"];
    const rows=errors.map(e=>[
      e.type,e.desc,e.maMay,e.nguoiTH,e.bacSi,e.maKCB,e.ten,fmt(e.start),fmt(e.end),e.duration??"",e.rownum??"",e.related??""
    ].map(v=>`"${safe(v).replace(/"/g,'""')}"`).join(","));
    const csv=headers.join(",")+"\n"+rows.join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=`loi_xquang_${new Date().toISOString().slice(0,10)}.csv`;
    a.click(); URL.revokeObjectURL(url);
  }

  async function handleFile(f){
    diag("");
    fileName = f?.name || "‚Äî";
    $("btnRun").disabled = true;
    $("btnRun").title = "ƒêang t·∫£i d·ªØ li·ªáu‚Ä¶";

    if (!f){ diag("Ch∆∞a ch·ªçn file."); return; }

    try{
      const text = await f.text();
      const parsed = parseCSVSmart(text);
      if (!parsed.headers.length){ diag("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c header trong CSV."); return; }

      const col = mapHeaders(parsed.headers);

      const missing=[];
      if (col.start<0) missing.push("Ng√†y th·ª±c hi·ªán/Ng√†y v√†o");
      if (col.end<0) missing.push("Ng√†y k·∫øt qu·∫£/Ng√†y ra");
      if (col.ten<0) missing.push("T√™n DVKT");
      if (col.maMay<0) missing.push("M√£ m√°y");
      if (missing.length){
        diag("Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c c·ªôt b·∫Øt bu·ªôc: " + missing.join(", ") +
             "\n\nG·ª£i √Ω: ki·ªÉm tra d√≤ng header trong file CSV (th∆∞·ªùng b·∫Øt ƒë·∫ßu b·∫±ng 'STT').");
        return;
      }

      allRows = parsed.rows.map((r,idx)=>({
        rownum: (parsed.headerIndex + 2) + idx, // approximate: header line is 0-based
        ten: r[col.ten] ?? "",
        maMay: r[col.maMay] ?? "",
        nguoiTH: col.nguoiTH>=0 ? (r[col.nguoiTH] ?? "") : "",
        bacSi: col.bacSi>=0 ? (r[col.bacSi] ?? "") : "",
        maKCB: col.maKCB>=0 ? (r[col.maKCB] ?? "") : "",
        start: parseDateLoose(r[col.start]),
        end: parseDateLoose(r[col.end]),
      }));

      $("btnRun").disabled = false;
      $("btnRun").title = "S·∫µn s√†ng ph√¢n t√≠ch";
      updateKPIs();
    }catch(err){
      diag("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file. Chi ti·∫øt: " + (err?.message || String(err)));
    }
  }

  $("file").addEventListener("change", (e)=>handleFile(e.target.files?.[0]));

  $("btnRun").addEventListener("click", ()=>{
    try{
      diag("");
      analyze();
      updateKPIs();
      fillTypeFilter();
      render();
      $("btnExport").disabled = errors.length===0;
      if (xqRows.length===0){
        diag("Kh√¥ng t√¨m th·∫•y d√≤ng X‚Äëquang theo ti√™u ch√≠ ƒëang b·∫≠t.\nH√£y th·ª≠ b·∫≠t c·∫£ 2 ti√™u ch√≠ ho·∫∑c ki·ªÉm tra T√™n DVKT/M√£ m√°y trong d·ªØ li·ªáu.");
      }
    }catch(err){
      diag("Ph√¢n t√≠ch th·∫•t b·∫°i. Chi ti·∫øt:\n" + (err?.stack || err?.message || String(err)));
    }
  });

  $("btnExport").addEventListener("click", exportCSV);

  $("btnClear").addEventListener("click", ()=>{
    $("file").value="";
    fileName="‚Äî"; allRows=[]; xqRows=[]; errors=[];
    $("btnRun").disabled=true; $("btnRun").title="Ch·ªçn CSV tr∆∞·ªõc";
    $("btnExport").disabled=true;
    $("q").value=""; $("typeFilter").innerHTML='<option value="">(T·∫•t c·∫£)</option>';
    $("tbody").innerHTML='<tr><td colspan="12" class="muted">Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫£i <b>CSV</b> v√† b·∫•m <b>PH√ÇN T√çCH</b>.</td></tr>';
    $("kpiRows").textContent="‚Äî"; $("kpiXQ").textContent="‚Äî"; $("kpiErrors").textContent="‚Äî"; $("kpiTypes").textContent="‚Äî"; $("kpiFile").textContent="File: ‚Äî";
    diag("");
  });

  ["q","typeFilter","sortBy","minMinutes","roundToMin","xqByService","xqByMachine"].forEach(id=>{
    $(id).addEventListener("input", ()=>{ if(errors.length) render(); });
    $(id).addEventListener("change", ()=>{ if(errors.length){ analyze(); updateKPIs(); fillTypeFilter(); render(); $("btnExport").disabled = errors.length===0; } });
  });

  $("btnCopySummary").addEventListener("click", async ()=>{
    const counts={}; for (const e of errors) counts[e.type]=(counts[e.type]||0)+1;
    const summary=[
      `File: ${fileName}`,
      `T·ªïng d√≤ng: ${allRows.length}`,
      `D√≤ng X‚Äëquang: ${xqRows.length}`,
      `T·ªïng l·ªói: ${errors.length}`,
      `Ph√¢n lo·∫°i: ` + Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([t,n])=>`${t}: ${n}`).join(", ")
    ].join("\n");
    try{ await navigator.clipboard.writeText(summary);
      $("btnCopySummary").textContent="‚úÖ ƒê√£ copy";
      setTimeout(()=>$("btnCopySummary").textContent="üìã Copy t√≥m t·∫Øt", 1200);
    }catch(e){ diag("Kh√¥ng copy ƒë∆∞·ª£c. T√≥m t·∫Øt:\n\n"+summary); }
  });
</script>
</body>
</html>
