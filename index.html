<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lọc lỗi thời gian X-quang (Excel → Web)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f6f8fc}
    .card{border-radius:16px}
    .table thead th{position:sticky;top:0;background:#ffffff;z-index:1}
    .nowrap{white-space:nowrap}
    .smallcode{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .kpi{font-size:1.9rem;font-weight:800}
    .muted{color:#6b7280}
    .badge-soft{background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff}
    .rowerr{background:rgba(255,193,7,.10)}
  </style>
</head>
<body>
<div class="container py-4">
  <div class="card shadow-sm p-4 mb-3">
    <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
      <div>
        <h1 class="h4 mb-1">Lọc lỗi thời gian cho <b>ca chụp X-quang</b></h1>
        <div class="muted">
          Upload file Excel (.xlsx) có dữ liệu như <span class="smallcode">Sheet1</span> → hệ thống tự <b>lọc ca X-quang</b> và báo <b>ca trùng</b>.
        </div>
      </div>
      <div class="d-flex gap-2">
        <span class="badge badge-soft">Chủ đề sáng</span>
        <span class="badge badge-soft">Chạy được trên GitHub Pages</span>
      </div>
    </div>

    <hr class="my-3">

    <div class="row g-3 align-items-end">
      <div class="col-lg-6">
        <label class="form-label">Chọn file Excel (.xlsx)</label>
        <input id="file" class="form-control" type="file" accept=".xlsx,.xls" />
        <div class="form-text">
          Ưu tiên sheet tên <b>Sheet1</b> (nếu không có sẽ dùng sheet đầu tiên).
        </div>
      </div>

      <div class="col-lg-6">
        <label class="form-label">Tiêu chí nhận diện ca X-quang</label>
        <div class="d-flex flex-wrap gap-2">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="xqByService" checked>
            <label class="form-check-label" for="xqByService">Dựa theo <b>Tên DVKT</b> chứa “x-quang / xq”</label>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="xqByMachine" checked>
            <label class="form-check-label" for="xqByMachine">Dựa theo <b>Mã máy</b> bắt đầu bằng “XQ”</label>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-6">
            <label class="form-label">Ngưỡng “thực hiện dưới” (phút)</label>
            <input id="minMinutes" type="number" class="form-control" value="6" min="1" step="1">
          </div>
          <div class="col-md-6">
            <label class="form-label">So khớp trùng theo (phút làm tròn)</label>
            <input id="roundToMin" type="number" class="form-control" value="1" min="1" step="1">
            <div class="form-text">1 = so theo phút; 5 = làm tròn 5 phút…</div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mt-3">
      <button id="btnRun" class="btn btn-primary" disabled>Phân tích</button>
      <button id="btnExport" class="btn btn-success" disabled>Xuất CSV lỗi</button>
      <button id="btnClear" class="btn btn-outline-secondary">Xoá kết quả</button>
    </div>

    <div class="mt-3 small text-muted">
      Lỗi sẽ được kiểm tra theo 3 quy tắc bạn cung cấp (trùng thời gian bắt đầu khác máy, trùng thời gian kết thúc, và thời gian thực hiện &lt; 6 phút).
    </div>
  </div>

  <div class="card shadow-sm p-4 mb-3">
    <div class="row g-3">
      <div class="col-md-3">
        <div class="muted">Tổng dòng đọc</div>
        <div id="kpiRows" class="kpi">—</div>
      </div>
      <div class="col-md-3">
        <div class="muted">Dòng X-quang</div>
        <div id="kpiXQ" class="kpi">—</div>
      </div>
      <div class="col-md-3">
        <div class="muted">Số lỗi</div>
        <div id="kpiErrors" class="kpi">—</div>
      </div>
      <div class="col-md-3">
        <div class="muted">Sheet đang dùng</div>
        <div id="kpiSheet" class="kpi">—</div>
      </div>
    </div>

    <hr class="my-3">

    <div class="row g-2 align-items-end">
      <div class="col-lg-5">
        <label class="form-label">Lọc nhanh</label>
        <input id="q" class="form-control" placeholder="VD: Trùng thời gian bắt đầu, XQ.2..., tên kỹ thuật viên, mã KCB..." />
      </div>
      <div class="col-lg-3">
        <label class="form-label">Chỉ hiển thị loại lỗi</label>
        <select id="typeFilter" class="form-select">
          <option value="">(Tất cả)</option>
        </select>
      </div>
      <div class="col-lg-2">
        <label class="form-label">Sắp xếp</label>
        <select id="sortBy" class="form-select">
          <option value="time">Thời gian</option>
          <option value="type">Loại lỗi</option>
          <option value="machine">Mã máy → Thời gian</option>
        </select>
      </div>
      <div class="col-lg-2 d-grid">
        <button id="btnCopySummary" class="btn btn-outline-primary">Copy tóm tắt</button>
      </div>
    </div>

    <div class="table-responsive mt-3" style="max-height:60vh">
      <table class="table table-sm table-hover align-middle">
        <thead>
          <tr>
            <th class="nowrap">#</th>
            <th class="nowrap">Loại lỗi</th>
            <th>Mô tả</th>
            <th class="nowrap">Mã máy</th>
            <th class="nowrap">Người TH</th>
            <th class="nowrap">Bác sĩ</th>
            <th class="nowrap">Mã KCB</th>
            <th>DVKT</th>
            <th class="nowrap">BĐ (Ngày thực hiện YL)</th>
            <th class="nowrap">KT (Ngày kết quả)</th>
            <th class="nowrap">Phút</th>
            <th class="nowrap">Dòng liên quan</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="12" class="text-muted">Chưa có dữ liệu. Hãy tải file và bấm <b>Phân tích</b>.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script>
  const $ = (id) => document.getElementById(id);

  function excelNumberToDate(n) {
    const epoch = Date.UTC(1899, 11, 30);
    const ms = Math.round(n * 86400000);
    return new Date(epoch + ms);
  }

  function toDate(val) {
    if (val == null || val === "") return null;
    if (val instanceof Date && !isNaN(val)) return val;
    if (typeof val === "number" && isFinite(val)) return excelNumberToDate(val);
    if (typeof val === "string") {
      const s = val.trim().replace(/\s+/g, " ");
      const iso = new Date(s);
      if (!isNaN(iso)) return iso;

      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);
      if (m) {
        let d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10);
        if (y < 100) y += 2000;
        let hh = m[4] ? parseInt(m[4],10) : 0;
        const mm = m[5] ? parseInt(m[5],10) : 0;
        const ss = m[6] ? parseInt(m[6],10) : 0;
        const ap = m[7] ? m[7].toUpperCase() : null;
        if (ap === "PM" && hh < 12) hh += 12;
        if (ap === "AM" && hh === 12) hh = 0;
        const dt = new Date(y, mo, d, hh, mm, ss);
        if (!isNaN(dt)) return dt;
      }
    }
    return null;
  }

  function fmt(dt) {
    if (!dt) return "";
    try {
      const f = new Intl.DateTimeFormat("vi-VN", {
        timeZone: "Asia/Ho_Chi_Minh",
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });
      return f.format(dt);
    } catch (e) { return dt.toLocaleString(); }
  }

  function safe(v) { return (v==null) ? "" : String(v); }
  function minutesBetween(a,b) { return Math.round((b.getTime()-a.getTime())/60000); }

  function pickSheet(workbook) {
    const preferred = ["Sheet1","sheet1","DATA","data"];
    for (const name of preferred) if (workbook.SheetNames.includes(name)) return name;
    return workbook.SheetNames[0];
  }

  function readRows(ws) {
    const aoa = XLSX.utils.sheet_to_json(ws, {header: 1, raw: true, defval: null});
    let headerRowIdx = -1;
    for (let r=0;r<Math.min(80, aoa.length);r++) {
      const joined = (aoa[r]||[]).map(x => safe(x)).join(" | ");
      if (joined.includes("Ngày thực hiện") && joined.includes("Ngày kết quả")) { headerRowIdx = r; break; }
    }
    if (headerRowIdx === -1) headerRowIdx = 0;

    const headers = (aoa[headerRowIdx]||[]).map(h => safe(h).trim());
    const rows = [];
    for (let r=headerRowIdx+1; r<aoa.length; r++) {
      const row = aoa[r] || [];
      const nonEmpty = row.some(v => v!=null && safe(v).trim()!=="");
      if (!nonEmpty) continue;
      const obj = {};
      for (let c=0;c<headers.length;c++) {
        const key = headers[c] || `C${c+1}`;
        obj[key] = row[c];
      }
      obj.__rownum = r+1;
      rows.push(obj);
    }
    return rows;
  }

  function normalizeRow(obj) {
    return {
      rownum: obj.__rownum,
      ten: obj["Tên DVKT"] ?? obj["Ten DVKT"] ?? obj["Tên DVKT "] ?? "",
      maMay: obj["Mã máy"] ?? obj["Ma may"] ?? "",
      nguoiTH: obj["Người thực hiện"] ?? obj["Nguoi thuc hien"] ?? "",
      bacSi: obj["Bác sĩ"] ?? obj["Bac si"] ?? "",
      maKCB: obj["Mã KCB"] ?? obj["Ma KCB"] ?? "",
      start: toDate(obj["Ngày thực hiện YL"] ?? obj["Ngày thực hiện"] ?? obj["Ngày thực hiện YL "] ?? null),
      end: toDate(obj["Ngày kết quả"] ?? obj["Ngày kết quả "] ?? null),
      raw: obj
    };
  }

  // Round date to N minutes bucket for duplicate checks
  function bucketTime(dt, roundToMin) {
    if (!dt) return "";
    const ms = dt.getTime();
    const bucket = roundToMin * 60000;
    const rounded = Math.floor(ms / bucket) * bucket;
    return String(rounded);
  }

  function isXQ(row, byService, byMachine) {
    const ten = safe(row.ten).toLowerCase();
    const ma = safe(row.maMay).trim().toUpperCase();

    const okService = byService ? (ten.includes("x-quang") || ten.includes("x quang") || ten.includes("xq") || ten.includes("x-ray") || ten.includes("xray")) : false;
    const okMachine = byMachine ? (ma.startsWith("XQ")) : false;

    // If both toggles ON: accept if either matches
    if (byService && byMachine) return okService || okMachine;
    if (byService) return okService;
    if (byMachine) return okMachine;

    // If both OFF, default to include all (avoid "no data" confusion)
    return true;
  }

  function mkErr(type, row, desc, relatedRows=[]) {
    const dur = (row.start && row.end) ? minutesBetween(row.start, row.end) : null;
    const related = relatedRows.length ? relatedRows.map(r=>r.rownum).join(", ") : "";
    return {
      type, desc,
      rownum: row.rownum,
      maMay: row.maMay,
      nguoiTH: row.nguoiTH,
      bacSi: row.bacSi,
      maKCB: row.maKCB,
      ten: row.ten,
      start: row.start,
      end: row.end,
      duration: dur,
      related
    };
  }

  function analyzeXQ(rows, opts) {
    const errors = [];
    const roundToMin = Math.max(1, opts.roundToMin);

    // 3) Thời gian thực hiện dưới 6 phút (BĐ -> KT < 6 phút)
    const minM = Math.max(1, opts.minMinutes);
    for (const r of rows) {
      if (r.start && r.end) {
        const dur = minutesBetween(r.start, r.end);
        if (dur >= 0 && dur < minM) {
          errors.push(mkErr("Thực hiện dưới 6 phút", r, `Thời gian thực hiện ${dur} phút < ${minM} phút`, []));
        }
      }
    }

    // 1) Trùng thời gian bắt đầu: >=2 ca cùng start nhưng khác Mã máy
    const mapStart = new Map(); // bucket -> array
    for (const r of rows) {
      if (!r.start) continue;
      const key = bucketTime(r.start, roundToMin);
      if (!mapStart.has(key)) mapStart.set(key, []);
      mapStart.get(key).push(r);
    }
    for (const [key, arr] of mapStart.entries()) {
      if (arr.length < 2) continue;
      const machines = new Set(arr.map(x => safe(x.maMay).trim()).filter(Boolean));
      if (machines.size >= 2) {
        // For each row, list other machines/rows
        for (const r of arr) {
          const others = arr.filter(x => x !== r);
          const otherMachines = Array.from(new Set(others.map(x=>safe(x.maMay).trim()).filter(Boolean))).join(", ");
          const desc = `Cùng BĐ (${fmt(r.start)}) nhưng khác máy. Máy khác: ${otherMachines || "(không rõ)"}`;
          errors.push(mkErr("Trùng thời gian bắt đầu", r, desc, others));
        }
      }
    }

    // 2) Trùng thời gian kết thúc: >=2 ca trùng end (Ngày kết quả)
    const mapEnd = new Map();
    for (const r of rows) {
      if (!r.end) continue;
      const key = bucketTime(r.end, roundToMin);
      if (!mapEnd.has(key)) mapEnd.set(key, []);
      mapEnd.get(key).push(r);
    }
    for (const [key, arr] of mapEnd.entries()) {
      if (arr.length < 2) continue;
      for (const r of arr) {
        const others = arr.filter(x => x !== r);
        const desc = `Trùng KT (${fmt(r.end)}) với ${others.length} ca khác`;
        errors.push(mkErr("Trùng thời gian kết thúc", r, desc, others));
      }
    }

    // Deduplicate exact same error records (e.g. a row may be added twice if multiple rules hit)
    // Keep them all (useful), but avoid duplicate identical ones:
    const seen = new Set();
    const out = [];
    for (const e of errors) {
      const sig = [e.type, e.rownum, bucketTime(e.start, roundToMin), bucketTime(e.end, roundToMin), e.related].join("|");
      if (seen.has(sig)) continue;
      seen.add(sig);
      out.push(e);
    }
    return out;
  }

  function setKPIs(rowsCount, xqCount, errors, sheetName) {
    $("kpiRows").textContent = rowsCount ?? "—";
    $("kpiXQ").textContent = xqCount ?? "—";
    $("kpiErrors").textContent = errors ? errors.length : "—";
    $("kpiSheet").textContent = sheetName ?? "—";
  }

  function fillTypeFilter(errors) {
    const sel = $("typeFilter");
    const cur = sel.value;
    const types = Array.from(new Set(errors.map(e=>e.type))).sort();
    sel.innerHTML = `<option value="">(Tất cả)</option>` + types.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
    sel.value = cur;
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  }

  function render(errors) {
    const q = $("q").value.trim().toLowerCase();
    const typeF = $("typeFilter").value;
    const sortBy = $("sortBy").value;

    let items = errors.slice();
    if (typeF) items = items.filter(e=>e.type===typeF);
    if (q) {
      items = items.filter(e => {
        const blob = [
          e.type, e.desc, e.maMay, e.nguoiTH, e.bacSi, e.maKCB, e.ten, fmt(e.start), fmt(e.end), e.rownum, e.related
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    if (sortBy === "type") {
      items.sort((a,b)=>a.type.localeCompare(b.type) || (a.start?.getTime()||0)-(b.start?.getTime()||0));
    } else if (sortBy === "machine") {
      items.sort((a,b)=>safe(a.maMay).localeCompare(safe(b.maMay)) || (a.start?.getTime()||0)-(b.start?.getTime()||0));
    } else {
      items.sort((a,b)=>(a.start?.getTime()||0)-(b.start?.getTime()||0));
    }

    const tb = $("tbody");
    if (!items.length) {
      tb.innerHTML = `<tr><td colspan="12" class="text-muted">Không có lỗi theo bộ lọc hiện tại.</td></tr>`;
      return;
    }

    tb.innerHTML = items.map((e, idx) => `
      <tr class="rowerr">
        <td class="nowrap">${idx+1}</td>
        <td class="nowrap"><span class="badge text-bg-warning">${escapeHtml(e.type)}</span></td>
        <td>${escapeHtml(e.desc)}</td>
        <td class="nowrap">${escapeHtml(safe(e.maMay))}</td>
        <td class="nowrap">${escapeHtml(safe(e.nguoiTH))}</td>
        <td class="nowrap">${escapeHtml(safe(e.bacSi))}</td>
        <td class="nowrap">${escapeHtml(safe(e.maKCB))}</td>
        <td>${escapeHtml(safe(e.ten))}</td>
        <td class="nowrap">${escapeHtml(fmt(e.start))}</td>
        <td class="nowrap">${escapeHtml(fmt(e.end))}</td>
        <td class="nowrap">${e.duration==null ? "" : e.duration}</td>
        <td class="nowrap">${e.related ? `Liên quan dòng: ${escapeHtml(e.related)}` : ""}</td>
      </tr>
    `).join("");
  }

  function exportCSV(errors) {
    const headers = ["LoaiLoi","MoTa","MaMay","NguoiTH","BacSi","MaKCB","TenDVKT","BatDau","KetThuc","Phut","Dong","DongLienQuan"];
    const rows = errors.map(e => [
      e.type, e.desc, e.maMay, e.nguoiTH, e.bacSi, e.maKCB, e.ten, fmt(e.start), fmt(e.end),
      e.duration ?? "", e.rownum ?? "", e.related ?? ""
    ].map(v => `"${String(v??"").replace(/"/g,'""')}"`).join(","));
    const csv = headers.join(",") + "\n" + rows.join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `loi_xquang_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  let workbook = null;
  let allRows = [];
  let xqRows = [];
  let analyzedErrors = [];

  $("file").addEventListener("change", async (ev) => {
    const f = ev.target.files?.[0];
    if (!f) return;
    const buf = await f.arrayBuffer();
    workbook = XLSX.read(buf, {type:"array", cellDates:true, raw:true});
    $("btnRun").disabled = false;
    $("kpiSheet").textContent = pickSheet(workbook);
  });

  function run() {
    if (!workbook) return;
    const sheetName = pickSheet(workbook);
    const ws = workbook.Sheets[sheetName];

    const rawRows = readRows(ws);
    allRows = rawRows.map(normalizeRow);

    const byService = $("xqByService").checked;
    const byMachine = $("xqByMachine").checked;

    xqRows = allRows.filter(r => isXQ(r, byService, byMachine));

    const opts = {
      minMinutes: parseInt($("minMinutes").value || "6", 10),
      roundToMin: parseInt($("roundToMin").value || "1", 10),
    };

    analyzedErrors = analyzeXQ(xqRows, opts);

    setKPIs(allRows.length, xqRows.length, analyzedErrors, sheetName);
    fillTypeFilter(analyzedErrors);
    $("btnExport").disabled = analyzedErrors.length === 0;
    render(analyzedErrors);
  }

  $("btnRun").addEventListener("click", run);

  ["xqByService","xqByMachine","minMinutes","roundToMin"].forEach(id => {
    $(id).addEventListener("change", ()=>{ if(workbook) run(); });
    $(id).addEventListener("input", ()=>{ if(workbook) run(); });
  });

  $("btnExport").addEventListener("click", () => {
    if (!analyzedErrors.length) return;
    exportCSV(analyzedErrors);
  });

  $("btnClear").addEventListener("click", () => {
    allRows = [];
    xqRows = [];
    analyzedErrors = [];
    $("tbody").innerHTML = `<tr><td colspan="12" class="text-muted">Chưa có dữ liệu. Hãy tải file và bấm <b>Phân tích</b>.</td></tr>`;
    $("typeFilter").innerHTML = `<option value="">(Tất cả)</option>`;
    $("q").value = "";
    setKPIs(null, null, null, "—");
    $("btnExport").disabled = true;
  });

  ["q","typeFilter","sortBy"].forEach(id => {
    $(id).addEventListener("input", ()=>render(analyzedErrors));
    $(id).addEventListener("change", ()=>render(analyzedErrors));
  });

  $("btnCopySummary").addEventListener("click", async () => {
    const types = {};
    for (const e of analyzedErrors) types[e.type] = (types[e.type]||0)+1;
    const summary = [
      `Tổng dòng: ${allRows.length}`,
      `Dòng X-quang: ${xqRows.length}`,
      `Tổng lỗi: ${analyzedErrors.length}`,
      `Phân loại: ` + Object.entries(types).sort((a,b)=>b[1]-a[1]).map(([t,n])=>`${t}: ${n}`).join(", ")
    ].join("\n");
    try {
      await navigator.clipboard.writeText(summary);
      $("btnCopySummary").textContent = "Đã copy ✔";
      setTimeout(()=>$("btnCopySummary").textContent="Copy tóm tắt", 1200);
    } catch(e) {
      alert(summary);
    }
  });
</script>
</body>
</html>
