<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>L·ªçc l·ªói th·ªùi gian X-quang (Excel/CSV ‚Üí Web)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --accent: #5eead4;
      --accent2:#60a5fa;
      --warn: #fbbf24;
      --danger: #fb7185;
      --ok: #34d399;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }
    body{
      min-height: 100vh;
      color: var(--text);
      background:
        radial-gradient(1200px 500px at 10% 10%, rgba(96,165,250,.25), transparent 60%),
        radial-gradient(900px 450px at 90% 20%, rgba(94,234,212,.18), transparent 55%),
        radial-gradient(900px 450px at 30% 90%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, #050812 0%, #0b1220 45%, #0b1220 100%);
    }
    .app-shell{max-width:1280px;margin:0 auto;padding:28px 16px 40px;}
    .topbar{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;user-select:none;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(94,234,212,.85), rgba(96,165,250,.55)),
                  linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.02));
      box-shadow: 0 10px 28px rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.18);
      position:relative;overflow:hidden;
    }
    .logo:after{content:"";position:absolute;inset:-30%;background:radial-gradient(circle at 40% 30%, rgba(255,255,255,.25), transparent 55%);transform:rotate(20deg);}
    .brand h1{margin:0;font-size:1.15rem;font-weight:850;letter-spacing:.2px;line-height:1.1;}
    .brand .sub{margin:0;color:var(--muted);font-size:.88rem;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
      border:1px solid var(--stroke);background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.82);backdrop-filter:blur(10px);
      box-shadow:0 10px 26px rgba(0,0,0,.22);font-size:.86rem;white-space:nowrap;
    }
    .chip b{color:#fff;font-weight:800;}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px;}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
    .glass{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(12px);
    }
    .cardx{padding:18px;}
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;flex-wrap:wrap;}
    .section-title h2{font-size:1.02rem;font-weight:850;margin:0;letter-spacing:.2px;}
    .section-title .hint{color:var(--muted);font-size:.86rem;margin:0;}
    .divider{height:1px;background:linear-gradient(90deg, transparent, rgba(255,255,255,.15), transparent);margin:14px 0;}
    .form-label{color:rgba(255,255,255,.85);font-weight:700;font-size:.88rem;margin-bottom:6px;}
    .form-text{color:rgba(255,255,255,.55)!important;}
    .form-control,.form-select{
      background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.16);
      color:rgba(255,255,255,.92);border-radius:14px;padding:10px 12px;
    }
    .form-control:focus,.form-select:focus{
      background:rgba(0,0,0,.30);border-color:rgba(94,234,212,.55);
      box-shadow:0 0 0 .25rem rgba(94,234,212,.15);color:rgba(255,255,255,.95);
    }
    .form-select option{color:#111;}
    .switchline{display:flex;flex-wrap:wrap;gap:14px;padding:10px 12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);border-radius:14px;}
    .form-check-input{cursor:pointer;background-color:rgba(255,255,255,.15);border-color:rgba(255,255,255,.25);}
    .form-check-input:checked{background-color:rgba(94,234,212,.9);border-color:rgba(94,234,212,.9);}
    .form-check-label{cursor:pointer;color:rgba(255,255,255,.82);font-weight:650;font-size:.88rem;}

    .btn{border-radius:14px;font-weight:800;letter-spacing:.2px;padding:10px 14px;border:1px solid rgba(255,255,255,.14);}
    .btn-primary{background:linear-gradient(135deg, rgba(94,234,212,.95), rgba(96,165,250,.90));border:0;color:#07111c;box-shadow:0 14px 40px rgba(96,165,250,.18);}
    .btn-primary:hover{filter:brightness(1.02);transform:translateY(-1px);}
    .btn:disabled{opacity:.55!important;cursor:not-allowed;transform:none!important;}
    .btn-outline-light{color:rgba(255,255,255,.92);border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.04);}
    .btn-outline-light:hover{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.22);}
    .btn-success{background:linear-gradient(135deg, rgba(52,211,153,.95), rgba(94,234,212,.75));border:0;color:#07111c;}
    .btn-outline-warning{color:rgba(255,255,255,.92);border-color:rgba(251,191,36,.40);background:rgba(251,191,36,.08);}
    .btn-outline-warning:hover{background:rgba(251,191,36,.13);border-color:rgba(251,191,36,.55);}

    .kpi-wrap{display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;}
    @media(max-width:900px){.kpi-wrap{grid-template-columns:repeat(2,1fr);}}
    .kpi-box{padding:14px 14px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);}
    .kpi-box .lab{color:var(--muted);font-size:.82rem;font-weight:700;margin-bottom:6px;}
    .kpi-box .val{font-size:1.8rem;font-weight:900;line-height:1;letter-spacing:.2px;}
    .kpi-box .tag{margin-top:8px;display:inline-flex;gap:8px;align-items:center;font-size:.82rem;color:rgba(255,255,255,.72);}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.25);display:inline-block;}
    .dot.ok{background:var(--ok);} .dot.warn{background:var(--warn);} .dot.danger{background:var(--danger);}

    .alertx{border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);padding:12px 14px;color:rgba(255,255,255,.86);white-space:pre-wrap;}
    .alertx.warning{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.08);}
    .alertx.danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10);}

    .table-wrap{border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);overflow:hidden;}
    .table{margin:0;color:rgba(255,255,255,.88);}
    .table thead th{
      position:sticky;top:0;z-index:2;background:rgba(10,18,32,.92);
      border-bottom:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.85);font-size:.82rem;white-space:nowrap;
    }
    .table td{border-top:1px solid rgba(255,255,255,.08);vertical-align:middle;font-size:.88rem;}
    .rowerr{background:rgba(251,191,36,.06);}
    
    /* T√¥ m√†u theo M√£ KCB (c√πng m√£ => c√πng m√†u) */
    tr.err-row.kcbTint{
      background: var(--kcbBg) !important;
      border-left: 6px solid var(--kcbBorder) !important;
    }
.badge-soft{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);font-weight:900;font-size:.78rem;white-space:nowrap;
    }
    .badge-soft.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.09);}
    .badge-soft.danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10);}
    .badge-soft.ok{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.10);}

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.86rem;}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;}
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .small-muted{color:var(--muted);font-size:.85rem;}
    .pulse{animation:pulse .35s ease-out;}
    @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.015);}100%{transform:scale(1);}}
    .table-responsive{max-height:58vh;}
    .table-responsive::-webkit-scrollbar{height:10px;width:10px;}
    .table-responsive::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14);border-radius:999px;}
    .table-responsive::-webkit-scrollbar-track{background:rgba(255,255,255,.04);}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      padding:8px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .tabbtn{
      padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18); color: rgba(255,255,255,.85);
      font-weight:900; font-size:.86rem; cursor:pointer;
      user-select:none;
    }
    .tabbtn.active{
      background: linear-gradient(135deg, rgba(94,234,212,.30), rgba(96,165,250,.22));
      border-color: rgba(94,234,212,.35);
      color:#fff;
    }
    .hidden{display:none!important;}

    .accordion-item{
      border-radius: 16px!important;
      border:1px solid rgba(255,255,255,.12)!important;
      background: rgba(0,0,0,.18)!important;
      overflow:hidden;
    }
    .accordion-button{
      background: rgba(255,255,255,.04)!important;
      color: rgba(255,255,255,.90)!important;
      font-weight: 900;
    }
    .accordion-button:not(.collapsed){
      background: linear-gradient(135deg, rgba(94,234,212,.16), rgba(96,165,250,.12))!important;
      color:#fff!important;
      box-shadow:none!important;
    }
    .accordion-body{color:rgba(255,255,255,.85);}
    .accordion-button:focus{box-shadow:0 0 0 .25rem rgba(94,234,212,.12)!important;}

    /* PRINT / PDF */
    @media print{
      body{background:#fff;color:#111;}
      .glass{box-shadow:none!important;border:1px solid #ddd!important;background:#fff!important;}
      .chip, .tabs, .btn, .form-control, .form-select, #diagBox, #xlsxBadge, #file, #btnCheckXlsx, #btnClear, #q, #typeFilter, #sortBy {display:none!important;}
      .topbar{margin-bottom:10px;}
      .brand .sub{color:#444!important;}
      .table thead th{position:static!important;background:#f4f6f8!important;color:#111!important;border-bottom:1px solid #ddd!important;}
      .table td{color:#111!important;border-top:1px solid #eee!important;}
      .rowerr{background:#fff7e6!important;}
      .small-muted{color:#444!important;}
      .table-responsive{max-height:none!important;}
      a[href]:after{content:"";}
    }
  
    /* Contrast fixes */
    .text-muted{color:rgba(255,255,255,.72)!important;}
    .small-muted{color:rgba(255,255,255,.74)!important;}
    .section-title .hint{color:rgba(255,255,255,.74)!important;}
    .form-text{color:rgba(255,255,255,.70)!important;}
    .chip{color:rgba(255,255,255,.90)!important;}
    .chip b{color:#fff!important;}
    ::placeholder{color:rgba(255,255,255,.60)!important;opacity:1;}
    input::-webkit-input-placeholder{color:rgba(255,255,255,.60)!important;}
    textarea::-webkit-input-placeholder{color:rgba(255,255,255,.60)!important;}
    /* Ensure dropdown selected text visible */
    .form-select{color:rgba(255,255,255,.95)!important;}
    /* Table empty-state text */
    .table td, .table th{color:rgba(255,255,255,.92);}
    /* Buttons outline text */
    .btn-outline-light, .btn-outline-warning{color:rgba(255,255,255,.92)!important;}
    /* Links (if any) */
    a{color:rgba(96,165,250,.95);}

  
/* ===== Hospital Light Theme ===== */
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --primary:#2563eb;     /* blue */
  --accent:#16a34a;      /* green */
  --border:#dbeafe;      /* light blue border */
  --text:#0f172a;
  --muted:#475569;
}

body{
  background:var(--bg)!important;
  color:var(--text)!important;
}

.card{
  background:var(--card)!important;
  border:1px solid var(--border)!important;
  box-shadow:0 4px 12px rgba(15,23,42,.06)!important;
}

h1,h2,h3,h4,h5{
  color:#0f172a!important;
  font-weight:700;
}

.text-muted,.muted{
  color:var(--muted)!important;
}

.badge-soft{
  background:#eff6ff!important;
  color:#1e3a8a!important;
  border:1px solid #bfdbfe!important;
}

.btn-primary{
  background:var(--primary)!important;
  border-color:var(--primary)!important;
}
.btn-primary:hover{filter:brightness(.95)}

.btn-success{
  background:var(--accent)!important;
  border-color:var(--accent)!important;
}

.form-control,.form-select{
  background:#ffffff!important;
  color:#0f172a!important;
  border:1px solid #c7d2fe!important;
}
.form-control:focus,.form-select:focus{
  border-color:var(--primary)!important;
  box-shadow:0 0 0 .2rem rgba(37,99,235,.15)!important;
}

::placeholder{
  color:#94a3b8!important;
}

.table thead th{
  background:#f1f5f9!important;
  color:#0f172a!important;
  border-bottom:2px solid #c7d2fe!important;
}

.table tbody tr.rowerr{
  background:#fff7ed!important; /* nh·∫π c·∫£nh b√°o */
}

.badge.text-bg-warning{
  background:#f59e0b!important;
  color:#fff!important;
}

.kpi{
  color:#1e293b!important;
}

.alert-warning{
  background:#fffbeb!important;
  color:#92400e!important;
  border:1px solid #fde68a!important;
}
.alert-danger{
  background:#fef2f2!important;
  color:#991b1b!important;
  border:1px solid #fecaca!important;
}
/* ===== End Hospital Light Theme ===== */


/* ===== VISIBILITY HOTFIX (Hospital Light) ===== */
body, .container, .card {
  color:#0f172a !important;
}

label, .form-label, .section-title, .card-title {
  color:#0f172a !important;
  font-weight:600;
}

.form-text, .muted, .text-muted {
  color:#334155 !important; /* slate-700 */
}

input, select, textarea, .form-control, .form-select {
  color:#0f172a !important;
  background:#ffffff !important;
}

::placeholder {
  color:#64748b !important; /* slate-500 */
  opacity:1;
}

.form-check-label {
  color:#0f172a !important;
}

.kpi, .kpi-value {
  color:#0f172a !important;
  font-weight:700;
}

.table th {
  color:#0f172a !important;
  font-weight:700;
}
.table td {
  color:#020617 !important;
}

.badge, .chip {
  color:#020617 !important;
}

.btn {
  font-weight:600;
}
.btn-primary {
  color:#ffffff !important;
}
.btn-success {
  color:#ffffff !important;
}
.btn-outline-primary,
.btn-outline-secondary {
  color:#1e3a8a !important;
  border-color:#93c5fd !important;
}

/* KPI dashes visibility */
.kpi::before, .kpi::after {
  color:#020617 !important;
}
/* ===== END HOTFIX ===== */

/* ===== Light Contrast Boost (BV) ===== */
.btn-outline-light{
  color:#0f172a !important;
  background:#ffffff !important;
  border-color:#c7d2fe !important;
}
.btn-outline-light:hover{
  background:#f1f5ff !important;
  border-color:#93c5fd !important;
}
.btn-outline-warning{
  color:#92400e !important;
  background:#fffbeb !important;
  border-color:#fcd34d !important;
}
.btn-outline-warning:hover{
  background:#fef3c7 !important;
  border-color:#f59e0b !important;
}
.tabs{
  background:#f1f5f9 !important;
  border-color:#c7d2fe !important;
}
.tabbtn{
  background:#ffffff !important;
  color:#0f172a !important;
  border-color:#c7d2fe !important;
}
.tabbtn.active{
  background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(22,163,74,.12)) !important;
  border-color: rgba(37,99,235,.35) !important;
  color:#0f172a !important;
}
.chip{
  background:#ffffff !important;
  border-color:#c7d2fe !important;
  color:#0f172a !important;
  box-shadow:0 6px 18px rgba(15,23,42,.08) !important;
}
.table td.placeholder-light{
  color:#334155 !important;
}
/* Force all muted to darker */
.small-muted, .form-text, .text-muted, .section-title .hint{
  color:#334155 !important;
}
/* ===== End Light Contrast Boost ===== */


/* ===== CLEAR TOGGLE SWITCH (Hospital UI) ===== */
.form-check.form-switch{
  padding-left: 3.2rem;
}

.form-check-input{
  width: 3.2rem;
  height: 1.7rem;
  background-color:#e5e7eb; /* x√°m nh·∫°t khi OFF */
  border:2px solid #94a3b8;
  cursor:pointer;
}

.form-check-input:checked{
  background-color:#16a34a; /* xanh khi ON */
  border-color:#15803d;
}

.form-check-input:focus{
  box-shadow:0 0 0 .2rem rgba(22,163,74,.25);
}

.form-check-input::before{
  content:"";
  position:absolute;
  width:1.3rem;
  height:1.3rem;
  border-radius:50%;
  background:#ffffff;
  top:0.15rem;
  left:0.2rem;
  transition:transform .2s ease;
}

.form-check-input:checked::before{
  transform:translateX(1.4rem);
}

.form-check-label{
  font-weight:600;
  color:#0f172a !important;
  cursor:pointer;
}

.form-check-input:not(:checked) + .form-check-label{
  color:#475569 !important;
}
/* ===== END TOGGLE ===== */


/* ===== BV RADIO-CHECKBOX (centered + pulse 0.2s) ===== */
.bv-check{
  display:flex;
  align-items:center;
  gap:10px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid #c7d2fe;
  background:#f8fafc;
  cursor:pointer;
  user-select:none;
}
.bv-check input{
  position:absolute;
  opacity:0;
  pointer-events:none;
}
.bv-mark{
  width:22px;
  height:22px;
  border-radius:50%;
  border:2px solid #16a34a;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  flex:0 0 22px;
}
.bv-mark::after{
  content:"";
  width:10px;
  height:10px;
  border-radius:50%;
  background:#16a34a;
  transform:scale(0);
  transition:transform .15s ease;
}
.bv-check input:checked + .bv-mark::after{
  transform:scale(1);
}
.bv-label-text{
  color:#0f172a;
  font-weight:600;
}

/* pulse 0.2s */
@keyframes bvPulse{
  0%{transform:scale(1);box-shadow:0 0 0 0 rgba(22,163,74,0);}
  50%{transform:scale(1.08);box-shadow:0 0 0 6px rgba(22,163,74,.25);}
  100%{transform:scale(1);box-shadow:0 0 0 0 rgba(22,163,74,0);}
}
.bv-mark.pulse{animation:bvPulse .2s ease-out;}
/* ===== END BV RADIO-CHECKBOX ===== */



/* ===== Fix Suggestion Modal (offline, no bootstrap js) ===== */
.bv-modal-backdrop{
  position:fixed; inset:0;
  background:rgba(2,6,23,.45);
  display:none;
  z-index: 9998;
}
.bv-modal{
  position:fixed;
  inset: 0;
  display:none;
  z-index: 9999;
  padding: 18px;
}
.bv-modal .bv-modal-dialog{
  max-width: 820px;
  margin: 6vh auto;
  background: #ffffff;
  border-radius: 18px;
  border: 1px solid #c7d2fe;
  box-shadow: 0 30px 80px rgba(2,6,23,.25);
  overflow:hidden;
}
.bv-modal .bv-modal-header{
  padding: 14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  background: #f1f5f9;
  border-bottom: 1px solid #e2e8f0;
}
.bv-modal .bv-modal-title{
  margin:0;
  font-size: 1rem;
  font-weight: 900;
  color:#0f172a;
}
.bv-modal .bv-modal-body{
  padding: 14px 16px 6px;
  color:#0f172a;
}
.bv-modal .bv-modal-footer{
  padding: 12px 16px 14px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
  border-top: 1px solid #e2e8f0;
  background: #ffffff;
}
.bv-modal .kv{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px 12px;
}
@media(max-width:760px){
  .bv-modal .kv{ grid-template-columns: 1fr; }
}
.kv .box{
  border: 1px solid #e2e8f0;
  border-radius: 14px;
  padding: 10px 12px;
  background: #ffffff;
}
.kv .lab{
  font-size:.82rem;
  color:#475569;
  font-weight:800;
  margin-bottom:6px;
}
.kv .val{
  font-weight:900;
  color:#0f172a;
}
.kv .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
.bv-modal .note{
  margin-top:10px;
  padding:10px 12px;
  border-radius: 14px;
  border:1px solid #fde68a;
  background:#fffbeb;
  color:#92400e;
  font-size:.9rem;
  white-space:pre-wrap;
}
/* ===== End modal ===== */

/* ===== Modal layout fix: footer lu√¥n nh√¨n th·∫•y ===== */
.bv-modal{
  display:none;
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  width:min(980px, calc(100vw - 24px));
  max-height:calc(100vh - 24px);
  overflow:hidden;
  border-radius:18px;
}
.bv-modal .bv-modal-card{
  display:flex;
  flex-direction:column;
  height:100%;
  max-height:calc(100vh - 24px);
}
.bv-modal .bv-modal-body{
  flex:1 1 auto;
  overflow:auto;
  padding-bottom:84px; /* ch·ª´a ch·ªó cho footer */
}
.bv-modal .bv-modal-footer{
  flex:0 0 auto;
  position:sticky;
  bottom:0;
  background:rgba(255,255,255,.92);
  backdrop-filter: blur(10px);
  border-top:1px solid rgba(148,163,184,.35);
  padding:10px 12px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  z-index:3;
}
@media (max-width: 720px){
  .bv-modal .bv-modal-footer{ flex-wrap:wrap; justify-content:center; }
  .bv-modal .bv-modal-body{ padding-bottom:110px; }
}

/* ===== BV FOOTER STANDARD (Hospital) ===== */
.bv-footer{
  display:flex;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
  justify-content:space-between;
}
.bv-footer-status{
  flex:1 1 240px;
  text-align:center;
  font-size:.9rem;
  font-weight:700;
  color:#475569;
  background:#f8fafc;
  border:1px dashed #cbd5e1;
  border-radius:999px;
  padding:6px 12px;
}
.bv-footer-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
.bv-footer-actions .btn{font-weight:800;}
@media (max-width: 720px){
  .bv-footer-status{order:-1; flex:1 1 100%;}
  .bv-footer-actions{justify-content:center;}
}
/* ===== END BV FOOTER STANDARD ===== */


/* ===== FINAL MODAL OVERRIDE (BV) - always above fixed bottom bars ===== */
.bv-modal-backdrop{
  z-index: 20000 !important;
}
.bv-modal{
  z-index: 20001 !important;
  inset: 0 !important;
  left: 0 !important;
  top: 0 !important;
  transform: none !important;
  width: 100vw !important;
  height: 100vh !important;
  padding: 12px !important;
  display: none;
  align-items: center !important;
  justify-content: center !important;
  overflow: hidden !important;
}
.bv-modal.show{ display:flex !important; }

.bv-modal .bv-modal-dialog,
.bv-modal .bv-modal-card{
  width: min(980px, calc(100vw - 24px)) !important;
  max-height: calc(100vh - 24px) !important;
  margin: 0 !important;
  border-radius: 18px !important;
  overflow: hidden !important;
  background: #ffffff !important;
  border: 1px solid #c7d2fe !important;
  box-shadow: 0 30px 80px rgba(2,6,23,.25) !important;
  display:flex !important;
  flex-direction:column !important;
}

.bv-modal .bv-modal-body{
  flex: 1 1 auto !important;
  overflow: auto !important;
  padding-bottom: 130px !important; /* ch·ª´a ch·ªó cho footer + m√†n h√¨nh nh·ªè */
}

.bv-modal .bv-modal-footer{
  flex: 0 0 auto !important;
  position: sticky !important;
  bottom: 0 !important;
  background: rgba(255,255,255,.98) !important;
  border-top: 1px solid rgba(148,163,184,.45) !important;
  backdrop-filter: blur(10px) !important;
  z-index: 5 !important;
}
/* Mobile: footer wrap + status full width */
@media (max-width: 768px){
  .bv-modal .bv-modal-footer{ flex-wrap: wrap !important; justify-content:center !important; }
  .bv-modal .bv-footer-status{ width:100% !important; text-align:center !important; order:-1 !important; }
  .bv-modal .bv-modal-body{ padding-bottom: 170px !important; }
}
/* ===== END FINAL MODAL OVERRIDE ===== */



/* ===== BV: Expand error table to show more rows (full-height right panel) ===== */
html, body { height: 100%; }
.app-shell{
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
.grid{
  flex: 1 1 auto;
  min-height: 0; /* allow children to shrink and scroll */
}

/* Right panel becomes a column layout, table fills remaining height */
.right-panel{
  display: flex;
  flex-direction: column;
  min-height: 0;
}
#filterBar{ flex: 0 0 auto; }
#viewDetail, #viewGroup, #viewStats{
  flex: 1 1 auto;
  min-height: 0;
}

/* Table wrapper fills panel; internal scroll inside table area */
#viewDetail{
  display: flex;
  flex-direction: column;
}
#viewDetail .table-wrap{
  flex: 1 1 auto;
  min-height: 0;
}
#viewDetail .table-responsive{
  max-height: none !important;
  height: 100%;
}

/* Make rows more compact to see more cases at once */
.table.table-sm > :not(caption) > * > *{ padding: .25rem .45rem; }
.table td{ font-size: .84rem; }
.table thead th{ font-size: .78rem; }

/* Keep sticky header visible with border */
.table thead th{
  top: 0;
}

/* ===== END Expand ===== */

</style>
<script>
  // ===== CONFIRMED_EDITS: l∆∞u ch·ªânh s·ª≠a v√† lu√¥n √°p v√†o ph√¢n t√≠ch =====
  const CONFIRMED_EDITS_KEY = "bv_xq_confirmed_edits_v1";
  window.__confirmedEdits = window.__confirmedEdits || new Map();

  function saveConfirmedEdits(){
    try{
      const arr = Array.from(window.__confirmedEdits.entries()).map(([rownum, v])=>({
        rownum,
        start_ms: v.start_ms,
        end_ms: v.end_ms,
        updated_at: v.updated_at || Date.now()
      }));
      localStorage.setItem(CONFIRMED_EDITS_KEY, JSON.stringify(arr));
    }catch(e){ /* ignore */ }
  }

  function loadConfirmedEdits(){
    try{
      const raw = localStorage.getItem(CONFIRMED_EDITS_KEY);
      if(!raw) return;
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) return;
      window.__confirmedEdits = new Map(arr.map(it => [Number(it.rownum), it]));
    }catch(e){ /* ignore */ }
  }

  function applyConfirmedEditsToRows(rows){
    if(!Array.isArray(rows) || !window.__confirmedEdits) return;
    if(window.__confirmedEdits.size === 0) return;
    for(const r of rows){
      const v = window.__confirmedEdits.get(r.rownum);
      if(!v) continue;
      if(typeof v.start_ms === "number") r.start = new Date(v.start_ms);
      if(typeof v.end_ms === "number") r.end = new Date(v.end_ms);
    }
  }

  // Load once at startup
  loadConfirmedEdits();
  // ===== END CONFIRMED_EDITS =====
</script>
</head>

<body>


  <div class="app-shell">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>L·ªçc l·ªói th·ªùi gian <span style="color:var(--accent)">X-quang</span></h1>
          <p class="sub">Excel/CSV ‚Üí L·ªçc theo ng√†y/gi·ªù ‚Üí Ph√¢n t√≠ch 3 l·ªói chu·∫©n ‚Üí Nh√≥m theo m√°y ‚Üí Xu·∫•t Excel</p>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 justify-content-end">
        <span class="chip">‚ö° Offline <b>100%</b></span>
        <span class="chip">üß† L·ªçc ng√†y/gi·ªù</span>
        <span class="chip">üì¶ Xu·∫•t <b>XLSX</b></span>
        <span class="chip">üñ® In/PDF</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="glass cardx">
        <div class="section-title">
          <div>
            <h2>1) N·∫°p d·ªØ li·ªáu & thi·∫øt l·∫≠p</h2>
            <p class="hint">L·ªçc ng√†y/gi·ªù √°p d·ª•ng cho <b>Bƒê (Ng√†y th·ª±c hi·ªán YL)</b>.</p>
          </div>

          <div class="badge-soft" id="xlsxBadge">
            <span class="dot" id="xlsxDot"></span>
            XLSX: <span id="xlsxText">‚Äî</span>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">Ch·ªçn file d·ªØ li·ªáu</label>
            <input id="file" class="form-control" type="file" accept=".xlsx,.xls,.csv,.txt,.tsv" />
            <div class="form-text">ƒê·∫∑t <b>xlsx.full.min.js</b> c√πng th∆∞ m·ª•c v·ªõi HTML ƒë·ªÉ ƒë·ªçc .xlsx v√† xu·∫•t .xlsx offline.</div>
          </div>

          <div class="col-12">
            <label class="form-label">Ti√™u ch√≠ nh·∫≠n di·ªán ca X-quang</label>
            <div class="d-flex flex-column gap-2">
  <label class="bv-check">
    <input type="checkbox" id="xqByService" checked>
    <span class="bv-mark" aria-hidden="true"></span>
    <span class="bv-label-text">T√™n DVKT ch·ª©a ‚Äúx-quang / xq‚Äù</span>
  </label>

  <label class="bv-check">
    <input type="checkbox" id="xqByMachine" checked>
    <span class="bv-mark" aria-hidden="true"></span>
    <span class="bv-label-text">M√£ m√°y b·∫Øt ƒë·∫ßu b·∫±ng ‚ÄúXQ‚Äù</span>
  </label>
</div>
          </div>

          <div class="col-12">
            <label class="form-label">L·ªçc theo ng√†y</label>
            <div class="row g-2">
              <div class="col-md-6">
                <input id="fromDate" type="date" class="form-control" />
                <div class="form-text">T·ª´ ng√†y (r·ªóng = kh√¥ng gi·ªõi h·∫°n)</div>
              </div>
              <div class="col-md-6">
                <input id="toDate" type="date" class="form-control" />
                <div class="form-text">ƒê·∫øn ng√†y (r·ªóng = kh√¥ng gi·ªõi h·∫°n)</div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">L·ªçc theo gi·ªù trong ng√†y</label>
            <div class="row g-2">
              <div class="col-md-6">
                <input id="fromTime" type="time" class="form-control" value="00:00" />
                <div class="form-text">Gi·ªù b·∫Øt ƒë·∫ßu (Bƒê ‚â• gi·ªù n√†y)</div>
              </div>
              <div class="col-md-6">
                <input id="toTime" type="time" class="form-control" value="23:59" />
                <div class="form-text">Gi·ªù k·∫øt th√∫c (Bƒê ‚â§ gi·ªù n√†y)</div>
              </div>
            </div>
            <div class="form-text mt-1">√Åp d·ª•ng theo <b>Bƒê</b>. Tr√πng Bƒê ch·ªâ b√°o l·ªói khi <b>tr√πng M√£ m√°y</b> (kh√°c m√°y b·ªè qua). Tr√πng KT lu√¥n l√† l·ªói.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Ng∆∞·ª°ng ‚ÄúTH < 6P‚Äù (ph√∫t)</label>
            <input id="minMinutes" type="number" class="form-control" value="6" min="1" step="1" disabled>
            <div class="form-text">Chu·∫©n theo y√™u c·∫ßu: 6 ph√∫t (kh√≥a).</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">So kh·ªõp tr√πng theo ph√∫t (b·ªè gi√¢y)</label>
            <input id="roundToMin" type="number" class="form-control" value="1" min="1" step="1" disabled>
            <div class="form-text">Kh√≥a: so theo ph√∫t.</div>
          </div>

          <div class="col-12">
            <div class="toolbar">
              <div class="left">
                <button id="btnRun" class="btn btn-primary" disabled>üîé PH√ÇN T√çCH</button>
                <button id="btnExport" class="btn btn-success" disabled>‚¨á CSV</button>
                <button id="btnExportXlsx" class="btn btn-success" disabled>üì¶ Excel</button>
                <button id="btnPrint" class="btn btn-outline-light" disabled>üñ® In/PDF</button>
              </div>
              <div class="right">
                <button id="btnCheckXlsx" class="btn btn-outline-warning">üß© Ki·ªÉm tra XLSX</button>
                <button id="btnClear" class="btn btn-outline-light">üßπ Xo√°</button>
              </div>
            </div>
            <div class="small-muted mt-2" id="sourceHint">Ngu·ªìn d·ªØ li·ªáu: ‚Äî</div>
          </div>

          <div class="col-12">
            <div id="diagBox" class="alertx warning d-none"></div>
          </div>

          <div class="col-12">
            <div class="tabs">
              <div class="tabbtn active" id="tabDetail">üìã B·∫£ng l·ªói</div>
              <div class="tabbtn" id="tabGroup">üß© Nh√≥m theo m√°y</div>
              <div class="tabbtn" id="tabStats">üìà Th·ªëng k√™</div>
<!-- DOWNLOAD_APPLIED_BTN -->
<div class="tabbtn" id="btnDownloadAppliedXLSX" title="Xu·∫•t danh s√°ch ca ƒë√£ ch·ªânh th·ªùi gian"
     style="margin-left:8px;background:#dcfce7;border:1px solid #22c55e;color:#065f46;opacity:.65;cursor:not-allowed;user-select:none;">
  ‚úÖ Xu·∫•t DS ƒë√£ ch·ªânh
</div>
<!-- END_DOWNLOAD_APPLIED_BTN -->
            </div>
            <div class="small-muted mt-2">Dropdown ‚ÄúLo·∫°i l·ªói‚Äù ƒë√£ kh√≥a ƒë√∫ng 3 lo·∫°i chu·∫©n BV.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="glass cardx right-panel">
        <div class="section-title">
          <div>
            <h2>2) K·∫øt qu·∫£</h2>
            <p class="hint">L·ªçc nhanh + Lo·∫°i l·ªói + S·∫Øp x·∫øp.</p>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kpi-wrap">
          <div class="kpi-box">
            <div class="lab">T·ªïng d√≤ng ƒë·ªçc</div>
            <div id="kpiRows" class="val">‚Äî</div>
            <div class="tag"><span class="dot"></span> Input</div>
          </div>
          <div class="kpi-box">
            <div class="lab">D√≤ng X-quang (sau l·ªçc)</div>
            <div id="kpiXQ" class="val">‚Äî</div>
            <div class="tag"><span class="dot ok"></span> Sau l·ªçc</div>
          </div>
          <div class="kpi-box">
            <div class="lab">S·ªë l·ªói</div>
            <div id="kpiErrors" class="val">‚Äî</div>
            <div class="tag"><span class="dot warn"></span> C·∫ßn ki·ªÉm</div>
          </div>
          <div class="kpi-box">
            <div class="lab">Ngu·ªìn d·ªØ li·ªáu</div>
            <div id="kpiSheet" class="val" style="font-size:1.05rem;line-height:1.2">‚Äî</div>
            <div class="tag"><span class="dot"></span> Sheet/CSV</div>
          </div>
        </div>

        <div class="divider"></div>

        <div id="filterBar">
          <div class="toolbar">
            <div class="left" style="flex:1; min-width:260px;">
              <div style="width:100%">
                <label class="form-label">L·ªçc nhanh</label>
                <input id="q" class="form-control" placeholder="VD: TR√ôNG KT, TR√ôNG Bƒê, XQ.2..., m√£ KCB..." />
              </div>
            </div>

            <div class="right" style="flex:1; justify-content:flex-end; min-width:260px;">
              <div style="min-width:230px; width:100%">
                <label class="form-label">Lo·∫°i l·ªói (chu·∫©n BV)</label>
                <select id="typeFilter" class="form-select">
                  <option value="">(T·∫•t c·∫£)</option>
                </select>
              </div>

              <div style="min-width:230px; width:100%">
                <label class="form-label">S·∫Øp x·∫øp</label>
                <select id="sortBy" class="form-select">
                  <option value="time">Th·ªùi gian</option>
                  <option value="type">Lo·∫°i l·ªói</option>
                  <option value="machine">M√£ m√°y ‚Üí Th·ªùi gian</option>
                </select>
              </div>

              <div class="d-grid" style="min-width:190px;">
                <label class="form-label">&nbsp;</label>
                <button id="btnCopySummary" class="btn btn-outline-light">üìã Copy t√≥m t·∫Øt</button>
              </div>
            </div>
          </div>

          <div class="divider"></div>
        </div>

        <div id="viewDetail">
          <div class="table-wrap">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Lo·∫°i l·ªói</th>
                    <th>M√¥ t·∫£</th>
                    <th>M√£ m√°y</th>
                    <th>Ng∆∞·ªùi TH</th>
                    <th>B√°c sƒ©</th>
                    <th>M√£ KCB</th>
                    <th>DVKT</th>
                    <th>Bƒê</th>
                    <th>KT</th>
                    <th>Ph√∫t</th>
                    <th>D√≤ng li√™n quan</th>
                  </tr>
                </thead>
                <tbody id="tbody">
                  <tr><td colspan="12" class="text-center" style="color:#334155; padding:16px">
                    Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫£i file v√† b·∫•m <b>PH√ÇN T√çCH</b>.
                  </td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="viewGroup" class="hidden">
          <div id="groupBox" class="small-muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
        </div>

        <div id="viewStats" class="hidden">
          <div class="row g-3">
            <div class="col-12">
              <div class="table-wrap">
                <div class="p-3">
                  <div class="badge-soft ok">üìå Th·ªëng k√™ nhanh</div>
                  <div class="small-muted mt-2" id="statsSummary">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="table-wrap">
                <div class="p-3">
                  <div class="badge-soft">üìç L·ªói theo lo·∫°i</div>
                  <div class="table-responsive" style="max-height:260px">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Lo·∫°i</th><th class="text-end">S·ªë</th></tr></thead>
                      <tbody id="tbType"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="table-wrap">
                <div class="p-3">
                  <div class="badge-soft">üß© L·ªói theo M√£ m√°y</div>
                  <div class="table-responsive" style="max-height:260px">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>M√£ m√°y</th><th class="text-end">S·ªë</th></tr></thead>
                      <tbody id="tbMachine"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="table-wrap">
                <div class="p-3">
                  <div class="badge-soft">üóì L·ªói theo ng√†y</div>
                  <div class="table-responsive" style="max-height:260px">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Ng√†y</th><th class="text-end">S·ªë</th></tr></thead>
                      <tbody id="tbDay"></tbody>
                    </table>
                  </div>
                  <div class="small-muted mt-2">Ng√†y l·∫•y theo <b>Bƒê</b> (thi·∫øu Bƒê th√¨ l·∫•y theo KT).</div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /RIGHT -->
    </div><!-- /grid -->
  </div><!-- /shell -->

  <script src="./xlsx.full.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    // ====== CONFIG: 3 l·ªói chu·∫©n BV ======
    const ERR_START_DIFF_MACHINE = "TR√ôNG Bƒê (C√ôNG M√ÅY)";
    const ERR_END_ANY            = "TR√ôNG KT";
    const ERR_DUR_LT_6           = "TH < 6P";
    const ALLOWED_TYPES = [ERR_START_DIFF_MACHINE, ERR_END_ANY, ERR_DUR_LT_6];

    function showDiag(msg, level="warning"){
      const box = $("diagBox");
      box.classList.remove("d-none");
      box.className = "alertx " + (level==="danger" ? "danger" : "warning");
      box.textContent = msg;
    }
    function hideDiag(){
      const box = $("diagBox");
      box.classList.add("d-none");
      box.textContent = "";
    }

    function excelNumberToDate(n) {
      const epoch = Date.UTC(1899, 11, 30);
      const ms = Math.round(n * 86400000);
      return normalizeToMinute(new Date(epoch + ms));
    }

    function toDate(val) {
      if (val == null || val === "") return null;
      if (val instanceof Date && !isNaN(val)) return normalizeToMinute(val);
      if (typeof val === "number" && isFinite(val)) return excelNumberToDate(val);

      if (typeof val === "string") {
        const s = val.trim().replace(/\s+/g, " ");
        const iso = new Date(s);
        if (!isNaN(iso)) return normalizeToMinute(iso);

        const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);
        if (m) {
          let d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10);
          if (y < 100) y += 2000;
          let hh = m[4] ? parseInt(m[4],10) : 0;
          const mm = m[5] ? parseInt(m[5],10) : 0;
          const ss = m[6] ? parseInt(m[6],10) : 0;
          const ap = m[7] ? m[7].toUpperCase() : null;
          if (ap === "PM" && hh < 12) hh += 12;
          if (ap === "AM" && hh === 12) hh = 0;
          const dt = new Date(y, mo, d, hh, mm, ss);
          if (!isNaN(dt)) return normalizeToMinute(dt);
        }
      }
      return null;
    }

    function fmt(dt) {
      if (!dt) return "";
      try {
        const f = new Intl.DateTimeFormat("vi-VN", {
          timeZone: "Asia/Ho_Chi_Minh",
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        });
        return f.format(dt);
      } catch (e) {
        return dt.toLocaleString();
      }
    }

    function fmtDay(dt){
      if (!dt) return "";
      try{
        const f = new Intl.DateTimeFormat("vi-VN", {
          timeZone: "Asia/Ho_Chi_Minh",
          year:"numeric", month:"2-digit", day:"2-digit"
        });
        return f.format(dt);
      }catch(e){
        const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,"0"), d=String(dt.getDate()).padStart(2,"0");
        return `${d}/${m}/${y}`;
      }
    }

    function safe(v) { return (v==null) ? "" : String(v); }
    function minutesBetween(a,b) { return Math.round((b.getTime()-a.getTime())/60000); }

    // Chu·∫©n ho√° th·ªùi gian v·ªÅ ƒë√∫ng ph√∫t ƒë·ªÉ kh·ªõp Excel (lo·∫°i b·ªè l·ªách do gi√¢y/ mili-gi√¢y ·∫©n)
    // Excel/ngu·ªìn HIS ƒë√¥i khi c√≥ gi√¢y, ho·∫∑c hi·ªÉn th·ªã l√†m tr√≤n; n·∫øu kh√¥ng chu·∫©n ho√° s·∫Ω l·ªách 1 ph√∫t.
    function normalizeToMinute(dt){
      if (!dt) return normalizeToMinute(dt);
      const t = dt.getTime();
      return new Date(Math.round(t / 60000) * 60000); // l√†m tr√≤n v·ªÅ ph√∫t g·∫ßn nh·∫•t
    }

    function parseCSV(text){
      const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim()!=="");
      if (!lines.length) return {headers:[], rows:[]};

      const head = lines[0];
      const comma = (head.match(/,/g)||[]).length;
      const semi = (head.match(/;/g)||[]).length;
      const tab = (head.match(/\t/g)||[]).length;
      const delim = tab>0 ? "\t" : (semi>comma ? ";" : ",");

      const splitLine = (line) => {
        const out = [];
        let cur="", inQ=false;
        for (let i=0;i<line.length;i++){
          const ch=line[i];
          if (ch === '"'){
            if (inQ && line[i+1] === '"'){ cur+='"'; i++; }
            else inQ = !inQ;
          } else if (!inQ && ch === delim){
            out.push(cur); cur="";
          } else cur += ch;
        }
        out.push(cur);
        return out.map(s=>s.trim());
      };

      const headers = splitLine(lines[0]);
      const rows = [];
      for (let r=1;r<lines.length;r++){
        const cols = splitLine(lines[r]);
        if (cols.every(c=>c==="")) continue;
        rows.push(cols);
      }
      return {headers, rows, delim};
    }

    function normHeader(h){ return safe(h).trim().toLowerCase().replace(/\s+/g," "); }
    function mapHeaders(headers){
      const idx = {}; headers.forEach((h,i)=> idx[normHeader(h)] = i);

      const pick = (cands) => {
        for (const c of cands){
          const k=normHeader(c);
          if (k in idx) return idx[k];
        }
        for (const c of cands){
          const k=normHeader(c);
          for (const key in idx){
            if (key.includes(k)) return idx[key];
          }
        }
        return -1;
      };

      return {
        ten: pick(["t√™n dvkt","ten dvkt","dvkt"]),
        maMay: pick(["m√£ m√°y","ma may"]),
        nguoiTH: pick(["ng∆∞·ªùi th·ª±c hi·ªán","nguoi thuc hien"]),
        bacSi: pick(["b√°c sƒ©","bac si"]),
        maKCB: pick(["m√£ kcb","ma kcb"]),
        start: pick(["ng√†y th·ª±c hi·ªán yl","ng√†y th·ª±c hi·ªán"]),
        end: pick(["ng√†y k·∫øt qu·∫£"])

,ylenh: pick(["ng√†y y l·ªánh","ngay y lenh","ng√†y v√†o","ngay vao"])
,ngayRa: pick(["ng√†y ra","ngay ra","th·ªùi gian k·∫øt th√∫c kh√°m","thoi gian ket thuc kham"])
};
    }

    function bucketMinute(dt) {
      if (!dt) return "";
      const minute = 60000;
      return String(Math.floor(dt.getTime() / minute) * minute);
    }

    function isXQ(row, byService, byMachine) {
      const ten = safe(row.ten).toLowerCase();
      const ma = safe(row.maMay).trim().toUpperCase();
      const okService = byService ? (
        ten.includes("x-quang") || ten.includes("x quang") || ten.includes("xq") ||
        ten.includes("x-ray") || ten.includes("xray")
      ) : false;
      const okMachine = byMachine ? (ma.startsWith("XQ")) : false;

      if (byService && byMachine) return okService || okMachine;
      if (byService) return okService;
      if (byMachine) return okMachine;
      return true;
    }

    function parseHHMM(t){
      if (!t) return null;
      const m = String(t).match(/^(\d{1,2}):(\d{2})$/);
      if (!m) return null;
      const hh = Math.min(23, Math.max(0, parseInt(m[1],10)));
      const mm = Math.min(59, Math.max(0, parseInt(m[2],10)));
      return hh*60 + mm;
    }

    function isInDateTimeWindow(startDt){
      if (!startDt) return true;
      const fromDate = $("fromDate").value;
      const toDate = $("toDate").value;
      const fromTime = parseHHMM($("fromTime").value || "00:00");
      const toTime   = parseHHMM($("toTime").value || "23:59");

      if (fromDate){
        const [y,m,d] = fromDate.split("-").map(n=>parseInt(n,10));
        const minDt = new Date(y, m-1, d, 0,0,0);
        if (startDt < minDt) return false;
      }
      if (toDate){
        const [y,m,d] = toDate.split("-").map(n=>parseInt(n,10));
        const maxDt = new Date(y, m-1, d, 23,59,59);
        if (startDt > maxDt) return false;
      }

      const startMin = startDt.getHours()*60 + startDt.getMinutes();
      if (fromTime!=null && startMin < fromTime) return false;
      if (toTime!=null && startMin > toTime) return false;

      return true;
    }

    function mkErr(type, row, desc, relatedRows=[]) {
      const dur = (row.start && row.end) ? minutesBetween(row.start, row.end) : null;
      const related = relatedRows.length ? relatedRows.map(r=>r.rownum).join(", ") : "";
      return {
        type, desc,
        rownum: row.rownum,
        maMay: row.maMay,
        nguoiTH: row.nguoiTH,
        bacSi: row.bacSi,
        maKCB: row.maKCB,
        ten: row.ten,
        start: row.start,
        end: row.end,
        duration: dur,
        related
      };
    }

    // ====== ONLY 3 ERRORS (as requested) ======
    function analyzeXQ(rows) {
      const errors = [];

      // (3) TH < 6P : duration >=0 && <6
      for (const r of rows) {
        if (r.start && r.end) {
          const dur = minutesBetween(r.start, r.end);
          if (dur >= 0 && dur < 6) {
            errors.push(mkErr(ERR_DUR_LT_6, r, `Th·ªùi gian th·ª±c hi·ªán ${dur} ph√∫t < 6 ph√∫t`, []));
          }
        }
      }

      // (1) TR√ôNG Bƒê (C√ôNG M√ÅY): c√πng ph√∫t Bƒê v√† TR√ôNG M√£ m√°y m·ªõi l√† l·ªói (kh√°c m√°y b·ªè qua)
const mapStart = new Map();
for (const r of rows) {
  if (!r.start) continue;
  const key = bucketMinute(r.start);
  if (!mapStart.has(key)) mapStart.set(key, []);
  mapStart.get(key).push(r);
}

for (const [key, arr] of mapStart.entries()) {
  if (arr.length < 2) continue;

  for (const r of arr) {
    const m0 = safe(r.maMay).trim().toUpperCase();
    // Ch·ªâ t√≠nh l·ªói khi c√≥ d√≤ng kh√°c c√πng ph√∫t v√† C√ôNG M√£ m√°y (v√† c√≥ m√£ m√°y)
    const othersSameMachine = arr.filter(x => {
      const mx = safe(x.maMay).trim().toUpperCase();
      return x !== r && m0 !== "" && mx === m0;
    });

    if (!othersSameMachine.length) continue;

    const desc = `Tr√πng Bƒê (${fmt(r.start)}) v√† tr√πng M√£ m√°y: ${m0}`;
    errors.push(mkErr(ERR_START_DIFF_MACHINE, r, desc, othersSameMachine));
  }
}
// (2) TR√ôNG KT: same minute end ALWAYS error
      const mapEnd = new Map();
      for (const r of rows) {
        if (!r.end) continue;
        const key = bucketMinute(r.end);
        if (!mapEnd.has(key)) mapEnd.set(key, []);
        mapEnd.get(key).push(r);
      }

      for (const [key, arr] of mapEnd.entries()) {
        if (arr.length < 2) continue;

        for (const r of arr) {
          const others = arr.filter(x => x !== r);
          const desc = `Tr√πng KT (${fmt(r.end)}) v·ªõi ${others.length} ca kh√°c`;
          errors.push(mkErr(ERR_END_ANY, r, desc, others));
        }
      }

      // Dedup
      const seen = new Set();
      const out = [];
      for (const e of errors) {
        const sig = [e.type, e.rownum, bucketMinute(e.start), bucketMinute(e.end), e.related].join("|");
        if (seen.has(sig)) continue;
        seen.add(sig);
        out.push(e);
      }
      return out;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }

    function setKPIs(rowsCount, xqCount, errors, sourceName) {
      $("kpiRows").textContent = rowsCount ?? "‚Äî";
      $("kpiXQ").textContent = xqCount ?? "‚Äî";
      $("kpiErrors").textContent = errors ? errors.length : "‚Äî";
      $("kpiSheet").textContent = sourceName ?? "‚Äî";
      $("sourceHint").textContent = "Ngu·ªìn d·ªØ li·ªáu: " + (sourceName ?? "‚Äî");

      ["kpiRows","kpiXQ","kpiErrors","kpiSheet"].forEach(id=>{
        const el = $(id);
        el.classList.remove("pulse");
        void el.offsetWidth;
        el.classList.add("pulse");
      });
    }

    // ====== dropdown locked to exactly 3 types (BV labels) ======
    function fillTypeFilter(errors) {
      const sel = $("typeFilter");
      const cur = sel.value;

      const FIXED_TYPES = [
        { v: ERR_START_DIFF_MACHINE, label: ERR_START_DIFF_MACHINE },
        { v: ERR_END_ANY,            label: ERR_END_ANY },
        { v: ERR_DUR_LT_6,           label: ERR_DUR_LT_6 }
      ];

      const count = {};
      for (const e of errors) count[e.type] = (count[e.type] || 0) + 1;

      sel.innerHTML = `<option value="">(T·∫•t c·∫£)</option>` +
        FIXED_TYPES.map(t => {
          const n = count[t.v] || 0;
          return `<option value="${escapeHtml(t.v)}">${escapeHtml(t.label)} (${n})</option>`;
        }).join("");

      const valid = FIXED_TYPES.some(t => t.v === cur);
      sel.value = valid ? cur : "";
    }

    function renderDetail(errors) {
      const q = $("q").value.trim().toLowerCase();
      const typeF = $("typeFilter").value;
      const sortBy = $("sortBy").value;

      let items = errors.slice().filter(e => ALLOWED_TYPES.includes(e.type));
      if (typeF) items = items.filter(e=>e.type===typeF);
      if (q) {
        items = items.filter(e => {
          const blob = [e.type,e.desc,e.maMay,e.nguoiTH,e.bacSi,e.maKCB,e.ten,fmt(e.start),fmt(e.end),e.rownum,e.related].join(" ").toLowerCase();
          return blob.includes(q);
        });
      }

      if (sortBy === "type") items.sort((a,b)=>a.type.localeCompare(b.type) || (a.start?.getTime()||0)-(b.start?.getTime()||0));
      else if (sortBy === "machine") items.sort((a,b)=>safe(a.maMay).localeCompare(safe(b.maMay)) || (a.start?.getTime()||0)-(b.start?.getTime()||0));
      else items.sort((a,b)=>(a.start?.getTime()||0)-(b.start?.getTime()||0));

      const tb = $("tbody");
      if (!items.length) {
        tb.innerHTML = `<tr><td colspan="12" class="text-center" style="color:#334155; padding:16px">
          Kh√¥ng c√≥ l·ªói theo b·ªô l·ªçc hi·ªán t·∫°i.
        </td></tr>`;
        return;
      }

      tb.innerHTML = items.map((e, idx) => {
        const cls = (e.type === ERR_END_ANY) ? "warn" : "warn";
        return `
          <tr class="rowerr err-row" data-rownum="${e.rownum}" data-errtype="${escapeHtml(e.type)}" data-kcb="${escapeHtml(safe(e.maKCB))}">
            <td class="mono">${idx+1}</td>
            <td><span class="badge-soft ${cls}">‚ö† ${escapeHtml(e.type)}</span></td>
            <td>${escapeHtml(e.desc)}</td>
            <td class="mono">${escapeHtml(safe(e.maMay))}</td>
            <td>${escapeHtml(safe(e.nguoiTH))}</td>
            <td>${escapeHtml(safe(e.bacSi))}</td>
            <td class="mono">${escapeHtml(safe(e.maKCB))}</td>
            <td>${escapeHtml(safe(e.ten))}</td>
            <td class="mono">${escapeHtml(fmt(e.start))}</td>
            <td class="mono">${escapeHtml(fmt(e.end))}</td>
            <td class="mono">${e.duration==null ? "" : e.duration}</td>
            <td class="mono">${e.related ? `Li√™n quan: ${escapeHtml(e.related)}` : ""}</td>
          </tr>
        `;
      }).join("");
      applyKcbColors();
    }


    // --- T√¥ m√†u c√°c ca tr√πng M√£ KCB (c√πng m√£ => c√πng m√†u) ---
    const KCB_PALETTE = [
      { border: "#22c55e", bg: "rgba(34,197,94,.10)" },   // green
      { border: "#3b82f6", bg: "rgba(59,130,246,.10)" },  // blue
      { border: "#a855f7", bg: "rgba(168,85,247,.10)" },  // purple
      { border: "#f97316", bg: "rgba(249,115,22,.10)" },  // orange
      { border: "#06b6d4", bg: "rgba(6,182,212,.10)" },   // cyan
      { border: "#e11d48", bg: "rgba(225,29,72,.10)" },   // rose
      { border: "#84cc16", bg: "rgba(132,204,22,.10)" },  // lime
      { border: "#f59e0b", bg: "rgba(245,158,11,.10)" }   // amber
    ];

    function hashStr(s){
      // djb2 (·ªïn ƒë·ªãnh, nhanh)
      let h = 5381;
      for (let i=0;i<s.length;i++) h = ((h<<5)+h) + s.charCodeAt(i);
      return (h >>> 0);
    }

    function applyKcbColors(){
      const rows = Array.from(document.querySelectorAll("#tbody tr.err-row"));
      if (!rows.length) return;

      for (const r of rows){
        const kcb = (r.dataset.kcb || "").trim();
        if (!kcb) { r.classList.remove("kcbTint"); continue; }

        const p = KCB_PALETTE[ hashStr(kcb) % KCB_PALETTE.length ];
        r.classList.add("kcbTint");
        r.style.setProperty("--kcbBorder", p.border);
        r.style.setProperty("--kcbBg", p.bg);

        // tooltip nh·∫π ƒë·ªÉ d·ªÖ ki·ªÉm tra nhanh
        if (!r.title) r.title = `M√£ KCB: ${kcb}`;
      }
    }

    function buildGroupByMachine(errors){
      const q = $("q").value.trim().toLowerCase();
      const typeF = $("typeFilter").value;

      let items = errors.slice().filter(e => ALLOWED_TYPES.includes(e.type));
      if (typeF) items = items.filter(e=>e.type===typeF);
      if (q) {
        items = items.filter(e => {
          const blob = [e.type,e.desc,e.maMay,e.nguoiTH,e.bacSi,e.maKCB,e.ten,fmt(e.start),fmt(e.end),e.rownum,e.related].join(" ").toLowerCase();
          return blob.includes(q);
        });
      }

      if (!items.length){
        $("groupBox").innerHTML = `<div class="text-center" style="color:#334155; padding:16px">Kh√¥ng c√≥ l·ªói theo b·ªô l·ªçc hi·ªán t·∫°i.</div>`;
        return;
      }

      const map = new Map();
      for (const e of items){
        const m = safe(e.maMay).trim().toUpperCase() || "(KH√îNG R√ï)";
        if (!map.has(m)) map.set(m, []);
        map.get(m).push(e);
      }

      const machines = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b));
      const accId = "accMachine";
      const html = `
        <div class="accordion" id="${accId}">
          ${machines.map((m, idx)=>{
            const arr = map.get(m);
            arr.sort((a,b)=>(a.start?.getTime()||0)-(b.start?.getTime()||0));
            const body = `
              <div class="table-wrap mt-2">
                <div class="table-responsive" style="max-height:360px">
                  <table class="table table-sm mb-0">
                    <thead>
                      <tr>
                        <th>#</th><th>Lo·∫°i l·ªói</th><th>M√¥ t·∫£</th><th>Bƒê</th><th>KT</th><th>D√≤ng</th><th>Li√™n quan</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${arr.map((e,i)=>`
                        <tr class="rowerr err-row" data-rownum="${e.rownum}" data-errtype="${escapeHtml(e.type)}" data-kcb="${escapeHtml(safe(e.maKCB))}">
                          <td class="mono">${i+1}</td>
                          <td><span class="badge-soft warn">${escapeHtml(e.type)}</span></td>
                          <td>${escapeHtml(e.desc)}</td>
                          <td class="mono">${escapeHtml(fmt(e.start))}</td>
                          <td class="mono">${escapeHtml(fmt(e.end))}</td>
                          <td class="mono">${escapeHtml(String(e.rownum ?? ""))}</td>
                          <td class="mono">${escapeHtml(e.related ?? "")}</td>
                        </tr>
                      `).join("")}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
            const cid = "m" + idx;
            return `
              <div class="accordion-item mb-2">
                <h2 class="accordion-header">
                  <button class="accordion-button ${idx===0 ? "" : "collapsed"}" type="button"
                    data-bs-toggle="collapse" data-bs-target="#${cid}">
                    üß© M√°y: <span class="mono ms-2">${escapeHtml(m)}</span>
                    <span class="ms-auto badge-soft warn">L·ªói: ${arr.length}</span>
                  </button>
                </h2>
                <div id="${cid}" class="accordion-collapse collapse ${idx===0 ? "show" : ""}" data-bs-parent="#${accId}">
                  <div class="accordion-body">
                    ${body}
                  </div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;
      $("groupBox").innerHTML = html;
    }

    function buildStats(errors, allRowsLen, xqRowsLen, sourceName){
      const filtered = errors.slice().filter(e => ALLOWED_TYPES.includes(e.type));

      if (!filtered.length){
        $("statsSummary").textContent = "Ch∆∞a c√≥ l·ªói ƒë·ªÉ th·ªëng k√™.";
        $("tbType").innerHTML = `<tr><td colspan="2" class="text-center" style="color:#334155;padding:12px">‚Äî</td></tr>`;
        $("tbMachine").innerHTML = `<tr><td colspan="2" class="text-center" style="color:#334155;padding:12px">‚Äî</td></tr>`;
        $("tbDay").innerHTML = `<tr><td colspan="2" class="text-center" style="color:#334155;padding:12px">‚Äî</td></tr>`;
        return;
      }

      const typeCount = {};
      const machineCount = {};
      const dayCount = {};

      for (const e of filtered){
        typeCount[e.type] = (typeCount[e.type]||0)+1;
        const m = safe(e.maMay).trim().toUpperCase() || "(KH√îNG R√ï)";
        machineCount[m] = (machineCount[m]||0)+1;
        const day = fmtDay(e.start || e.end);
        const dk = day || "(KH√îNG R√ï)";
        dayCount[dk] = (dayCount[dk]||0)+1;
      }

      const topType = Object.entries(typeCount).sort((a,b)=>b[1]-a[1])[0];
      const topMachine = Object.entries(machineCount).sort((a,b)=>b[1]-a[1])[0];
      const topDay = Object.entries(dayCount).sort((a,b)=>b[1]-a[1])[0];

      $("statsSummary").innerHTML = `
        <div class="small-muted">
          <div><b>Ngu·ªìn:</b> ${escapeHtml(sourceName||"‚Äî")}</div>
          <div><b>T·ªïng d√≤ng:</b> ${allRowsLen} ¬∑ <b>X-quang (sau l·ªçc):</b> ${xqRowsLen} ¬∑ <b>T·ªïng l·ªói:</b> ${filtered.length}</div>
          <div class="mt-2">
            <span class="badge-soft warn">Top lo·∫°i: ${escapeHtml(topType?.[0]||"‚Äî")} (${topType?.[1]||0})</span>
            <span class="badge-soft warn ms-2">Top m√°y: ${escapeHtml(topMachine?.[0]||"‚Äî")} (${topMachine?.[1]||0})</span>
            <span class="badge-soft warn ms-2">Top ng√†y: ${escapeHtml(topDay?.[0]||"‚Äî")} (${topDay?.[1]||0})</span>
          </div>
        </div>
      `;

      const rowsType = ALLOWED_TYPES.map(t => [t, typeCount[t]||0])
        .filter(([,v])=>v>0)
        .sort((a,b)=>b[1]-a[1])
        .map(([k,v])=>`<tr><td>${escapeHtml(k)}</td><td class="text-end mono">${v}</td></tr>`).join("");
      $("tbType").innerHTML = rowsType || `<tr><td colspan="2" class="text-center" style="color:#334155;padding:12px">‚Äî</td></tr>`;

      const rowsMachine = Object.entries(machineCount).sort((a,b)=>b[1]-a[1])
        .map(([k,v])=>`<tr><td class="mono">${escapeHtml(k)}</td><td class="text-end mono">${v}</td></tr>`).join("");
      $("tbMachine").innerHTML = rowsMachine || `<tr><td colspan="2" class="text-center" style="color:#334155;padding:12px">‚Äî</td></tr>`;

      const rowsDay = Object.entries(dayCount).sort((a,b)=>b[1]-a[1])
        .map(([k,v])=>`<tr><td class="mono">${escapeHtml(k)}</td><td class="text-end mono">${v}</td></tr>`).join("");
      $("tbDay").innerHTML = rowsDay || `<tr><td colspan="2" class="text-center" style="color:#334155;padding:12px">‚Äî</td></tr>`;
    }

    function exportCSV(errors) {
      const filtered = errors.filter(e => ALLOWED_TYPES.includes(e.type));
      const headers = ["LoaiLoi","MoTa","MaMay","NguoiTH","BacSi","MaKCB","TenDVKT","BatDau","KetThuc","Phut","Dong","DongLienQuan"];
      const rows = filtered.map(e => [
        e.type, e.desc, e.maMay, e.nguoiTH, e.bacSi, e.maKCB, e.ten, fmt(e.start), fmt(e.end),
        e.duration ?? "", e.rownum ?? "", e.related ?? ""
      ].map(v => `"${String(v??"").replace(/"/g,'""')}"`).join(","));

      const csv = headers.join(",") + "\n" + rows.join("\n");
      const BOM = "\uFEFF";
      const blob = new Blob([BOM + csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `loi_xquang_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportXLSX(errors, allLen, xqLen, sourceName){
      if (typeof XLSX === "undefined"){
        showDiag("Kh√¥ng th·ªÉ xu·∫•t Excel v√¨ thi·∫øu th∆∞ vi·ªán XLSX. H√£y ƒë·∫∑t xlsx.full.min.js c√πng th∆∞ m·ª•c.", "danger");
        return;
      }
      const now = new Date();
      const fileName = `BaoCao_Loi_XQuang_${now.toISOString().slice(0,10)}.xlsx`;
      const filtered = errors.filter(e => ALLOWED_TYPES.includes(e.type));

      const detail = filtered.map((e, i)=>({
        STT: i+1,
        LoaiLoi: e.type,
        MoTa: e.desc,
        MaMay: e.maMay,
        NguoiTH: e.nguoiTH,
        BacSi: e.bacSi,
        MaKCB: e.maKCB,
        TenDVKT: e.ten,
        BatDau: fmt(e.start),
        KetThuc: fmt(e.end),
        Phut: (e.duration==null ? "" : e.duration),
        Dong: e.rownum ?? "",
        DongLienQuan: e.related ?? ""
      }));

      const typeCount = {};
      const machineCount = {};
      const dayCount = {};
      filtered.forEach(e=>{
        typeCount[e.type]=(typeCount[e.type]||0)+1;
        const m=(safe(e.maMay).trim().toUpperCase()||"(KH√îNG R√ï)");
        machineCount[m]=(machineCount[m]||0)+1;
        const d=fmtDay(e.start||e.end) || "(KH√îNG R√ï)";
        dayCount[d]=(dayCount[d]||0)+1;
      });

      const summaryRows = [
        {ThongTin:"Ngu·ªìn", GiaTri: String(sourceName || "‚Äî")},
        {ThongTin:"T·ªïng d√≤ng", GiaTri: String(allLen)},
        {ThongTin:"D√≤ng X-quang (sau l·ªçc)", GiaTri: String(xqLen)},
        {ThongTin:"T·ªïng l·ªói (3 lo·∫°i)", GiaTri: String(filtered.length)},
        {ThongTin:"T·ª´ ng√†y", GiaTri: String($("fromDate").value || "(kh√¥ng)")},
        {ThongTin:"ƒê·∫øn ng√†y", GiaTri: String($("toDate").value || "(kh√¥ng)")},
        {ThongTin:"Gi·ªù t·ª´", GiaTri: String($("fromTime").value || "00:00")},
        {ThongTin:"Gi·ªù ƒë·∫øn", GiaTri: String($("toTime").value || "23:59")},
        {ThongTin:"Quy t·∫Øc", GiaTri: "Tr√πng Bƒê ch·ªâ l·ªói khi tr√πng M√£ m√°y; Tr√πng KT lu√¥n l·ªói; TH < 6P"}
      ];

      const byMachine = Object.entries(machineCount).sort((a,b)=>b[1]-a[1]).map(([k,v])=>({MaMay:k, SoLoi:v}));
      const byDay = Object.entries(dayCount).sort((a,b)=>b[1]-a[1]).map(([k,v])=>({Ngay:k, SoLoi:v}));
      const byType = ALLOWED_TYPES.map(t => ({LoaiLoi: t, SoLoi: typeCount[t]||0})).filter(r=>r.SoLoi>0);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detail.length?detail:[{STT:"",LoaiLoi:"",MoTa:""}]), "LOI_CHI_TIET");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryRows), "TONG_HOP");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byMachine.length?byMachine:[{MaMay:"",SoLoi:""}]), "THEO_MAY");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byDay.length?byDay:[{Ngay:"",SoLoi:""}]), "THEO_NGAY");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byType.length?byType:[{LoaiLoi:"",SoLoi:""}]), "THEO_LOAI");

      XLSX.writeFile(wb, fileName);
    }

    let allRows = [];
    let xqRows = [];
    let analyzedErrors = [];
    let sourceName = "‚Äî";
    let selectedFile = null;

    function canReadExcel(){ return typeof XLSX !== "undefined"; }

    async function loadDataFromFile(f){
      hideDiag();
      selectedFile = f;
      allRows = []; xqRows = []; analyzedErrors = [];
      $("btnExport").disabled = true;
      $("btnExportXlsx").disabled = true;
      $("btnPrint").disabled = true;

      $("tbody").innerHTML = `<tr><td colspan="12" class="text-center" style="color:#334155; padding:16px">
        ƒê√£ t·∫£i file. B·∫•m <b>PH√ÇN T√çCH</b> ƒë·ªÉ x·ª≠ l√Ω‚Ä¶
      </td></tr>`;
      $("groupBox").textContent = "ƒê√£ t·∫£i file. B·∫•m PH√ÇN T√çCH ƒë·ªÉ xem nh√≥m theo m√°y.";
      $("statsSummary").textContent = "ƒê√£ t·∫£i file. B·∫•m PH√ÇN T√çCH ƒë·ªÉ xem th·ªëng k√™.";

      if (!f){ $("btnRun").disabled = true; return; }

      const name = f.name || "‚Äî";
      const ext = name.split(".").pop().toLowerCase();

      if (ext === "csv" || ext === "txt" || ext === "tsv"){
        const text = await f.text();
        const parsed = parseCSV(text);
        const col = mapHeaders(parsed.headers);

        const missing = [];
        if (col.start < 0) missing.push("Ng√†y th·ª±c hi·ªán YL");
        if (col.end < 0) missing.push("Ng√†y k·∫øt qu·∫£");
        if (col.ten < 0) missing.push("T√™n DVKT");
        if (col.maMay < 0) missing.push("M√£ m√°y");
        if (missing.length){
          showDiag("CSV thi·∫øu c·ªôt b·∫Øt bu·ªôc: " + missing.join(", ") + "\nH√£y ki·ªÉm tra h√†ng ti√™u ƒë·ªÅ gi·ªëng Sheet1.", "danger");
          $("btnRun").disabled = true;
          return;
        }

        allRows = parsed.rows.map((cols, idx)=>({
          rownum: idx+2,
          ten: cols[col.ten] ?? "",
          maMay: cols[col.maMay] ?? "",
          nguoiTH: col.nguoiTH>=0 ? (cols[col.nguoiTH] ?? "") : "",
          bacSi: col.bacSi>=0 ? (cols[col.bacSi] ?? "") : "",
          maKCB: col.maKCB>=0 ? (cols[col.maKCB] ?? "") : "",
          start: toDate(cols[col.start]),
          end: toDate(cols[col.end]),
        }));

        sourceName = "CSV: " + name;
        setKPIs(allRows.length, "‚Äî", [], sourceName);
        $("btnRun").disabled = false;
        return;
      }

      if ((ext==="xlsx" || ext==="xls") && !canReadExcel()){
        showDiag("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c Excel v√¨ thi·∫øu xlsx.full.min.js.\n‚û°Ô∏è ƒê·∫∑t xlsx.full.min.js c√πng th∆∞ m·ª•c v·ªõi index.html, ho·∫∑c Save As CSV UTF-8 ƒë·ªÉ d√πng CSV.", "danger");
        $("btnRun").disabled = true;
        return;
      }

      if (ext==="xlsx" || ext==="xls"){
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, {type:"array", cellDates:true, raw:true});
        const sheetName = (wb.SheetNames.includes("Sheet1") ? "Sheet1" : wb.SheetNames[0]);
        const ws = wb.Sheets[sheetName];
        const aoa = XLSX.utils.sheet_to_json(ws, {header: 1, raw: true, defval: null});

        let headerRowIdx = -1;
        for (let r=0;r<Math.min(120, aoa.length);r++){
          const joined = (aoa[r]||[]).map(x=>safe(x)).join(" | ");
          if (joined.includes("Ng√†y th·ª±c hi·ªán") && joined.includes("Ng√†y k·∫øt qu·∫£")) { headerRowIdx = r; break; }
        }
        if (headerRowIdx === -1) headerRowIdx = 0;

        const headers = (aoa[headerRowIdx]||[]).map(h=>safe(h).trim());
        const col = mapHeaders(headers);

        const missing = [];
        if (col.start < 0) missing.push("Ng√†y th·ª±c hi·ªán YL");
        if (col.end < 0) missing.push("Ng√†y k·∫øt qu·∫£");
        if (col.ten < 0) missing.push("T√™n DVKT");
        if (col.maMay < 0) missing.push("M√£ m√°y");
        if (missing.length){
          showDiag("Excel thi·∫øu c·ªôt b·∫Øt bu·ªôc: " + missing.join(", ") + "\nH√£y ki·ªÉm tra header trong Sheet1.", "danger");
          $("btnRun").disabled = true;
          return;
        }

        const rows = [];
        for (let r=headerRowIdx+1; r<aoa.length; r++){
          const row = aoa[r] || [];
          const nonEmpty = row.some(v => v!=null && safe(v).trim()!=="");
          if (!nonEmpty) continue;
          rows.push({row, rownum: r+1});
        }

        allRows = rows.map((it)=>({
          rownum: it.rownum,
          ten: it.row[col.ten] ?? "",
          maMay: it.row[col.maMay] ?? "",
          nguoiTH: col.nguoiTH>=0 ? (it.row[col.nguoiTH] ?? "") : "",
          bacSi: col.bacSi>=0 ? (it.row[col.bacSi] ?? "") : "",
          maKCB: col.maKCB>=0 ? (it.row[col.maKCB] ?? "") : "",
          ylenh: (col.ylenh>=0 ? toDate(it.row[col.ylenh]) : null),
          ngayRa: (col.ngayRa>=0 ? toDate(it.row[col.ngayRa]) : null),
          start: toDate(it.row[col.start]),
          end: toDate(it.row[col.end]),
        }));

        sourceName = `Excel: ${name} / ${sheetName}`;
        setKPIs(allRows.length, "‚Äî", [], sourceName);
        $("btnRun").disabled = false;
        return;
      }

      showDiag("ƒê·ªãnh d·∫°ng file ch∆∞a h·ªó tr·ª£. H√£y d√πng .xlsx ho·∫∑c .csv", "danger");
      $("btnRun").disabled = true;
    }

    function runAnalysis(){
      hideDiag();
      if (!selectedFile || allRows.length===0){
        showDiag("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch. H√£y ch·ªçn file tr∆∞·ªõc.", "danger");
        return;
      }

      const byService = $("xqByService").checked;
      const byMachine = $("xqByMachine").checked;

      const xqAll = allRows.filter(r => isXQ(r, byService, byMachine));
      xqRows = xqAll.filter(r => isInDateTimeWindow(r.start));

      applyConfirmedEditsToRows(xqRows);
      analyzedErrors = analyzeXQ(xqRows);
      window.xqRows = xqRows;
      window.allRows = allRows;

      setKPIs(allRows.length, xqRows.length, analyzedErrors, sourceName);
      fillTypeFilter(analyzedErrors);

      $("btnExport").disabled = analyzedErrors.length === 0;
      $("btnExportXlsx").disabled = analyzedErrors.length === 0 || (typeof XLSX === "undefined");
      $("btnPrint").disabled = analyzedErrors.length === 0;

      rerenderAll();

      if (xqAll.length === 0){
        showDiag("Kh√¥ng t√¨m th·∫•y d√≤ng X-quang theo ti√™u ch√≠ ƒëang b·∫≠t.\n‚û°Ô∏è Th·ª≠ b·∫≠t c·∫£ 2 ti√™u ch√≠ ho·∫∑c ki·ªÉm tra T√™n DVKT/M√£ m√°y.", "warning");
        return;
      }
      if (xqRows.length === 0){
        showDiag("C√≥ d√≤ng X-quang, nh∆∞ng sau l·ªçc ng√†y/gi·ªù th√¨ kh√¥ng c√≤n d√≤ng n√†o.\n‚û°Ô∏è Ki·ªÉm tra T·ª´/ƒê·∫øn ng√†y v√† Gi·ªù t·ª´/ƒë·∫øn.", "warning");
      }
    }

    function setXlsxStatus(){
      const ok = (typeof XLSX !== "undefined");
      const dot = $("xlsxDot");
      const txt = $("xlsxText");
      if (ok){
        dot.className = "dot ok"; txt.textContent = "OK";
      }else{
        dot.className = "dot danger"; txt.textContent = "FAIL";
      }
      return ok;
    }

    function switchTab(which){
      $("tabDetail").classList.remove("active");
      $("tabGroup").classList.remove("active");
      $("tabStats").classList.remove("active");
      $("viewDetail").classList.add("hidden");
      $("viewGroup").classList.add("hidden");
      $("viewStats").classList.add("hidden");

      if (which==="detail"){ $("tabDetail").classList.add("active"); $("viewDetail").classList.remove("hidden"); }
      if (which==="group"){ $("tabGroup").classList.add("active"); $("viewGroup").classList.remove("hidden"); }
      if (which==="stats"){ $("tabStats").classList.add("active"); $("viewStats").classList.remove("hidden"); }
    }

    $("tabDetail").addEventListener("click", ()=>switchTab("detail"));
    $("tabGroup").addEventListener("click", ()=>switchTab("group"));
    $("tabStats").addEventListener("click", ()=>switchTab("stats"));

    $("file").addEventListener("change", async (ev)=>{ await loadDataFromFile(ev.target.files?.[0]); });
    $("btnRun").addEventListener("click", runAnalysis);
    $("btnExport").addEventListener("click", ()=>{ if(analyzedErrors.length) exportCSV(analyzedErrors); });

    $("btnExportXlsx").addEventListener("click", ()=>{
      if (!analyzedErrors.length) return;
      exportXLSX(analyzedErrors, allRows.length, xqRows.length, sourceName);
    });

    $("btnPrint").addEventListener("click", ()=>{
      if (!analyzedErrors.length) return;
      window.print();
    });

    $("btnClear").addEventListener("click", ()=>{
      selectedFile=null; allRows=[]; xqRows=[]; analyzedErrors=[]; sourceName="‚Äî";
      $("file").value="";
      $("tbody").innerHTML = `<tr><td colspan="12" class="text-center" style="color:#334155; padding:16px">
        Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫£i file v√† b·∫•m <b>PH√ÇN T√çCH</b>.
      </td></tr>`;
      $("typeFilter").innerHTML = `<option value="">(T·∫•t c·∫£)</option>`;
      $("q").value = "";
      $("btnExport").disabled = true;
      $("btnExportXlsx").disabled = true;
      $("btnRun").disabled = true;
      $("btnPrint").disabled = true;
      hideDiag();
      $("sourceHint").textContent = "Ngu·ªìn d·ªØ li·ªáu: ‚Äî";
      setKPIs(null, null, null, "‚Äî");
      $("groupBox").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu.";
      $("statsSummary").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu.";
      $("tbType").innerHTML = "";
      $("tbMachine").innerHTML = "";
      $("tbDay").innerHTML = "";
      switchTab("detail");
    });

    function rerenderAll(){
      renderDetail(analyzedErrors);
      buildGroupByMachine(analyzedErrors);
      buildStats(analyzedErrors, allRows.length, xqRows.length, sourceName);
    }

    ["q","typeFilter","sortBy"].forEach(id => {
      $(id).addEventListener("input", rerenderAll);
      $(id).addEventListener("change", rerenderAll);
    });

    $("btnCopySummary").addEventListener("click", async ()=>{
      const filtered = analyzedErrors.filter(e=>ALLOWED_TYPES.includes(e.type));
      const count = {};
      for (const e of filtered) count[e.type] = (count[e.type]||0)+1;

      const summary = [
        `${sourceName}`,
        `T·ªïng d√≤ng: ${allRows.length}`,
        `D√≤ng X-quang (sau l·ªçc): ${xqRows.length}`,
        `T·ªïng l·ªói (3 lo·∫°i): ${filtered.length}`,
        `L·ªçc ng√†y: ${$("fromDate").value||"(kh√¥ng)"} ‚Üí ${$("toDate").value||"(kh√¥ng)"}`,
        `L·ªçc gi·ªù: ${$("fromTime").value||"00:00"} ‚Üí ${$("toTime").value||"23:59"}`,
        `Ph√¢n lo·∫°i: ` + ALLOWED_TYPES.map(t=>`${t}: ${count[t]||0}`).join(", ")
      ].join("\n");

      try{
        await navigator.clipboard.writeText(summary);
        const btn = $("btnCopySummary");
        btn.textContent="ƒê√£ copy ‚úî";
        setTimeout(()=>btn.textContent="üìã Copy t√≥m t·∫Øt", 1100);
      }catch(e){
        showDiag(summary, "warning");
      }
    });

    $("btnCheckXlsx").addEventListener("click", ()=>{
      const ok = setXlsxStatus();
      if(ok) hideDiag();
      else showDiag("Kh√¥ng th·∫•y th∆∞ vi·ªán XLSX.\n‚û°Ô∏è ƒê·∫∑t file xlsx.full.min.js c√πng th∆∞ m·ª•c v·ªõi index.html (offline/GitHub Pages), ho·∫∑c d√πng CSV.", "danger");
    });

    window.addEventListener("load", ()=>{
      setXlsxStatus();
      if (!canReadExcel()){
        showDiag("L∆∞u √Ω: Kh√¥ng ƒë·ªçc/xu·∫•t Excel v√¨ thi·∫øu xlsx.full.min.js.\nB·∫°n v·∫´n d√πng ƒë∆∞·ª£c CSV: Excel ‚Üí Save As ‚Üí CSV UTF-8.", "warning");
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // bindPulseBVCheckboxes: pulse 0.2s m·ªói l·∫ßn tick/b·ªè tick
  function bindPulseBVCheckboxes(){
    document.querySelectorAll(".bv-check input[type='checkbox']").forEach(cb=>{
      cb.addEventListener("change", ()=>{
        const mark = cb.nextElementSibling; // .bv-mark
        if(!mark) return;
        mark.classList.remove("pulse");
        void mark.offsetWidth; // force reflow
        mark.classList.add("pulse");
        setTimeout(()=>mark.classList.remove("pulse"), 200);
      });
    });
  }
  bindPulseBVCheckboxes();
</script>


<script>
  // esc2: escape an to√†n, lu√¥n t·ªìn t·∫°i
  function esc2(s){
    try{ return (typeof escapeHtml==="function") ? escapeHtml(s) : String(s??""); }
    catch(e){ return String(s??""); }
  }
</script>

<!-- ===== FIX SUGGESTION MODAL ===== -->
<div id="fixBackdrop" class="bv-modal-backdrop" aria-hidden="true"></div>
<div id="fixModal" class="bv-modal" role="dialog" aria-modal="true" aria-labelledby="fixTitle">
  <div class="bv-modal-dialog bv-modal-card">
    <div class="bv-modal-header">
      <h3 class="bv-modal-title" id="fixTitle">üõ† ƒê·ªÅ xu·∫•t th·ªùi gian s·ª≠a (tr√°nh 3 l·ªói)</h3>
      <button class="btn btn-outline-light" type="button" id="btnFixClose" style="border-color:#cbd5e1;color:#0f172a;background:#fff">‚úñ ƒê√≥ng</button>
    </div>
    <div class="bv-modal-body bv-modal-body">
      <div class="kv">
        <div class="box">
          <div class="lab">Ca l·ªói</div>
          <div class="val mono" id="fixCaseInfo">‚Äî</div>
        </div>
        <div class="box">
          <div class="lab">Lo·∫°i l·ªói</div>
          <div class="val" id="fixErrType">‚Äî</div>
        </div>

        <div class="box">
          <div class="lab">Gi·ªõi h·∫°n (b·∫Øt bu·ªôc)</div>
          <div class="val mono" id="fixBounds">‚Äî</div>
        </div>
        <div class="box">
          <div class="lab">Th·ªùi gian g·ªëc</div>
          <div class="val mono" id="fixOriginal">‚Äî</div>
        </div>

        <div class="box" style="border-color:#86efac;background:#f0fdf4">
          <div class="lab">ƒê·ªÅ xu·∫•t (g·∫ßn s√°t nh·∫•t)</div>
          <div class="val mono" id="fixSuggest">‚Äî</div>
        </div>
        <div class="box">
          <div class="lab">Kho·∫£ng l·ªách so v·ªõi g·ªëc</div>
          <div class="val mono" id="fixDelta">‚Äî</div>
        </div>
      </div>

      <div class="note" id="fixNote" style="display:none"></div>
<div style="margin-top:12px;">
  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <div style="font-weight:900;color:#0f172a;">üìå Danh s√°ch ƒë√£ ch·ªânh (trong phi√™n l√†m vi·ªác)</div>
    <div style="display:flex;gap:8px;align-items:center;">
  
  <button class="btn btn-outline-light" type="button" id="btnToggleApplied" style="border-color:#cbd5e1;">·∫®n/Hi·ªán</button>
</div>
  </div>
  <div id="appliedFixesWrap" style="margin-top:8px;display:block;">
    <div style="overflow:auto;border:1px solid #e2e8f0;border-radius:14px;">
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead style="background:#f8fafc;border-bottom:1px solid #e2e8f0;">
          <tr>
            <th style="text-align:left;padding:8px 10px;white-space:nowrap;">D√≤ng</th>
            <th style="text-align:left;padding:8px 10px;white-space:nowrap;">M√°y</th>
            <th style="text-align:left;padding:8px 10px;white-space:nowrap;">M√£ KCB</th>
            <th style="text-align:left;padding:8px 10px;white-space:nowrap;">Bƒê c≈© ‚Üí m·ªõi</th>
            <th style="text-align:left;padding:8px 10px;white-space:nowrap;">KT c≈© ‚Üí m·ªõi</th>
            <th style="text-align:left;padding:8px 10px;white-space:nowrap;">L√∫c √°p d·ª•ng</th>
          </tr>
        </thead>
        <tbody id="appliedFixesBody">
          <tr><td colspan="6" style="padding:10px;color:#64748b;">Ch∆∞a c√≥ ch·ªânh s·ª≠a n√†o.</td></tr>
        </tbody>
      </table>
    </div>
    <div style="margin-top:6px;color:#475569;font-size:12.5px;">
      * Danh s√°ch n√†y ƒë∆∞·ª£c l∆∞u (localStorage) ƒë·ªÉ b·∫•m PH√ÇN T√çCH l·∫°i v·∫´n gi·ªØ. Kh√¥ng ghi v√†o file Excel g·ªëc.
    </div>
  </div>
</div>
    </div>

        <div class="bv-modal-footer bv-footer">
      <button class="btn btn-outline-secondary" type="button" id="btnFixClose2">‚ùå ƒê√≥ng</button>

      <div class="bv-footer-status" id="fixFooterStatus">‚Ñπ Ch∆∞a c√≥ ch·ªânh s·ª≠a</div>

      <div class="bv-footer-actions">
        <button class="btn btn-outline-warning" type="button" id="btnFixNext">üîÅ ƒê·ªïi ƒë·ªÅ xu·∫•t</button>
        <button class="btn btn-outline-light" type="button" id="btnFixCopy">üìã Copy ƒë·ªÅ xu·∫•t</button>
        <button class="btn btn-success" type="button" id="btnFixExportApplied" disabled
                title="Xu·∫•t danh s√°ch ca ƒë√£ ch·ªânh th·ªùi gian">‚¨á Xu·∫•t DS ƒë√£ ch·ªânh</button>
        <button class="btn btn-success" type="button" id="btnFixApply">‚úÖ √Åp d·ª•ng</button>
      </div>
    </div>
  </div>
</div>
<!-- ===== END MODAL ===== -->


<script>
  function $id(x){ return document.getElementById(x); }
  // ===== Fix suggestion engine (near-original, within bounds, avoids 3 errors) =====
  let __fixState = { list: [], idx: 0, rownum: null };

  function addMinutes(dt, m){
    if(!dt) return null;
    return new Date(dt.getTime() + m*60000);
  }
  function sameMinute(a,b){
    if(!a || !b) return false;
    return Math.floor(a.getTime()/60000) === Math.floor(b.getTime()/60000);
  }
  function minAbs(a,b){ return Math.abs(a-b); }

  // Rule set from document:
  // 1) Tr√πng Bƒê: c√πng ph√∫t Bƒê v√† TR√ôNG m√°y
  // 2) Tr√πng KT: same end minute (any)
  // 3) Duration < 6 minutes
  function violatesAnyError(candidate, originalRow, allXqRows){
    const m0 = (originalRow.maMay||"").trim().toUpperCase();
    // duration
    const dur = (candidate.start && candidate.end) ? Math.round((candidate.end - candidate.start)/60000) : null;
    if(dur != null && dur < 6) return true;

    // start duplicate (same machine)
for(const r of allXqRows){
  if(r.rownum === originalRow.rownum) continue;
  if(!r.start || !candidate.start) continue;
  if(sameMinute(r.start, candidate.start)){
    const mx = (r.maMay||"").trim().toUpperCase();
    if(m0 && mx && mx === m0) return true;
  }
}
// end duplicate (any)
for(const r of allXqRows){
  if(r.rownum === originalRow.rownum) continue;
  if(!r.end || !candidate.end) continue;
  if(sameMinute(r.end, candidate.end)) return true;
}
return false;
  }

  function computeFixSuggestions(row, allXqRows){
    const S0 = row.start, E0 = row.end;
    const ylenh = row.ylenh;   // must be > ylenh
    const ngayRa = row.ngayRa; // must be < ngayRa

    const note = [];
    if(!S0 || !E0) note.push("Thi·∫øu Bƒê/KT g·ªëc ‚Üí ch·ªâ ƒë·ªÅ xu·∫•t theo ph·∫ßn c√≥ d·ªØ li·ªáu.");
    if(!ylenh) note.push("Kh√¥ng c√≥ c·ªôt 'Ng√†y y l·ªánh/Ng√†y v√†o' ‚Üí kh√¥ng th·ªÉ ƒë·∫£m b·∫£o ƒëi·ªÅu ki·ªán > Ng√†y y l·ªánh.");
    if(!ngayRa) note.push("Kh√¥ng c√≥ c·ªôt 'Ng√†y ra' ‚Üí kh√¥ng th·ªÉ ƒë·∫£m b·∫£o ƒëi·ªÅu ki·ªán < Ng√†y ra.");

    // If missing bounds, still suggest within what we have, but warn.
    const lower = ylenh || addMinutes(S0, -999999); // very low
    const upper = ngayRa || addMinutes(E0 || S0, 999999); // very high

    const dur0 = (S0 && E0) ? Math.round((E0 - S0)/60000) : 6;
    const baseDur = Math.max(6, dur0);

    // shift order: 0, +1, -1, +2, -2, ...
    const shifts = [];
    for(let i=0;i<=60;i++){
      if(i===0) shifts.push(0);
      else { shifts.push(i); shifts.push(-i); }
    }

    const endAdjust = [];
    for(let j=0;j<=30;j++){
      if(j===0) endAdjust.push(0);
      else { endAdjust.push(j); endAdjust.push(-j); }
    }

    const cand = [];
    const seen = new Set();

    for(const ds of shifts){
      if(!S0) break;
      const s = addMinutes(S0, ds);
      // must be > lower (strict) and < upper
      if(ylenh && s <= lower) continue;
      if(s >= upper) continue;

      // try keep duration close: end = s + baseDur (+ small adjust)
      for(const de of endAdjust){
        const dur = Math.max(6, baseDur + de);
        const e = addMinutes(s, dur);
        if(!e) continue;
        if(ngayRa && e >= upper) continue;
        if(e <= s) continue;

        const candidate = {start:s, end:e};
        if(violatesAnyError(candidate, row, allXqRows)) continue;

        const sig = Math.floor(s.getTime()/60000) + "|" + Math.floor(e.getTime()/60000);
        if(seen.has(sig)) continue;
        seen.add(sig);

        // scoring: closest to original S0 & E0 (absolute minutes)
        const score = (S0 ? Math.abs(Math.round((s - S0)/60000)) : 9999) + (E0 ? Math.abs(Math.round((e - E0)/60000)) : 9999) + Math.abs(dur - dur0)*0.2;
        cand.push({start:s, end:e, dur, score});
        if(cand.length >= 40) break;
      }
      if(cand.length >= 40) break;
    }

    cand.sort((a,b)=>a.score - b.score);
    return { list: cand.slice(0, 15), note: note.join("\n") };
  }

  function openFixModal(){ 
    if($id("fixBackdrop")) $id("fixBackdrop").style.display = "block";
    if($id("fixModal")) $id("fixModal").style.display = "flex";
  }
  function closeFixModal(){
    if($id("fixBackdrop")) $id("fixBackdrop").style.display = "none";
    if($id("fixModal")) $id("fixModal").style.display = "none";
  }

  function fmtLocal(dt){
    return (typeof fmt === "function") ? fmt(dt) : (dt ? dt.toLocaleString() : "");
  }

  function renderFix(){
    const st = (window.__fixState || __fixState);
    const s = st.list[st.idx];
    __fixState = st;
    const noteBox = document.getElementById("fixNote");

    if(!__fixState.list.length){
      document.getElementById("fixSuggest").textContent = "Kh√¥ng t√¨m ƒë∆∞·ª£c th·ªùi gian ph√π h·ª£p theo r√†ng bu·ªôc.";
      document.getElementById("fixDelta").textContent = "‚Äî";
      noteBox.style.display = "block";
      noteBox.textContent = "G·ª£i √Ω: Ki·ªÉm tra l·∫°i c·ªôt 'Ng√†y y l·ªánh/Ng√†y v√†o' v√† 'Ng√†y ra', ho·∫∑c d·ªØ li·ªáu c√≥ qu√° nhi·ªÅu ca tr√πng ph√∫t khi·∫øn kh√¥ng c√≥ kho·∫£ng tr·ªëng h·ª£p l·ªá.";
      return;
    }

    const row = window.__rowIndex?.get(__fixState.rownum);
    const S0 = row?.start, E0 = row?.end;
    const dS = (S0 && s.start) ? Math.round((s.start - S0)/60000) : null;
    const dE = (E0 && s.end) ? Math.round((s.end - E0)/60000) : null;

    document.getElementById("fixSuggest").textContent = `Bƒê: ${fmtLocal(s.start)}  |  KT: ${fmtLocal(s.end)}  |  Ph√∫t: ${s.dur}`;
    document.getElementById("fixDelta").textContent = `ŒîBƒê: ${dS==null?"‚Äî":(dS>=0?"+":"")+dS}p  |  ŒîKT: ${dE==null?"‚Äî":(dE>=0?"+":"")+dE}p`;

    if(window.__fixNoteText){
      noteBox.style.display = "block";
      noteBox.textContent = window.__fixNoteText;
    }else{
      noteBox.style.display = "none";
      noteBox.textContent = "";
    }
  }

  // Build row index for modal lookup (from xqRows)
  function rebuildRowIndex(){
    window.__rowIndex = new Map();
    if(Array.isArray(window.xqRows)){
      for(const r of window.xqRows){
        window.__rowIndex.set(r.rownum, r);
      }
    }
  }

  // Hook after analysis to rebuild index
  const __origRunAnalysis = window.runAnalysis;
  if(typeof __origRunAnalysis === "function"){
    window.runAnalysis = function(){
      __origRunAnalysis();
      rebuildRowIndex();
    }
  }

  // Click on error row => show suggestions
  document.addEventListener("click", (ev)=>{
    const tr = ev.target?.closest?.("tr.err-row");
    if(!tr) return;
    let rownum = parseInt(tr.getAttribute("data-rownum"),10);
    // fallbackRowNumFromCells: n·∫øu thi·∫øu data-rownum, th·ª≠ ƒë·ªçc c·ªôt "D√≤ng"
    if(!rownum){
      const mono = tr.querySelector(".mono");
      const m = mono ? String(mono.textContent||"").match(/\b(\d{1,7})\b/) : null;
      if(m) rownum = parseInt(m[1],10);
    }
    const errtype = tr.getAttribute("data-errtype") || "";
    if(!rownum) return;
    if(!window.__rowIndex){
      window.__rowIndex = new Map();
      if(Array.isArray(window.xqRows)) for(const r of window.xqRows){ window.__rowIndex.set(r.rownum, r); }
    }

    let row = window.__rowIndex.get(rownum);
    if(!row){
      try{ if(typeof rebuildRowIndex==='function') rebuildRowIndex(); }catch(e){}
      row = window.__rowIndex.get(rownum);
    }
    if(!row) return;

    const boundsText = `> Ng√†y y l·ªánh: ${fmtLocal(row.ylenh)}  |  < Ng√†y ra: ${fmtLocal(row.ngayRa)}`;
    const origText = `Bƒê: ${fmtLocal(row.start)}  |  KT: ${fmtLocal(row.end)}`;
    document.getElementById("fixCaseInfo").textContent = `D√≤ng: ${rownum}  |  M√°y: ${(row.maMay||"").trim().toUpperCase() || "‚Äî"}  |  M√£ KCB: ${row.maKCB||"‚Äî"}`;
    document.getElementById("fixErrType").textContent = errtype || "‚Äî";
    document.getElementById("fixBounds").textContent = boundsText;
    document.getElementById("fixOriginal").textContent = origText;

    const res = computeFixSuggestions(row, window.xqRows || []);
    __fixState = { list: res.list, idx: 0, rownum };
    window.__fixState = __fixState;
    window.__fixNoteText = res.note || "";

    renderFix();
    openFixModal();
  });

  // Buttons
  if($id("btnFixClose")) $id("btnFixClose").addEventListener("click", closeFixModal);
  if($id("btnFixClose2")) $id("btnFixClose2").addEventListener("click", closeFixModal);
  if($id("fixBackdrop")) $id("fixBackdrop").addEventListener("click", closeFixModal);

  if($id("btnFixNext")) $id("btnFixNext").addEventListener("click", ()=>{
    if(!__fixState.list.length) return;
    __fixState.idx = (__fixState.idx + 1) % __fixState.list.length;
    window.__fixState = __fixState;
    renderFix();
  });

  if($id("btnFixCopy")) $id("btnFixCopy").addEventListener("click", async ()=>{
    if(!__fixState.list.length) return;
    const st = (window.__fixState || __fixState);
    const s = st.list[st.idx];
    __fixState = st;
    const txt = `DeXuatThoiGian
Bƒê: ${fmtLocal(s.start)}
KT: ${fmtLocal(s.end)}
Ph√∫t: ${s.dur}`;
    try{
      await navigator.clipboard.writeText(txt);
      // quick toast via diagBox if exists
      if(typeof showDiag === "function"){
        showDiag("ƒê√£ copy ƒë·ªÅ xu·∫•t v√†o clipboard.", "warning");
        setTimeout(()=>{ try{ hideDiag(); }catch(e){} }, 1200);
      }
    }catch(e){
      alert("Kh√¥ng copy ƒë∆∞·ª£c. H√£y copy th·ªß c√¥ng: " + txt);
    }
  });

  // Esc closes modal
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      const m = document.getElementById("fixModal");
      if(m && m.style.display === "block") closeFixModal();
    }
  });


</script>




<script>
  // ===== Apply suggestion + Applied list =====
  window.__appliedFixes = window.__appliedFixes || [];

  function renderAppliedFixes(){
    const tb = document.getElementById("appliedFixesBody");
    if(!tb) return;
    const list = window.__appliedFixes || [];
    if(!list.length){
      tb.innerHTML = '<tr><td colspan="6" style="padding:10px;color:#64748b;">Ch∆∞a c√≥ ch·ªânh s·ª≠a n√†o.</td></tr>';
      updateFixFooterUI();
      return;
    }
    tb.innerHTML = list.slice().reverse().map(it => {
      const bdOld = it.oldStart || "‚Äî";
      const bdNew = it.newStart || "‚Äî";
      const ktOld = it.oldEnd || "‚Äî";
      const ktNew = it.newEnd || "‚Äî";
      return `
        <tr style="border-top:1px solid #eef2f7;">
          <td style="padding:8px 10px;white-space:nowrap;font-weight:900;">${it.rownum}</td>
          <td style="padding:8px 10px;white-space:nowrap;">${esc2(it.machine||"")}</td>
          <td style="padding:8px 10px;white-space:nowrap;">${esc2(it.maKCB||"")}</td>
          <td style="padding:8px 10px;white-space:nowrap;" class="mono">${esc2(bdOld)} ‚Üí <b>${esc2(bdNew)}</b></td>
          <td style="padding:8px 10px;white-space:nowrap;" class="mono">${esc2(ktOld)} ‚Üí <b>${esc2(ktNew)}</b></td>
          <td style="padding:8px 10px;white-space:nowrap;color:#475569;">${esc2(it.appliedAt||"")}</td>
        </tr>
      `;
    }).join("");
    updateFixFooterUI();
  }

  function updateFixFooterUI(){
    const list = window.__appliedFixes || [];
    const n = Array.isArray(list) ? list.length : 0;

    const status = document.getElementById("fixFooterStatus");
    if(status){
      status.textContent = n ? `‚úî ƒê√£ ch·ªânh: ${n} ca` : "‚Ñπ Ch∆∞a c√≥ ch·ªânh s·ª≠a";
    }

    const btnExp = document.getElementById("btnFixExportApplied");
    if(btnExp){
      btnExp.disabled = !n;
      btnExp.style.opacity = n ? "1" : ".6";
      btnExp.style.cursor = n ? "pointer" : "not-allowed";
      btnExp.setAttribute("aria-disabled", n ? "false" : "true");
    }

    // ƒê·ªìng b·ªô n√∫t tab "‚úÖ Xu·∫•t DS ƒë√£ ch·ªânh"
    const tabBtn = document.getElementById("btnDownloadAppliedXLSX");
    if(tabBtn){
      const ok = !!n;
      tabBtn.style.opacity = ok ? "1" : ".65";
      tabBtn.style.cursor = ok ? "pointer" : "not-allowed";
      tabBtn.setAttribute("aria-disabled", ok ? "false" : "true");
    }
  }


  function applyFixSuggestionImpl(){
    try{ if(typeof showDiag==='function') showDiag('ƒêang √°p d·ª•ng th·ªùi gian ƒë·ªÅ xu·∫•t...', 'warning'); }catch(e){}

    if(!window.__fixState || !window.__fixState.list || !window.__fixState.list.length){
      if(typeof showDiag==="function") showDiag("Kh√¥ng c√≥ ƒë·ªÅ xu·∫•t h·ª£p l·ªá ƒë·ªÉ √°p d·ª•ng.", "warning");
      return;
    }
    const pick = window.__fixState.list[window.__fixState.idx || 0];
    const rownum = window.__fixState.rownum;

    if(!window.__rowIndex){
      window.__rowIndex = new Map();
      if(Array.isArray(window.xqRows)) for(const r of window.xqRows){ window.__rowIndex.set(r.rownum, r); }
    }
    const row = window.__rowIndex.get(rownum);
    if(!row){
      if(typeof showDiag==="function") showDiag("Kh√¥ng t√¨m th·∫•y d√≤ng d·ªØ li·ªáu ƒë·ªÉ √°p d·ª•ng.", "warning");
      return;
    }

    const oldStart = row.start ? fmtLocal(row.start) : "‚Äî";
    const oldEnd   = row.end   ? fmtLocal(row.end)   : "‚Äî";

    // Update in-memory times
    row.start = pick.start;
    row.end   = pick.end;

    // L∆∞u ch·ªânh s·ª≠a ƒë√£ x√°c nh·∫≠n (ƒë·ªÉ l·∫ßn b·∫•m PH√ÇN T√çCH sau v·∫´n gi·ªØ)
    window.__confirmedEdits = window.__confirmedEdits || new Map();
    window.__confirmedEdits.set(rownum, {
      start_ms: pick.start.getTime(),
      end_ms: pick.end.getTime(),
      updated_at: Date.now()
    });
    try{ saveConfirmedEdits(); }catch(e){}
    // verify saved
    try{ const _t = localStorage.getItem(CONFIRMED_EDITS_KEY); if(!_t) throw new Error('localStorage empty'); }catch(e){ console.warn(e); }
    try{ if(typeof showDiag==='function') showDiag('‚úÖ ƒê√£ √°p d·ª•ng & l∆∞u ch·ªânh s·ª≠a. B·∫•m PH√ÇN T√çCH ƒë·ªÉ t√≠nh l·∫°i s·ªë l·ªói.', 'ok'); }catch(e){}

    // Also update in xqRows array (same reference usually; but ensure)
    if(Array.isArray(window.xqRows)){
      const idx = window.xqRows.findIndex(x => x.rownum === rownum);
      if(idx >= 0) window.xqRows[idx] = row;
    }

    const machine = (row.maMay||"").trim().toUpperCase();
    const maKCB = row.maKCB || "";

    window.__appliedFixes.push({
      rownum,
      machine,
      maKCB,
      oldStart,
      oldEnd,
      newStart: fmtLocal(pick.start),
      newEnd: fmtLocal(pick.end),
      appliedAt: new Date().toLocaleString()
    });

    renderAppliedFixes();

    // Rerun analysis so next suggestions avoid conflicts created by this change
    if(typeof runAnalysis === "function"){
      try{ runAnalysis(); }catch(e){ console.error(e); }
    }

    if(typeof showDiag==="function"){
      showDiag("ƒê√£ √°p d·ª•ng th·ªùi gian ƒë·ªÅ xu·∫•t v√† c·∫≠p nh·∫≠t l·∫°i ph√¢n t√≠ch.", "ok");
      setTimeout(()=>{ try{ hideDiag(); }catch(e){} }, 1200);
    }

    // Close modal to encourage picking next error
    try{ closeFixModal(); }catch(e){}
  }

  // Bind buttons
  (function(){
    const btn = document.getElementById("btnFixApply");
    if(btn) btn.addEventListener("click", applyFixSuggestion);

    const btnExp = document.getElementById("btnFixExportApplied");
    if(btnExp && !btnExp.__bound){
      btnExp.addEventListener("click", ()=>{
        if(btnExp.disabled) return;
        if(typeof downloadAppliedFixesXLSX === "function") downloadAppliedFixesXLSX();
      });
      btnExp.__bound = true;
    }

    const c1 = document.getElementById("btnFixClose");
    if(c1) c1.addEventListener("click", ()=>{ try{ closeFixModal(); }catch(e){} });

    const c2 = document.getElementById("btnFixClose2");
    if(c2) c2.addEventListener("click", ()=>{ try{ closeFixModal(); }catch(e){} });

    try{ updateFixFooterUI(); }catch(e){}

    const tgl = document.getElementById("btnToggleApplied");
    const wrap = document.getElementById("appliedFixesWrap");
    if(tgl && wrap){
      tgl.addEventListener("click", ()=>{
        wrap.style.display = (wrap.style.display === "none") ? "block" : "none";
      });
    }
  })();

  // When modal opens (renderFix), refresh applied list
  const __origOpenFixModal = (typeof openFixModal === "function") ? openFixModal : null;
  if(__origOpenFixModal){
    window.openFixModal = function(){
      renderAppliedFixes();
      __origOpenFixModal();
    }
  }
</script>
<script>
  // ===== bindFixModalButtons_v2: ƒë·∫£m b·∫£o n√∫t √Åp d·ª•ng ho·∫°t ƒë·ªông d√π script ch·∫°y s·ªõm/mu·ªôn =====
  function bindFixModalButtons_v2(){
    const btnApply = document.getElementById("btnFixApply");
    if(btnApply && !btnApply.__bound){
      btnApply.addEventListener("click", ()=>{
        try{ window.applyFixSuggestion && window.applyFixSuggestion(); }catch(e){ console.error(e); alert("L·ªói khi √°p d·ª•ng: " + (e?.message||e)); }
      });
      btnApply.__bound = true;
    }
    const btnToggle = document.getElementById("btnToggleApplied");
    const wrap = document.getElementById("appliedFixesWrap");
    if(btnToggle && wrap && !btnToggle.__bound){
      btnToggle.addEventListener("click", ()=>{
        wrap.style.display = (wrap.style.display === "none") ? "block" : "none";
      });
      btnToggle.__bound = true;
    }
  }

  document.addEventListener("DOMContentLoaded", bindFixModalButtons_v2);

  // Rebind every time modal opens
  if(typeof openFixModal === "function"){
    const __open = openFixModal;
    window.openFixModal = function(){
      bindFixModalButtons_v2();
      return __open();
    };
  }
</script>
<script>
  function setApplyStatus(text, color){
    const el = document.getElementById("fixApplyStatus");
    if(!el) return;
    el.textContent = text;
    if(color) el.style.color = color;
  }
  // Hook into global apply
  if(window.applyFixSuggestion){
    const __oldApply = window.applyFixSuggestion;
    window.applyFixSuggestion = function(){
      setApplyStatus("‚è≥ ƒêang √°p d·ª•ng...", "#d97706");
      try{
        const r = __oldApply();
        setTimeout(()=>setApplyStatus("‚úÖ ƒê√£ √°p d·ª•ng", "#16a34a"), 50);
        return r;
      }catch(e){
        setApplyStatus("‚ùå L·ªói √°p d·ª•ng", "#dc2626");
        throw e;
      }
    }
  }
</script>
<script>
  // ===== FINAL APPLY OVERRIDE (v16) =====
  (function(){
    function $id(x){ return document.getElementById(x); }
    function setStatus(t, c){
      const el = $id("fixApplyStatus");
      if(!el) return;
      el.textContent = t;
      if(c) el.style.color = c;
    }
    function fmtLocal2(dt){
      try{ return (typeof fmt === "function") ? fmt(dt) : (dt?dt.toLocaleString(): ""); }catch(e){ return dt?dt.toLocaleString():""; }
    }
    function esc(s){
      try{ return (typeof escapeHtml==="function") ? escapeHtml(s) : String(s??""); }catch(e){ return String(s??""); }
    }
    const KEY = "bv_xq_confirmed_edits_v1";
    function saveEdits(map){
      try{
        const arr = Array.from(map.entries()).map(([rownum,v])=>({rownum, start_ms:v.start_ms, end_ms:v.end_ms, updated_at:v.updated_at||Date.now()}));
        localStorage.setItem(KEY, JSON.stringify(arr));
      }catch(e){ console.warn(e); }
    }
    function ensureIndex(){
      if(!window.__rowIndex){
        window.__rowIndex = new Map();
        if(Array.isArray(window.xqRows)) for(const r of window.xqRows){ window.__rowIndex.set(r.rownum, r); }
      }
    }
    function appendAppliedRow(item){
      const tb = $id("appliedFixesBody");
      if(!tb) return;
      // if placeholder row exists, clear
      if(tb.querySelector("td[colspan]")) tb.innerHTML = "";
      const tr = document.createElement("tr");
      tr.style.borderTop = "1px solid #eef2f7";
      tr.innerHTML = `
        <td style="padding:8px 10px;white-space:nowrap;font-weight:900;">${item.rownum}</td>
        <td style="padding:8px 10px;white-space:nowrap;">${esc(item.machine||"")}</td>
        <td style="padding:8px 10px;white-space:nowrap;">${esc(item.maKCB||"")}</td>
        <td style="padding:8px 10px;white-space:nowrap;" class="mono">${esc(item.oldStart)} ‚Üí <b>${esc(item.newStart)}</b></td>
        <td style="padding:8px 10px;white-space:nowrap;" class="mono">${esc(item.oldEnd)} ‚Üí <b>${esc(item.newEnd)}</b></td>
        <td style="padding:8px 10px;white-space:nowrap;color:#475569;">${esc(item.appliedAt)}</td>
      `;
      // add to top
      tb.insertBefore(tr, tb.firstChild);
    }

    window.applyFixSuggestion = function(){
      try{
        setStatus("‚è≥ ƒêang √°p d·ª•ng...", "#d97706");
        const st = window.__fixState || window.__fixState || __fixState;
        if(!st || !st.list || !st.list.length) throw new Error("Ch∆∞a c√≥ ƒë·ªÅ xu·∫•t h·ª£p l·ªá.");
        const pick = st.list[st.idx || 0];
        const rownum = st.rownum;
        if(!rownum) throw new Error("Thi·∫øu rownum.");
        ensureIndex();
        const row = window.__rowIndex.get(rownum);
        if(!row) throw new Error("Kh√¥ng t√¨m th·∫•y d√≤ng d·ªØ li·ªáu ƒë·ªÉ √°p d·ª•ng (rownum=" + rownum + ").");

        const oldStart = row.start ? fmtLocal2(row.start) : "‚Äî";
        const oldEnd = row.end ? fmtLocal2(row.end) : "‚Äî";

        // apply
        row.start = pick.start;
        row.end = pick.end;

        // persist to confirmed edits
        window.__confirmedEdits = window.__confirmedEdits || new Map();
        window.__confirmedEdits.set(rownum, { start_ms: pick.start.getTime(), end_ms: pick.end.getTime(), updated_at: Date.now() });
        saveEdits(window.__confirmedEdits);

        // update applied list
        const item = {
          rownum,
          machine: (row.maMay||"").trim().toUpperCase(),
          maKCB: row.maKCB || "",
          oldStart,
          oldEnd,
          newStart: fmtLocal2(pick.start),
          newEnd: fmtLocal2(pick.end),
          appliedAt: new Date().toLocaleString()
        };
        window.__appliedFixes = window.__appliedFixes || [];
        window.__appliedFixes.push(item);
        appendAppliedRow(item);

        // re-run analysis
        if(typeof runAnalysis === "function"){
          try{ runAnalysis(); }catch(e){ console.error(e); }
        }

        setStatus("‚úÖ ƒê√£ √°p d·ª•ng", "#16a34a");
      }catch(err){
        console.error(err);
        setStatus("‚ùå L·ªói √°p d·ª•ng", "#dc2626");
        alert("√Åp d·ª•ng th·∫•t b·∫°i: " + (err?.message || err));
      }
    };

    // Ensure button click wired even if onclick lost
    function wire(){
      const btn = $id("btnFixApply");
      if(btn && !btn.__wired){
        btn.addEventListener("click", ()=>window.applyFixSuggestion());
        btn.__wired = true;
      }
    }
    document.addEventListener("DOMContentLoaded", wire);
    // Also try now
    wire();
  })();
  // ===== END FINAL APPLY OVERRIDE =====
</script>
<script>
  // Stub ƒë·ªÉ tr√°nh l·ªói ReferenceError n·∫øu c√≤n ch·ªó n√†o g·ªçi applyFixSuggestionImpl
  if(typeof applyFixSuggestionImpl === "undefined"){
    function applyFixSuggestionImpl(){
      if(window.applyFixSuggestion) return window.applyFixSuggestion();
      throw new Error("applyFixSuggestion ch∆∞a s·∫µn s√†ng");
    }
  }
</script>
<script>
  // Alias ƒë·ªÉ t∆∞∆°ng th√≠ch c√°c ch·ªó c√≤n g·ªçi applyFixSuggestion()
  if(typeof applyFixSuggestion === "undefined"){
    function applyFixSuggestion(){
      return (window.applyFixSuggestion) ? window.applyFixSuggestion() : undefined;
    }
  }
</script>
<script>
  function downloadAppliedFixesXLSX(){
    try{
      if(typeof XLSX === "undefined"){
        alert("Ch∆∞a c√≥ th∆∞ vi·ªán XLSX. H√£y ƒë·∫∑t file xlsx.full.min.js c√πng th∆∞ m·ª•c v√† t·∫£i l·∫°i trang.");
        return;
      }
      const list = (window.__appliedFixes && Array.isArray(window.__appliedFixes)) ? window.__appliedFixes : [];
      if(!list.length){
        alert("Ch∆∞a c√≥ ch·ªânh s·ª≠a n√†o ƒë·ªÉ t·∫£i.");
        return;
      }

      const rows = list.map((it, idx)=>({
        "STT": idx + 1,
        "D√≤ng": it.rownum ?? "",
        "M√°y": it.machine ?? "",
        "M√£ KCB": it.maKCB ?? "",
        "Bƒê c≈©": it.oldStart ?? "",
        "Bƒê m·ªõi": it.newStart ?? "",
        "KT c≈©": it.oldEnd ?? "",
        "KT m·ªõi": it.newEnd ?? "",
        "L√∫c √°p d·ª•ng": it.appliedAt ?? ""
      }));

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows, {skipHeader:false});

      const colKeys = Object.keys(rows[0] || {});
      ws["!cols"] = colKeys.map(k=>{
        let w = k.length;
        for(const r of rows){
          const v = String(r[k] ?? "");
          if(v.length > w) w = Math.min(60, v.length);
        }
        return { wch: w + 2 };
      });

      XLSX.utils.book_append_sheet(wb, ws, "DS_da_sua");

      const pad = (n)=> String(n).padStart(2,"0");
      const d = new Date();
      const fname = `BVST_DS_da_sua_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}.xlsx`;
      XLSX.writeFile(wb, fname);
    }catch(err){
      console.error(err);
      alert("Kh√¥ng xu·∫•t ƒë∆∞·ª£c Excel: " + (err?.message || err));
    }
  }

  (function(){
    const btn = document.getElementById("btnDownloadAppliedXLSX");
    if(btn && !btn.__bound){
      btn.addEventListener("click", downloadAppliedFixesXLSX);
      btn.__bound = true;
    }
  })();
</script>
<script>
  function updateDownloadBtnState(){
    const btn = document.getElementById("btnDownloadAppliedXLSX");
    if(!btn) return;
    const list = (window.__appliedFixes && Array.isArray(window.__appliedFixes)) ? window.__appliedFixes : [];
    const has = list.length > 0;

    if(has){
      btn.setAttribute("aria-disabled","false");
      btn.style.opacity = "1";
      btn.style.cursor = "pointer";
      btn.style.background = "#16a34a";
      btn.style.border = "1px solid #15803d";
      btn.style.color = "#ffffff";
      btn.textContent = "‚úÖ Xu·∫•t DS ƒë√£ ch·ªânh";
    }else{
      btn.setAttribute("aria-disabled","true");
      btn.style.opacity = ".65";
      btn.style.cursor = "not-allowed";
      btn.style.background = "#dcfce7";
      btn.style.border = "1px solid #22c55e";
      btn.style.color = "#065f46";
      btn.textContent = "‚úÖ Xu·∫•t DS ƒë√£ ch·ªânh";
    }
  }

  // Call once on load
  document.addEventListener("DOMContentLoaded", updateDownloadBtnState);

  // Patch apply to update button state after apply
  (function(){
    const oldApply = window.applyFixSuggestion;
    if(typeof oldApply === "function" && !oldApply.__patchedBtn){
      window.applyFixSuggestion = function(){
        const r = oldApply();
        try{ updateDownloadBtnState(); }catch(e){}
        return r;
      };
      window.applyFixSuggestion.__patchedBtn = true;
    }
  })();

  // Also update after analysis (some users reload saved edits)
  (function(){
    const oldRun = window.runAnalysis;
    if(typeof oldRun === "function" && !oldRun.__patchedBtn){
      window.runAnalysis = function(){
        const r = oldRun.apply(this, arguments);
        try{ updateDownloadBtnState(); }catch(e){}
        return r;
      };
      window.runAnalysis.__patchedBtn = true;
    }
  })();
</script>
<script>
  function bindDownloadAppliedTabBtn(){
    const btn = document.getElementById("btnDownloadAppliedXLSX");
    if(!btn || btn.__bound) return;
    btn.addEventListener("click", ()=>{
      if(btn.getAttribute("aria-disabled")==="true" || btn.style.cursor==="not-allowed") return;
      if(typeof downloadAppliedFixesXLSX === "function") downloadAppliedFixesXLSX();
      else alert("Thi·∫øu h√†m xu·∫•t Excel.");
    });
    btn.__bound = true;
  }
  document.addEventListener("DOMContentLoaded", bindDownloadAppliedTabBtn);
  try{ bindDownloadAppliedTabBtn(); }catch(e){}
</script>
</body>
</html>
