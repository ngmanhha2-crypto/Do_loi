<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>L·ªçc l·ªói th·ªùi gian X-quang (Excel/CSV ‚Üí Web)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --accent: #5eead4;
      --accent2:#60a5fa;
      --warn: #fbbf24;
      --danger: #fb7185;
      --ok: #34d399;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius: 18px;
    }
    body{
      min-height: 100vh;
      color: var(--text);
      background:
        radial-gradient(1200px 500px at 10% 10%, rgba(96,165,250,.25), transparent 60%),
        radial-gradient(900px 450px at 90% 20%, rgba(94,234,212,.18), transparent 55%),
        radial-gradient(900px 450px at 30% 90%, rgba(251,113,133,.12), transparent 55%),
        linear-gradient(180deg, #050812 0%, #0b1220 45%, #0b1220 100%);
    }
    .app-shell{max-width:1280px;margin:0 auto;padding:28px 16px 40px;}
    .topbar{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;user-select:none;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(94,234,212,.85), rgba(96,165,250,.55)),
                  linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.02));
      box-shadow: 0 10px 28px rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.18);
      position:relative;overflow:hidden;
    }
    .logo:after{content:"";position:absolute;inset:-30%;background:radial-gradient(circle at 40% 30%, rgba(255,255,255,.25), transparent 55%);transform:rotate(20deg);}
    .brand h1{margin:0;font-size:1.15rem;font-weight:850;letter-spacing:.2px;line-height:1.1;}
    .brand .sub{margin:0;color:var(--muted);font-size:.88rem;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
      border:1px solid var(--stroke);background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.82);backdrop-filter:blur(10px);
      box-shadow:0 10px 26px rgba(0,0,0,.22);font-size:.86rem;white-space:nowrap;
    }
    .chip b{color:#fff;font-weight:800;}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px;}
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
    .glass{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius:var(--radius);box-shadow:var(--shadow);backdrop-filter:blur(12px);
    }
    .cardx{padding:18px;}
    .section-title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;flex-wrap:wrap;}
    .section-title h2{font-size:1.02rem;font-weight:850;margin:0;letter-spacing:.2px;}
    .section-title .hint{color:var(--muted);font-size:.86rem;margin:0;}
    .divider{height:1px;background:linear-gradient(90deg, transparent, rgba(255,255,255,.15), transparent);margin:14px 0;}
    .form-label{color:rgba(255,255,255,.85);font-weight:700;font-size:.88rem;margin-bottom:6px;}
    .form-text{color:rgba(255,255,255,.55)!important;}
    .form-control,.form-select{
      background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.16);
      color:rgba(255,255,255,.92);border-radius:14px;padding:10px 12px;
    }
    .form-control:focus,.form-select:focus{
      background:rgba(0,0,0,.30);border-color:rgba(94,234,212,.55);
      box-shadow:0 0 0 .25rem rgba(94,234,212,.15);color:rgba(255,255,255,.95);
    }
    .form-select option{color:#111;}
    .switchline{display:flex;flex-wrap:wrap;gap:14px;padding:10px 12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);border-radius:14px;}
    .form-check-input{cursor:pointer;background-color:rgba(255,255,255,.15);border-color:rgba(255,255,255,.25);}
    .form-check-input:checked{background-color:rgba(94,234,212,.9);border-color:rgba(94,234,212,.9);}
    .form-check-label{cursor:pointer;color:rgba(255,255,255,.82);font-weight:650;font-size:.88rem;}

    .btn{border-radius:14px;font-weight:800;letter-spacing:.2px;padding:10px 14px;border:1px solid rgba(255,255,255,.14);}
    .btn-primary{background:linear-gradient(135deg, rgba(94,234,212,.95), rgba(96,165,250,.90));border:0;color:#07111c;box-shadow:0 14px 40px rgba(96,165,250,.18);}
    .btn-primary:hover{filter:brightness(1.02);transform:translateY(-1px);}
    .btn:disabled{opacity:.55!important;cursor:not-allowed;transform:none!important;}
    .btn-outline-light{color:rgba(255,255,255,.92);border-color:rgba(255,255,255,.18);background:rgba(255,255,255,.04);}
    .btn-outline-light:hover{background:rgba(255,255,255,.07);border-color:rgba(255,255,255,.22);}
    .btn-success{background:linear-gradient(135deg, rgba(52,211,153,.95), rgba(94,234,212,.75));border:0;color:#07111c;}
    .btn-outline-warning{color:rgba(255,255,255,.92);border-color:rgba(251,191,36,.40);background:rgba(251,191,36,.08);}
    .btn-outline-warning:hover{background:rgba(251,191,36,.13);border-color:rgba(251,191,36,.55);}

    .kpi-wrap{display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;}
    @media(max-width:900px){.kpi-wrap{grid-template-columns:repeat(2,1fr);}}
    .kpi-box{padding:14px 14px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);}
    .kpi-box .lab{color:var(--muted);font-size:.82rem;font-weight:700;margin-bottom:6px;}
    .kpi-box .val{font-size:1.8rem;font-weight:900;line-height:1;letter-spacing:.2px;}
    .kpi-box .tag{margin-top:8px;display:inline-flex;gap:8px;align-items:center;font-size:.82rem;color:rgba(255,255,255,.72);}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.25);display:inline-block;}
    .dot.ok{background:var(--ok);} .dot.warn{background:var(--warn);} .dot.danger{background:var(--danger);}

    .alertx{border-radius:16px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);padding:12px 14px;color:rgba(255,255,255,.86);white-space:pre-wrap;}
    .alertx.warning{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.08);}
    .alertx.danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10);}

    .table-wrap{border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.20);overflow:hidden;}
    .table{margin:0;color:rgba(255,255,255,.88);}
    .table thead th{
      position:sticky;top:0;z-index:2;background:rgba(10,18,32,.92);
      border-bottom:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.85);font-size:.82rem;white-space:nowrap;
    }
    .table td{border-top:1px solid rgba(255,255,255,.08);vertical-align:middle;font-size:.88rem;}
    .rowerr{background:rgba(251,191,36,.06);}
    .badge-soft{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);font-weight:900;font-size:.78rem;white-space:nowrap;
    }
    .badge-soft.warn{border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.09);}
    .badge-soft.danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10);}
    .badge-soft.ok{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.10);}

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:.86rem;}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;}
    .toolbar .left,.toolbar .right{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .small-muted{color:var(--muted);font-size:.85rem;}
    .pulse{animation:pulse .35s ease-out;}
    @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.015);}100%{transform:scale(1);}}
    .table-responsive{max-height:58vh;}
    .table-responsive::-webkit-scrollbar{height:10px;width:10px;}
    .table-responsive::-webkit-scrollbar-thumb{background:rgba(255,255,255,.14);border-radius:999px;}
    .table-responsive::-webkit-scrollbar-track{background:rgba(255,255,255,.04);}

    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      padding:8px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }
    .tabbtn{
      padding:8px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18); color: rgba(255,255,255,.85);
      font-weight:900; font-size:.86rem; cursor:pointer;
      user-select:none;
    }
    .tabbtn.active{
      background: linear-gradient(135deg, rgba(94,234,212,.30), rgba(96,165,250,.22));
      border-color: rgba(94,234,212,.35);
      color:#fff;
    }
    .hidden{display:none!important;}

    .accordion-item{
      border-radius: 16px!important;
      border:1px solid rgba(255,255,255,.12)!important;
      background: rgba(0,0,0,.18)!important;
      overflow:hidden;
    }
    .accordion-button{
      background: rgba(255,255,255,.04)!important;
      color: rgba(255,255,255,.90)!important;
      font-weight: 900;
    }
    .accordion-button:not(.collapsed){
      background: linear-gradient(135deg, rgba(94,234,212,.16), rgba(96,165,250,.12))!important;
      color:#fff!important;
      box-shadow:none!important;
    }
    .accordion-body{color:rgba(255,255,255,.85);}
    .accordion-button:focus{box-shadow:0 0 0 .25rem rgba(94,234,212,.12)!important;}

    /* PRINT / PDF */
    @media print{
      body{background:#fff;color:#111;}
      .glass{box-shadow:none!important;border:1px solid #ddd!important;background:#fff!important;}
      .chip, .tabs, .btn, .form-control, .form-select, #diagBox, #xlsxBadge, #file, #btnCheckXlsx, #btnClear, #q, #typeFilter, #sortBy {display:none!important;}
      .topbar{margin-bottom:10px;}
      .brand .sub{color:#444!important;}
      .table thead th{position:static!important;background:#f4f6f8!important;color:#111!important;border-bottom:1px solid #ddd!important;}
      .table td{color:#111!important;border-top:1px solid #eee!important;}
      .rowerr{background:#fff7e6!important;}
      .small-muted{color:#444!important;}
      .table-responsive{max-height:none!important;}
      a[href]:after{content:"";}
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>L·ªçc l·ªói th·ªùi gian <span style="color:var(--accent)">X-quang</span></h1>
          <p class="sub">Excel/CSV ‚Üí L·ªçc theo ng√†y/gi·ªù ‚Üí Ph√¢n t√≠ch 3 l·ªói chu·∫©n ‚Üí Nh√≥m theo m√°y ‚Üí Xu·∫•t Excel</p>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2 justify-content-end">
        <span class="chip">‚ö° Offline <b>100%</b></span>
        <span class="chip">üß† L·ªçc ng√†y/gi·ªù</span>
        <span class="chip">üì¶ Xu·∫•t <b>XLSX</b></span>
        <span class="chip">üñ® In/PDF</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="glass cardx">
        <div class="section-title">
          <div>
            <h2>1) N·∫°p d·ªØ li·ªáu & thi·∫øt l·∫≠p</h2>
            <p class="hint">L·ªçc ng√†y/gi·ªù √°p d·ª•ng cho <b>Bƒê (Ng√†y th·ª±c hi·ªán YL)</b>.</p>
          </div>

          <div class="badge-soft" id="xlsxBadge">
            <span class="dot" id="xlsxDot"></span>
            XLSX: <span id="xlsxText">‚Äî</span>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row g-3">
          <div class="col-12">
            <label class="form-label">Ch·ªçn file d·ªØ li·ªáu</label>
            <input id="file" class="form-control" type="file" accept=".xlsx,.xls,.csv,.txt,.tsv" />
            <div class="form-text">ƒê·∫∑t <b>xlsx.full.min.js</b> c√πng th∆∞ m·ª•c v·ªõi HTML ƒë·ªÉ ƒë·ªçc .xlsx v√† xu·∫•t .xlsx offline.</div>
          </div>

          <div class="col-12">
            <label class="form-label">Ti√™u ch√≠ nh·∫≠n di·ªán ca X-quang</label>
            <div class="switchline">
              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" id="xqByService" checked>
                <label class="form-check-label" for="xqByService">T√™n DVKT ch·ª©a ‚Äúx-quang / xq‚Äù</label>
              </div>
              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" id="xqByMachine" checked>
                <label class="form-check-label" for="xqByMachine">M√£ m√°y b·∫Øt ƒë·∫ßu b·∫±ng ‚ÄúXQ‚Äù</label>
              </div>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">L·ªçc theo ng√†y</label>
            <div class="row g-2">
              <div class="col-md-6">
                <input id="fromDate" type="date" class="form-control" />
                <div class="form-text">T·ª´ ng√†y (r·ªóng = kh√¥ng gi·ªõi h·∫°n)</div>
              </div>
              <div class="col-md-6">
                <input id="toDate" type="date" class="form-control" />
                <div class="form-text">ƒê·∫øn ng√†y (r·ªóng = kh√¥ng gi·ªõi h·∫°n)</div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">L·ªçc theo gi·ªù trong ng√†y</label>
            <div class="row g-2">
              <div class="col-md-6">
                <input id="fromTime" type="time" class="form-control" value="00:00" />
                <div class="form-text">Gi·ªù b·∫Øt ƒë·∫ßu (Bƒê ‚â• gi·ªù n√†y)</div>
              </div>
              <div class="col-md-6">
                <input id="toTime" type="time" class="form-control" value="23:59" />
                <div class="form-text">Gi·ªù k·∫øt th√∫c (Bƒê ‚â§ gi·ªù n√†y)</div>
              </div>
            </div>
            <div class="form-text mt-1">√Åp d·ª•ng theo <b>Bƒê</b>. Tr√πng Bƒê ch·ªâ b√°o l·ªói khi <b>kh√°c M√£ m√°y</b>. Tr√πng KT lu√¥n l√† l·ªói.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Ng∆∞·ª°ng ‚ÄúTH < 6P‚Äù (ph√∫t)</label>
            <input id="minMinutes" type="number" class="form-control" value="6" min="1" step="1" disabled>
            <div class="form-text">Chu·∫©n theo y√™u c·∫ßu: 6 ph√∫t (kh√≥a).</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">So kh·ªõp tr√πng theo ph√∫t (b·ªè gi√¢y)</label>
            <input id="roundToMin" type="number" class="form-control" value="1" min="1" step="1" disabled>
            <div class="form-text">Kh√≥a: so theo ph√∫t.</div>
          </div>

          <div class="col-12">
            <div class="toolbar">
              <div class="left">
                <button id="btnRun" class="btn btn-primary" disabled>üîé PH√ÇN T√çCH</button>
                <button id="btnExport" class="btn btn-success" disabled>‚¨á CSV</button>
                <button id="btnExportXlsx" class="btn btn-success" disabled>üì¶ Excel</button>
                <button id="btnPrint" class="btn btn-outline-light" disabled>üñ® In/PDF</button>
              </div>
              <div class="right">
                <button id="btnCheckXlsx" class="btn btn-outline-warning">üß© Ki·ªÉm tra XLSX</button>
                <button id="btnClear" class="btn btn-outline-light">üßπ Xo√°</button>
              </div>
            </div>
            <div class="small-muted mt-2" id="sourceHint">Ngu·ªìn d·ªØ li·ªáu: ‚Äî</div>
          </div>

          <div class="col-12">
            <div id="diagBox" class="alertx warning d-none"></div>
          </div>

          <div class="col-12">
            <div class="tabs">
              <div class="tabbtn active" id="tabDetail">üìã B·∫£ng l·ªói</div>
              <div class="tabbtn" id="tabGroup">üß© Nh√≥m theo m√°y</div>
              <div class="tabbtn" id="tabStats">üìà Th·ªëng k√™</div>
            </div>
            <div class="small-muted mt-2">Dropdown ‚ÄúLo·∫°i l·ªói‚Äù ƒë√£ kh√≥a ƒë√∫ng 3 lo·∫°i chu·∫©n BV.</div>
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="glass cardx">
        <div class="section-title">
          <div>
            <h2>2) K·∫øt qu·∫£</h2>
            <p class="hint">L·ªçc nhanh + Lo·∫°i l·ªói + S·∫Øp x·∫øp.</p>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kpi-wrap">
          <div class="kpi-box">
            <div class="lab">T·ªïng d√≤ng ƒë·ªçc</div>
            <div id="kpiRows" class="val">‚Äî</div>
            <div class="tag"><span class="dot"></span> Input</div>
          </div>
          <div class="kpi-box">
            <div class="lab">D√≤ng X-quang (sau l·ªçc)</div>
            <div id="kpiXQ" class="val">‚Äî</div>
            <div class="tag"><span class="dot ok"></span> Sau l·ªçc</div>
          </div>
          <div class="kpi-box">
            <div class="lab">S·ªë l·ªói</div>
            <div id="kpiErrors" class="val">‚Äî</div>
            <div class="tag"><span class="dot warn"></span> C·∫ßn ki·ªÉm</div>
          </div>
          <div class="kpi-box">
            <div class="lab">Ngu·ªìn d·ªØ li·ªáu</div>
            <div id="kpiSheet" class="val" style="font-size:1.05rem;line-height:1.2">‚Äî</div>
            <div class="tag"><span class="dot"></span> Sheet/CSV</div>
          </div>
        </div>

        <div class="divider"></div>

        <div id="filterBar">
          <div class="toolbar">
            <div class="left" style="flex:1; min-width:260px;">
              <div style="width:100%">
                <label class="form-label">L·ªçc nhanh</label>
                <input id="q" class="form-control" placeholder="VD: TR√ôNG KT, TR√ôNG Bƒê, XQ.2..., m√£ KCB..." />
              </div>
            </div>

            <div class="right" style="flex:1; justify-content:flex-end; min-width:260px;">
              <div style="min-width:230px; width:100%">
                <label class="form-label">Lo·∫°i l·ªói (chu·∫©n BV)</label>
                <select id="typeFilter" class="form-select">
                  <option value="">(T·∫•t c·∫£)</option>
                </select>
              </div>

              <div style="min-width:230px; width:100%">
                <label class="form-label">S·∫Øp x·∫øp</label>
                <select id="sortBy" class="form-select">
                  <option value="time">Th·ªùi gian</option>
                  <option value="type">Lo·∫°i l·ªói</option>
                  <option value="machine">M√£ m√°y ‚Üí Th·ªùi gian</option>
                </select>
              </div>

              <div class="d-grid" style="min-width:190px;">
                <label class="form-label">&nbsp;</label>
                <button id="btnCopySummary" class="btn btn-outline-light">üìã Copy t√≥m t·∫Øt</button>
              </div>
            </div>
          </div>

          <div class="divider"></div>
        </div>

        <div id="viewDetail">
          <div class="table-wrap">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Lo·∫°i l·ªói</th>
                    <th>M√¥ t·∫£</th>
                    <th>M√£ m√°y</th>
                    <th>Ng∆∞·ªùi TH</th>
                    <th>B√°c sƒ©</th>
                    <th>M√£ KCB</th>
                    <th>DVKT</th>
                    <th>Bƒê</th>
                    <th>KT</th>
                    <th>Ph√∫t</th>
                    <th>D√≤ng li√™n quan</th>
                  </tr>
                </thead>
                <tbody id="tbody">
                  <tr><td colspan="12" class="text-center" style="color:rgba(255,255,255,.62); padding:16px">
                    Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫£i file v√† b·∫•m <b>PH√ÇN T√çCH</b>.
                  </td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div id="viewGroup" class="hidden">
          <div id="groupBox" class="small-muted">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
        </div>

        <div id="viewStats" class="hidden">
          <div class="row g-3">
            <div class="col-12">
              <div class="table-wrap">
                <div class="p-3">
                  <div class="badge-soft ok">üìå Th·ªëng k√™ nhanh</div>
                  <div class="small-muted mt-2" id="statsSummary">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="table-wrap">
                <div class="p-3">
                  <div class="badge-soft">üìç L·ªói theo lo·∫°i</div>
                  <div class="table-responsive" style="max-height:260px">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Lo·∫°i</th><th class="text-end">S·ªë</th></tr></thead>
                      <tbody id="tbType"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="table-wrap">
                <div class="p-3">
                  <div class="badge-soft">üß© L·ªói theo M√£ m√°y</div>
                  <div class="table-responsive" style="max-height:260px">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>M√£ m√°y</th><th class="text-end">S·ªë</th></tr></thead>
                      <tbody id="tbMachine"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="table-wrap">
                <div class="p-3">
                  <div class="badge-soft">üóì L·ªói theo ng√†y</div>
                  <div class="table-responsive" style="max-height:260px">
                    <table class="table table-sm mb-0">
                      <thead><tr><th>Ng√†y</th><th class="text-end">S·ªë</th></tr></thead>
                      <tbody id="tbDay"></tbody>
                    </table>
                  </div>
                  <div class="small-muted mt-2">Ng√†y l·∫•y theo <b>Bƒê</b> (thi·∫øu Bƒê th√¨ l·∫•y theo KT).</div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /RIGHT -->
    </div><!-- /grid -->
  </div><!-- /shell -->

  <script src="./xlsx.full.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    // ====== CONFIG: 3 l·ªói chu·∫©n BV ======
    const ERR_START_DIFF_MACHINE = "TR√ôNG Bƒê (KH√ÅC M√ÅY)";
    const ERR_END_ANY            = "TR√ôNG KT";
    const ERR_DUR_LT_6           = "TH < 6P";
    const ALLOWED_TYPES = [ERR_START_DIFF_MACHINE, ERR_END_ANY, ERR_DUR_LT_6];

    function showDiag(msg, level="warning"){
      const box = $("diagBox");
      box.classList.remove("d-none");
      box.className = "alertx " + (level==="danger" ? "danger" : "warning");
      box.textContent = msg;
    }
    function hideDiag(){
      const box = $("diagBox");
      box.classList.add("d-none");
      box.textContent = "";
    }

    function excelNumberToDate(n) {
      const epoch = Date.UTC(1899, 11, 30);
      const ms = Math.round(n * 86400000);
      return new Date(epoch + ms);
    }

    function toDate(val) {
      if (val == null || val === "") return null;
      if (val instanceof Date && !isNaN(val)) return val;
      if (typeof val === "number" && isFinite(val)) return excelNumberToDate(val);

      if (typeof val === "string") {
        const s = val.trim().replace(/\s+/g, " ");
        const iso = new Date(s);
        if (!isNaN(iso)) return iso;

        const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?$/i);
        if (m) {
          let d = parseInt(m[1],10), mo = parseInt(m[2],10)-1, y = parseInt(m[3],10);
          if (y < 100) y += 2000;
          let hh = m[4] ? parseInt(m[4],10) : 0;
          const mm = m[5] ? parseInt(m[5],10) : 0;
          const ss = m[6] ? parseInt(m[6],10) : 0;
          const ap = m[7] ? m[7].toUpperCase() : null;
          if (ap === "PM" && hh < 12) hh += 12;
          if (ap === "AM" && hh === 12) hh = 0;
          const dt = new Date(y, mo, d, hh, mm, ss);
          if (!isNaN(dt)) return dt;
        }
      }
      return null;
    }

    function fmt(dt) {
      if (!dt) return "";
      try {
        const f = new Intl.DateTimeFormat("vi-VN", {
          timeZone: "Asia/Ho_Chi_Minh",
          year: "numeric", month: "2-digit", day: "2-digit",
          hour: "2-digit", minute: "2-digit"
        });
        return f.format(dt);
      } catch (e) {
        return dt.toLocaleString();
      }
    }

    function fmtDay(dt){
      if (!dt) return "";
      try{
        const f = new Intl.DateTimeFormat("vi-VN", {
          timeZone: "Asia/Ho_Chi_Minh",
          year:"numeric", month:"2-digit", day:"2-digit"
        });
        return f.format(dt);
      }catch(e){
        const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,"0"), d=String(dt.getDate()).padStart(2,"0");
        return `${d}/${m}/${y}`;
      }
    }

    function safe(v) { return (v==null) ? "" : String(v); }
    function minutesBetween(a,b) { return Math.round((b.getTime()-a.getTime())/60000); }

    function parseCSV(text){
      const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim()!=="");
      if (!lines.length) return {headers:[], rows:[]};

      const head = lines[0];
      const comma = (head.match(/,/g)||[]).length;
      const semi = (head.match(/;/g)||[]).length;
      const tab = (head.match(/\t/g)||[]).length;
      const delim = tab>0 ? "\t" : (semi>comma ? ";" : ",");

      const splitLine = (line) => {
        const out = [];
        let cur="", inQ=false;
        for (let i=0;i<line.length;i++){
          const ch=line[i];
          if (ch === '"'){
            if (inQ && line[i+1] === '"'){ cur+='"'; i++; }
            else inQ = !inQ;
          } else if (!inQ && ch === delim){
            out.push(cur); cur="";
          } else cur += ch;
        }
        out.push(cur);
        return out.map(s=>s.trim());
      };

      const headers = splitLine(lines[0]);
      const rows = [];
      for (let r=1;r<lines.length;r++){
        const cols = splitLine(lines[r]);
        if (cols.every(c=>c==="")) continue;
        rows.push(cols);
      }
      return {headers, rows, delim};
    }

    function normHeader(h){ return safe(h).trim().toLowerCase().replace(/\s+/g," "); }
    function mapHeaders(headers){
      const idx = {}; headers.forEach((h,i)=> idx[normHeader(h)] = i);

      const pick = (cands) => {
        for (const c of cands){
          const k=normHeader(c);
          if (k in idx) return idx[k];
        }
        for (const c of cands){
          const k=normHeader(c);
          for (const key in idx){
            if (key.includes(k)) return idx[key];
          }
        }
        return -1;
      };

      return {
        ten: pick(["t√™n dvkt","ten dvkt","dvkt"]),
        maMay: pick(["m√£ m√°y","ma may"]),
        nguoiTH: pick(["ng∆∞·ªùi th·ª±c hi·ªán","nguoi thuc hien"]),
        bacSi: pick(["b√°c sƒ©","bac si"]),
        maKCB: pick(["m√£ kcb","ma kcb"]),
        start: pick(["ng√†y th·ª±c hi·ªán yl","ng√†y th·ª±c hi·ªán"]),
        end: pick(["ng√†y k·∫øt qu·∫£"])
      };
    }

    function bucketMinute(dt) {
      if (!dt) return "";
      const minute = 60000;
      return String(Math.floor(dt.getTime() / minute) * minute);
    }

    function isXQ(row, byService, byMachine) {
      const ten = safe(row.ten).toLowerCase();
      const ma = safe(row.maMay).trim().toUpperCase();
      const okService = byService ? (
        ten.includes("x-quang") || ten.includes("x quang") || ten.includes("xq") ||
        ten.includes("x-ray") || ten.includes("xray")
      ) : false;
      const okMachine = byMachine ? (ma.startsWith("XQ")) : false;

      if (byService && byMachine) return okService || okMachine;
      if (byService) return okService;
      if (byMachine) return okMachine;
      return true;
    }

    function parseHHMM(t){
      if (!t) return null;
      const m = String(t).match(/^(\d{1,2}):(\d{2})$/);
      if (!m) return null;
      const hh = Math.min(23, Math.max(0, parseInt(m[1],10)));
      const mm = Math.min(59, Math.max(0, parseInt(m[2],10)));
      return hh*60 + mm;
    }

    function isInDateTimeWindow(startDt){
      if (!startDt) return true;
      const fromDate = $("fromDate").value;
      const toDate = $("toDate").value;
      const fromTime = parseHHMM($("fromTime").value || "00:00");
      const toTime   = parseHHMM($("toTime").value || "23:59");

      if (fromDate){
        const [y,m,d] = fromDate.split("-").map(n=>parseInt(n,10));
        const minDt = new Date(y, m-1, d, 0,0,0);
        if (startDt < minDt) return false;
      }
      if (toDate){
        const [y,m,d] = toDate.split("-").map(n=>parseInt(n,10));
        const maxDt = new Date(y, m-1, d, 23,59,59);
        if (startDt > maxDt) return false;
      }

      const startMin = startDt.getHours()*60 + startDt.getMinutes();
      if (fromTime!=null && startMin < fromTime) return false;
      if (toTime!=null && startMin > toTime) return false;

      return true;
    }

    function mkErr(type, row, desc, relatedRows=[]) {
      const dur = (row.start && row.end) ? minutesBetween(row.start, row.end) : null;
      const related = relatedRows.length ? relatedRows.map(r=>r.rownum).join(", ") : "";
      return {
        type, desc,
        rownum: row.rownum,
        maMay: row.maMay,
        nguoiTH: row.nguoiTH,
        bacSi: row.bacSi,
        maKCB: row.maKCB,
        ten: row.ten,
        start: row.start,
        end: row.end,
        duration: dur,
        related
      };
    }

    // ====== ONLY 3 ERRORS (as requested) ======
    function analyzeXQ(rows) {
      const errors = [];

      // (3) TH < 6P : duration >=0 && <6
      for (const r of rows) {
        if (r.start && r.end) {
          const dur = minutesBetween(r.start, r.end);
          if (dur >= 0 && dur < 6) {
            errors.push(mkErr(ERR_DUR_LT_6, r, `Th·ªùi gian th·ª±c hi·ªán ${dur} ph√∫t < 6 ph√∫t`, []));
          }
        }
      }

      // (1) TR√ôNG Bƒê (KH√ÅC M√ÅY): same minute start AND different machine
      const mapStart = new Map();
      for (const r of rows) {
        if (!r.start) continue;
        const key = bucketMinute(r.start);
        if (!mapStart.has(key)) mapStart.set(key, []);
        mapStart.get(key).push(r);
      }

      for (const [key, arr] of mapStart.entries()) {
        if (arr.length < 2) continue;

        for (const r of arr) {
          const m0 = safe(r.maMay).trim().toUpperCase();
          const othersDiffMachine = arr.filter(x =>
            x !== r && safe(x.maMay).trim().toUpperCase() !== m0
          );
          if (!othersDiffMachine.length) continue;

          const otherMachines = Array.from(
            new Set(othersDiffMachine.map(x => safe(x.maMay).trim()).filter(Boolean))
          ).join(", ");

          const desc = `Tr√πng Bƒê (${fmt(r.start)}) nh∆∞ng kh√°c m√°y: ${otherMachines || "(kh√¥ng r√µ)"}`;
          errors.push(mkErr(ERR_START_DIFF_MACHINE, r, desc, othersDiffMachine));
        }
      }

      // (2) TR√ôNG KT: same minute end ALWAYS error
      const mapEnd = new Map();
      for (const r of rows) {
        if (!r.end) continue;
        const key = bucketMinute(r.end);
        if (!mapEnd.has(key)) mapEnd.set(key, []);
        mapEnd.get(key).push(r);
      }

      for (const [key, arr] of mapEnd.entries()) {
        if (arr.length < 2) continue;

        for (const r of arr) {
          const others = arr.filter(x => x !== r);
          const desc = `Tr√πng KT (${fmt(r.end)}) v·ªõi ${others.length} ca kh√°c`;
          errors.push(mkErr(ERR_END_ANY, r, desc, others));
        }
      }

      // Dedup
      const seen = new Set();
      const out = [];
      for (const e of errors) {
        const sig = [e.type, e.rownum, bucketMinute(e.start), bucketMinute(e.end), e.related].join("|");
        if (seen.has(sig)) continue;
        seen.add(sig);
        out.push(e);
      }
      return out;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }

    function setKPIs(rowsCount, xqCount, errors, sourceName) {
      $("kpiRows").textContent = rowsCount ?? "‚Äî";
      $("kpiXQ").textContent = xqCount ?? "‚Äî";
      $("kpiErrors").textContent = errors ? errors.length : "‚Äî";
      $("kpiSheet").textContent = sourceName ?? "‚Äî";
      $("sourceHint").textContent = "Ngu·ªìn d·ªØ li·ªáu: " + (sourceName ?? "‚Äî");

      ["kpiRows","kpiXQ","kpiErrors","kpiSheet"].forEach(id=>{
        const el = $(id);
        el.classList.remove("pulse");
        void el.offsetWidth;
        el.classList.add("pulse");
      });
    }

    // ====== dropdown locked to exactly 3 types (BV labels) ======
    function fillTypeFilter(errors) {
      const sel = $("typeFilter");
      const cur = sel.value;

      const FIXED_TYPES = [
        { v: ERR_START_DIFF_MACHINE, label: ERR_START_DIFF_MACHINE },
        { v: ERR_END_ANY,            label: ERR_END_ANY },
        { v: ERR_DUR_LT_6,           label: ERR_DUR_LT_6 }
      ];

      const count = {};
      for (const e of errors) count[e.type] = (count[e.type] || 0) + 1;

      sel.innerHTML = `<option value="">(T·∫•t c·∫£)</option>` +
        FIXED_TYPES.map(t => {
          const n = count[t.v] || 0;
          return `<option value="${escapeHtml(t.v)}">${escapeHtml(t.label)} (${n})</option>`;
        }).join("");

      const valid = FIXED_TYPES.some(t => t.v === cur);
      sel.value = valid ? cur : "";
    }

    function renderDetail(errors) {
      const q = $("q").value.trim().toLowerCase();
      const typeF = $("typeFilter").value;
      const sortBy = $("sortBy").value;

      let items = errors.slice().filter(e => ALLOWED_TYPES.includes(e.type));
      if (typeF) items = items.filter(e=>e.type===typeF);
      if (q) {
        items = items.filter(e => {
          const blob = [e.type,e.desc,e.maMay,e.nguoiTH,e.bacSi,e.maKCB,e.ten,fmt(e.start),fmt(e.end),e.rownum,e.related].join(" ").toLowerCase();
          return blob.includes(q);
        });
      }

      if (sortBy === "type") items.sort((a,b)=>a.type.localeCompare(b.type) || (a.start?.getTime()||0)-(b.start?.getTime()||0));
      else if (sortBy === "machine") items.sort((a,b)=>safe(a.maMay).localeCompare(safe(b.maMay)) || (a.start?.getTime()||0)-(b.start?.getTime()||0));
      else items.sort((a,b)=>(a.start?.getTime()||0)-(b.start?.getTime()||0));

      const tb = $("tbody");
      if (!items.length) {
        tb.innerHTML = `<tr><td colspan="12" class="text-center" style="color:rgba(255,255,255,.62); padding:16px">
          Kh√¥ng c√≥ l·ªói theo b·ªô l·ªçc hi·ªán t·∫°i.
        </td></tr>`;
        return;
      }

      tb.innerHTML = items.map((e, idx) => {
        const cls = (e.type === ERR_END_ANY) ? "warn" : "warn";
        return `
          <tr class="rowerr">
            <td class="mono">${idx+1}</td>
            <td><span class="badge-soft ${cls}">‚ö† ${escapeHtml(e.type)}</span></td>
            <td>${escapeHtml(e.desc)}</td>
            <td class="mono">${escapeHtml(safe(e.maMay))}</td>
            <td>${escapeHtml(safe(e.nguoiTH))}</td>
            <td>${escapeHtml(safe(e.bacSi))}</td>
            <td class="mono">${escapeHtml(safe(e.maKCB))}</td>
            <td>${escapeHtml(safe(e.ten))}</td>
            <td class="mono">${escapeHtml(fmt(e.start))}</td>
            <td class="mono">${escapeHtml(fmt(e.end))}</td>
            <td class="mono">${e.duration==null ? "" : e.duration}</td>
            <td class="mono">${e.related ? `Li√™n quan: ${escapeHtml(e.related)}` : ""}</td>
          </tr>
        `;
      }).join("");
    }

    function buildGroupByMachine(errors){
      const q = $("q").value.trim().toLowerCase();
      const typeF = $("typeFilter").value;

      let items = errors.slice().filter(e => ALLOWED_TYPES.includes(e.type));
      if (typeF) items = items.filter(e=>e.type===typeF);
      if (q) {
        items = items.filter(e => {
          const blob = [e.type,e.desc,e.maMay,e.nguoiTH,e.bacSi,e.maKCB,e.ten,fmt(e.start),fmt(e.end),e.rownum,e.related].join(" ").toLowerCase();
          return blob.includes(q);
        });
      }

      if (!items.length){
        $("groupBox").innerHTML = `<div class="text-center" style="color:rgba(255,255,255,.62); padding:16px">Kh√¥ng c√≥ l·ªói theo b·ªô l·ªçc hi·ªán t·∫°i.</div>`;
        return;
      }

      const map = new Map();
      for (const e of items){
        const m = safe(e.maMay).trim().toUpperCase() || "(KH√îNG R√ï)";
        if (!map.has(m)) map.set(m, []);
        map.get(m).push(e);
      }

      const machines = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b));
      const accId = "accMachine";
      const html = `
        <div class="accordion" id="${accId}">
          ${machines.map((m, idx)=>{
            const arr = map.get(m);
            arr.sort((a,b)=>(a.start?.getTime()||0)-(b.start?.getTime()||0));
            const body = `
              <div class="table-wrap mt-2">
                <div class="table-responsive" style="max-height:360px">
                  <table class="table table-sm mb-0">
                    <thead>
                      <tr>
                        <th>#</th><th>Lo·∫°i l·ªói</th><th>M√¥ t·∫£</th><th>Bƒê</th><th>KT</th><th>D√≤ng</th><th>Li√™n quan</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${arr.map((e,i)=>`
                        <tr class="rowerr">
                          <td class="mono">${i+1}</td>
                          <td><span class="badge-soft warn">${escapeHtml(e.type)}</span></td>
                          <td>${escapeHtml(e.desc)}</td>
                          <td class="mono">${escapeHtml(fmt(e.start))}</td>
                          <td class="mono">${escapeHtml(fmt(e.end))}</td>
                          <td class="mono">${escapeHtml(String(e.rownum ?? ""))}</td>
                          <td class="mono">${escapeHtml(e.related ?? "")}</td>
                        </tr>
                      `).join("")}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
            const cid = "m" + idx;
            return `
              <div class="accordion-item mb-2">
                <h2 class="accordion-header">
                  <button class="accordion-button ${idx===0 ? "" : "collapsed"}" type="button"
                    data-bs-toggle="collapse" data-bs-target="#${cid}">
                    üß© M√°y: <span class="mono ms-2">${escapeHtml(m)}</span>
                    <span class="ms-auto badge-soft warn">L·ªói: ${arr.length}</span>
                  </button>
                </h2>
                <div id="${cid}" class="accordion-collapse collapse ${idx===0 ? "show" : ""}" data-bs-parent="#${accId}">
                  <div class="accordion-body">
                    ${body}
                  </div>
                </div>
              </div>
            `;
          }).join("")}
        </div>
      `;
      $("groupBox").innerHTML = html;
    }

    function buildStats(errors, allRowsLen, xqRowsLen, sourceName){
      const filtered = errors.slice().filter(e => ALLOWED_TYPES.includes(e.type));

      if (!filtered.length){
        $("statsSummary").textContent = "Ch∆∞a c√≥ l·ªói ƒë·ªÉ th·ªëng k√™.";
        $("tbType").innerHTML = `<tr><td colspan="2" class="text-center" style="color:rgba(255,255,255,.62);padding:12px">‚Äî</td></tr>`;
        $("tbMachine").innerHTML = `<tr><td colspan="2" class="text-center" style="color:rgba(255,255,255,.62);padding:12px">‚Äî</td></tr>`;
        $("tbDay").innerHTML = `<tr><td colspan="2" class="text-center" style="color:rgba(255,255,255,.62);padding:12px">‚Äî</td></tr>`;
        return;
      }

      const typeCount = {};
      const machineCount = {};
      const dayCount = {};

      for (const e of filtered){
        typeCount[e.type] = (typeCount[e.type]||0)+1;
        const m = safe(e.maMay).trim().toUpperCase() || "(KH√îNG R√ï)";
        machineCount[m] = (machineCount[m]||0)+1;
        const day = fmtDay(e.start || e.end);
        const dk = day || "(KH√îNG R√ï)";
        dayCount[dk] = (dayCount[dk]||0)+1;
      }

      const topType = Object.entries(typeCount).sort((a,b)=>b[1]-a[1])[0];
      const topMachine = Object.entries(machineCount).sort((a,b)=>b[1]-a[1])[0];
      const topDay = Object.entries(dayCount).sort((a,b)=>b[1]-a[1])[0];

      $("statsSummary").innerHTML = `
        <div class="small-muted">
          <div><b>Ngu·ªìn:</b> ${escapeHtml(sourceName||"‚Äî")}</div>
          <div><b>T·ªïng d√≤ng:</b> ${allRowsLen} ¬∑ <b>X-quang (sau l·ªçc):</b> ${xqRowsLen} ¬∑ <b>T·ªïng l·ªói:</b> ${filtered.length}</div>
          <div class="mt-2">
            <span class="badge-soft warn">Top lo·∫°i: ${escapeHtml(topType?.[0]||"‚Äî")} (${topType?.[1]||0})</span>
            <span class="badge-soft warn ms-2">Top m√°y: ${escapeHtml(topMachine?.[0]||"‚Äî")} (${topMachine?.[1]||0})</span>
            <span class="badge-soft warn ms-2">Top ng√†y: ${escapeHtml(topDay?.[0]||"‚Äî")} (${topDay?.[1]||0})</span>
          </div>
        </div>
      `;

      const rowsType = ALLOWED_TYPES.map(t => [t, typeCount[t]||0])
        .filter(([,v])=>v>0)
        .sort((a,b)=>b[1]-a[1])
        .map(([k,v])=>`<tr><td>${escapeHtml(k)}</td><td class="text-end mono">${v}</td></tr>`).join("");
      $("tbType").innerHTML = rowsType || `<tr><td colspan="2" class="text-center" style="color:rgba(255,255,255,.62);padding:12px">‚Äî</td></tr>`;

      const rowsMachine = Object.entries(machineCount).sort((a,b)=>b[1]-a[1])
        .map(([k,v])=>`<tr><td class="mono">${escapeHtml(k)}</td><td class="text-end mono">${v}</td></tr>`).join("");
      $("tbMachine").innerHTML = rowsMachine || `<tr><td colspan="2" class="text-center" style="color:rgba(255,255,255,.62);padding:12px">‚Äî</td></tr>`;

      const rowsDay = Object.entries(dayCount).sort((a,b)=>b[1]-a[1])
        .map(([k,v])=>`<tr><td class="mono">${escapeHtml(k)}</td><td class="text-end mono">${v}</td></tr>`).join("");
      $("tbDay").innerHTML = rowsDay || `<tr><td colspan="2" class="text-center" style="color:rgba(255,255,255,.62);padding:12px">‚Äî</td></tr>`;
    }

    function exportCSV(errors) {
      const filtered = errors.filter(e => ALLOWED_TYPES.includes(e.type));
      const headers = ["LoaiLoi","MoTa","MaMay","NguoiTH","BacSi","MaKCB","TenDVKT","BatDau","KetThuc","Phut","Dong","DongLienQuan"];
      const rows = filtered.map(e => [
        e.type, e.desc, e.maMay, e.nguoiTH, e.bacSi, e.maKCB, e.ten, fmt(e.start), fmt(e.end),
        e.duration ?? "", e.rownum ?? "", e.related ?? ""
      ].map(v => `"${String(v??"").replace(/"/g,'""')}"`).join(","));

      const csv = headers.join(",") + "\n" + rows.join("\n");
      const BOM = "\uFEFF";
      const blob = new Blob([BOM + csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `loi_xquang_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportXLSX(errors, allLen, xqLen, sourceName){
      if (typeof XLSX === "undefined"){
        showDiag("Kh√¥ng th·ªÉ xu·∫•t Excel v√¨ thi·∫øu th∆∞ vi·ªán XLSX. H√£y ƒë·∫∑t xlsx.full.min.js c√πng th∆∞ m·ª•c.", "danger");
        return;
      }
      const now = new Date();
      const fileName = `BaoCao_Loi_XQuang_${now.toISOString().slice(0,10)}.xlsx`;
      const filtered = errors.filter(e => ALLOWED_TYPES.includes(e.type));

      const detail = filtered.map((e, i)=>({
        STT: i+1,
        LoaiLoi: e.type,
        MoTa: e.desc,
        MaMay: e.maMay,
        NguoiTH: e.nguoiTH,
        BacSi: e.bacSi,
        MaKCB: e.maKCB,
        TenDVKT: e.ten,
        BatDau: fmt(e.start),
        KetThuc: fmt(e.end),
        Phut: (e.duration==null ? "" : e.duration),
        Dong: e.rownum ?? "",
        DongLienQuan: e.related ?? ""
      }));

      const typeCount = {};
      const machineCount = {};
      const dayCount = {};
      filtered.forEach(e=>{
        typeCount[e.type]=(typeCount[e.type]||0)+1;
        const m=(safe(e.maMay).trim().toUpperCase()||"(KH√îNG R√ï)");
        machineCount[m]=(machineCount[m]||0)+1;
        const d=fmtDay(e.start||e.end) || "(KH√îNG R√ï)";
        dayCount[d]=(dayCount[d]||0)+1;
      });

      const summaryRows = [
        {ThongTin:"Ngu·ªìn", GiaTri: String(sourceName || "‚Äî")},
        {ThongTin:"T·ªïng d√≤ng", GiaTri: String(allLen)},
        {ThongTin:"D√≤ng X-quang (sau l·ªçc)", GiaTri: String(xqLen)},
        {ThongTin:"T·ªïng l·ªói (3 lo·∫°i)", GiaTri: String(filtered.length)},
        {ThongTin:"T·ª´ ng√†y", GiaTri: String($("fromDate").value || "(kh√¥ng)")},
        {ThongTin:"ƒê·∫øn ng√†y", GiaTri: String($("toDate").value || "(kh√¥ng)")},
        {ThongTin:"Gi·ªù t·ª´", GiaTri: String($("fromTime").value || "00:00")},
        {ThongTin:"Gi·ªù ƒë·∫øn", GiaTri: String($("toTime").value || "23:59")},
        {ThongTin:"Quy t·∫Øc", GiaTri: "Tr√πng Bƒê ch·ªâ l·ªói khi kh√°c m√°y; Tr√πng KT lu√¥n l·ªói; TH < 6P"}
      ];

      const byMachine = Object.entries(machineCount).sort((a,b)=>b[1]-a[1]).map(([k,v])=>({MaMay:k, SoLoi:v}));
      const byDay = Object.entries(dayCount).sort((a,b)=>b[1]-a[1]).map(([k,v])=>({Ngay:k, SoLoi:v}));
      const byType = ALLOWED_TYPES.map(t => ({LoaiLoi: t, SoLoi: typeCount[t]||0})).filter(r=>r.SoLoi>0);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detail.length?detail:[{STT:"",LoaiLoi:"",MoTa:""}]), "LOI_CHI_TIET");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryRows), "TONG_HOP");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byMachine.length?byMachine:[{MaMay:"",SoLoi:""}]), "THEO_MAY");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byDay.length?byDay:[{Ngay:"",SoLoi:""}]), "THEO_NGAY");
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(byType.length?byType:[{LoaiLoi:"",SoLoi:""}]), "THEO_LOAI");

      XLSX.writeFile(wb, fileName);
    }

    let allRows = [];
    let xqRows = [];
    let analyzedErrors = [];
    let sourceName = "‚Äî";
    let selectedFile = null;

    function canReadExcel(){ return typeof XLSX !== "undefined"; }

    async function loadDataFromFile(f){
      hideDiag();
      selectedFile = f;
      allRows = []; xqRows = []; analyzedErrors = [];
      $("btnExport").disabled = true;
      $("btnExportXlsx").disabled = true;
      $("btnPrint").disabled = true;

      $("tbody").innerHTML = `<tr><td colspan="12" class="text-center" style="color:rgba(255,255,255,.62); padding:16px">
        ƒê√£ t·∫£i file. B·∫•m <b>PH√ÇN T√çCH</b> ƒë·ªÉ x·ª≠ l√Ω‚Ä¶
      </td></tr>`;
      $("groupBox").textContent = "ƒê√£ t·∫£i file. B·∫•m PH√ÇN T√çCH ƒë·ªÉ xem nh√≥m theo m√°y.";
      $("statsSummary").textContent = "ƒê√£ t·∫£i file. B·∫•m PH√ÇN T√çCH ƒë·ªÉ xem th·ªëng k√™.";

      if (!f){ $("btnRun").disabled = true; return; }

      const name = f.name || "‚Äî";
      const ext = name.split(".").pop().toLowerCase();

      if (ext === "csv" || ext === "txt" || ext === "tsv"){
        const text = await f.text();
        const parsed = parseCSV(text);
        const col = mapHeaders(parsed.headers);

        const missing = [];
        if (col.start < 0) missing.push("Ng√†y th·ª±c hi·ªán YL");
        if (col.end < 0) missing.push("Ng√†y k·∫øt qu·∫£");
        if (col.ten < 0) missing.push("T√™n DVKT");
        if (col.maMay < 0) missing.push("M√£ m√°y");
        if (missing.length){
          showDiag("CSV thi·∫øu c·ªôt b·∫Øt bu·ªôc: " + missing.join(", ") + "\nH√£y ki·ªÉm tra h√†ng ti√™u ƒë·ªÅ gi·ªëng Sheet1.", "danger");
          $("btnRun").disabled = true;
          return;
        }

        allRows = parsed.rows.map((cols, idx)=>({
          rownum: idx+2,
          ten: cols[col.ten] ?? "",
          maMay: cols[col.maMay] ?? "",
          nguoiTH: col.nguoiTH>=0 ? (cols[col.nguoiTH] ?? "") : "",
          bacSi: col.bacSi>=0 ? (cols[col.bacSi] ?? "") : "",
          maKCB: col.maKCB>=0 ? (cols[col.maKCB] ?? "") : "",
          start: toDate(cols[col.start]),
          end: toDate(cols[col.end]),
        }));

        sourceName = "CSV: " + name;
        setKPIs(allRows.length, "‚Äî", [], sourceName);
        $("btnRun").disabled = false;
        return;
      }

      if ((ext==="xlsx" || ext==="xls") && !canReadExcel()){
        showDiag("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c Excel v√¨ thi·∫øu xlsx.full.min.js.\n‚û°Ô∏è ƒê·∫∑t xlsx.full.min.js c√πng th∆∞ m·ª•c v·ªõi index.html, ho·∫∑c Save As CSV UTF-8 ƒë·ªÉ d√πng CSV.", "danger");
        $("btnRun").disabled = true;
        return;
      }

      if (ext==="xlsx" || ext==="xls"){
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, {type:"array", cellDates:true, raw:true});
        const sheetName = (wb.SheetNames.includes("Sheet1") ? "Sheet1" : wb.SheetNames[0]);
        const ws = wb.Sheets[sheetName];
        const aoa = XLSX.utils.sheet_to_json(ws, {header: 1, raw: true, defval: null});

        let headerRowIdx = -1;
        for (let r=0;r<Math.min(120, aoa.length);r++){
          const joined = (aoa[r]||[]).map(x=>safe(x)).join(" | ");
          if (joined.includes("Ng√†y th·ª±c hi·ªán") && joined.includes("Ng√†y k·∫øt qu·∫£")) { headerRowIdx = r; break; }
        }
        if (headerRowIdx === -1) headerRowIdx = 0;

        const headers = (aoa[headerRowIdx]||[]).map(h=>safe(h).trim());
        const col = mapHeaders(headers);

        const missing = [];
        if (col.start < 0) missing.push("Ng√†y th·ª±c hi·ªán YL");
        if (col.end < 0) missing.push("Ng√†y k·∫øt qu·∫£");
        if (col.ten < 0) missing.push("T√™n DVKT");
        if (col.maMay < 0) missing.push("M√£ m√°y");
        if (missing.length){
          showDiag("Excel thi·∫øu c·ªôt b·∫Øt bu·ªôc: " + missing.join(", ") + "\nH√£y ki·ªÉm tra header trong Sheet1.", "danger");
          $("btnRun").disabled = true;
          return;
        }

        const rows = [];
        for (let r=headerRowIdx+1; r<aoa.length; r++){
          const row = aoa[r] || [];
          const nonEmpty = row.some(v => v!=null && safe(v).trim()!=="");
          if (!nonEmpty) continue;
          rows.push({row, rownum: r+1});
        }

        allRows = rows.map((it)=>({
          rownum: it.rownum,
          ten: it.row[col.ten] ?? "",
          maMay: it.row[col.maMay] ?? "",
          nguoiTH: col.nguoiTH>=0 ? (it.row[col.nguoiTH] ?? "") : "",
          bacSi: col.bacSi>=0 ? (it.row[col.bacSi] ?? "") : "",
          maKCB: col.maKCB>=0 ? (it.row[col.maKCB] ?? "") : "",
          start: toDate(it.row[col.start]),
          end: toDate(it.row[col.end]),
        }));

        sourceName = `Excel: ${name} / ${sheetName}`;
        setKPIs(allRows.length, "‚Äî", [], sourceName);
        $("btnRun").disabled = false;
        return;
      }

      showDiag("ƒê·ªãnh d·∫°ng file ch∆∞a h·ªó tr·ª£. H√£y d√πng .xlsx ho·∫∑c .csv", "danger");
      $("btnRun").disabled = true;
    }

    function runAnalysis(){
      hideDiag();
      if (!selectedFile || allRows.length===0){
        showDiag("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch. H√£y ch·ªçn file tr∆∞·ªõc.", "danger");
        return;
      }

      const byService = $("xqByService").checked;
      const byMachine = $("xqByMachine").checked;

      const xqAll = allRows.filter(r => isXQ(r, byService, byMachine));
      xqRows = xqAll.filter(r => isInDateTimeWindow(r.start));

      analyzedErrors = analyzeXQ(xqRows);
      setKPIs(allRows.length, xqRows.length, analyzedErrors, sourceName);
      fillTypeFilter(analyzedErrors);

      $("btnExport").disabled = analyzedErrors.length === 0;
      $("btnExportXlsx").disabled = analyzedErrors.length === 0 || (typeof XLSX === "undefined");
      $("btnPrint").disabled = analyzedErrors.length === 0;

      rerenderAll();

      if (xqAll.length === 0){
        showDiag("Kh√¥ng t√¨m th·∫•y d√≤ng X-quang theo ti√™u ch√≠ ƒëang b·∫≠t.\n‚û°Ô∏è Th·ª≠ b·∫≠t c·∫£ 2 ti√™u ch√≠ ho·∫∑c ki·ªÉm tra T√™n DVKT/M√£ m√°y.", "warning");
        return;
      }
      if (xqRows.length === 0){
        showDiag("C√≥ d√≤ng X-quang, nh∆∞ng sau l·ªçc ng√†y/gi·ªù th√¨ kh√¥ng c√≤n d√≤ng n√†o.\n‚û°Ô∏è Ki·ªÉm tra T·ª´/ƒê·∫øn ng√†y v√† Gi·ªù t·ª´/ƒë·∫øn.", "warning");
      }
    }

    function setXlsxStatus(){
      const ok = (typeof XLSX !== "undefined");
      const dot = $("xlsxDot");
      const txt = $("xlsxText");
      if (ok){
        dot.className = "dot ok"; txt.textContent = "OK";
      }else{
        dot.className = "dot danger"; txt.textContent = "FAIL";
      }
      return ok;
    }

    function switchTab(which){
      $("tabDetail").classList.remove("active");
      $("tabGroup").classList.remove("active");
      $("tabStats").classList.remove("active");
      $("viewDetail").classList.add("hidden");
      $("viewGroup").classList.add("hidden");
      $("viewStats").classList.add("hidden");

      if (which==="detail"){ $("tabDetail").classList.add("active"); $("viewDetail").classList.remove("hidden"); }
      if (which==="group"){ $("tabGroup").classList.add("active"); $("viewGroup").classList.remove("hidden"); }
      if (which==="stats"){ $("tabStats").classList.add("active"); $("viewStats").classList.remove("hidden"); }
    }

    $("tabDetail").addEventListener("click", ()=>switchTab("detail"));
    $("tabGroup").addEventListener("click", ()=>switchTab("group"));
    $("tabStats").addEventListener("click", ()=>switchTab("stats"));

    $("file").addEventListener("change", async (ev)=>{ await loadDataFromFile(ev.target.files?.[0]); });
    $("btnRun").addEventListener("click", runAnalysis);
    $("btnExport").addEventListener("click", ()=>{ if(analyzedErrors.length) exportCSV(analyzedErrors); });

    $("btnExportXlsx").addEventListener("click", ()=>{
      if (!analyzedErrors.length) return;
      exportXLSX(analyzedErrors, allRows.length, xqRows.length, sourceName);
    });

    $("btnPrint").addEventListener("click", ()=>{
      if (!analyzedErrors.length) return;
      window.print();
    });

    $("btnClear").addEventListener("click", ()=>{
      selectedFile=null; allRows=[]; xqRows=[]; analyzedErrors=[]; sourceName="‚Äî";
      $("file").value="";
      $("tbody").innerHTML = `<tr><td colspan="12" class="text-center" style="color:rgba(255,255,255,.62); padding:16px">
        Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫£i file v√† b·∫•m <b>PH√ÇN T√çCH</b>.
      </td></tr>`;
      $("typeFilter").innerHTML = `<option value="">(T·∫•t c·∫£)</option>`;
      $("q").value = "";
      $("btnExport").disabled = true;
      $("btnExportXlsx").disabled = true;
      $("btnRun").disabled = true;
      $("btnPrint").disabled = true;
      hideDiag();
      $("sourceHint").textContent = "Ngu·ªìn d·ªØ li·ªáu: ‚Äî";
      setKPIs(null, null, null, "‚Äî");
      $("groupBox").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu.";
      $("statsSummary").textContent = "Ch∆∞a c√≥ d·ªØ li·ªáu.";
      $("tbType").innerHTML = "";
      $("tbMachine").innerHTML = "";
      $("tbDay").innerHTML = "";
      switchTab("detail");
    });

    function rerenderAll(){
      renderDetail(analyzedErrors);
      buildGroupByMachine(analyzedErrors);
      buildStats(analyzedErrors, allRows.length, xqRows.length, sourceName);
    }

    ["q","typeFilter","sortBy"].forEach(id => {
      $(id).addEventListener("input", rerenderAll);
      $(id).addEventListener("change", rerenderAll);
    });

    $("btnCopySummary").addEventListener("click", async ()=>{
      const filtered = analyzedErrors.filter(e=>ALLOWED_TYPES.includes(e.type));
      const count = {};
      for (const e of filtered) count[e.type] = (count[e.type]||0)+1;

      const summary = [
        `${sourceName}`,
        `T·ªïng d√≤ng: ${allRows.length}`,
        `D√≤ng X-quang (sau l·ªçc): ${xqRows.length}`,
        `T·ªïng l·ªói (3 lo·∫°i): ${filtered.length}`,
        `L·ªçc ng√†y: ${$("fromDate").value||"(kh√¥ng)"} ‚Üí ${$("toDate").value||"(kh√¥ng)"}`,
        `L·ªçc gi·ªù: ${$("fromTime").value||"00:00"} ‚Üí ${$("toTime").value||"23:59"}`,
        `Ph√¢n lo·∫°i: ` + ALLOWED_TYPES.map(t=>`${t}: ${count[t]||0}`).join(", ")
      ].join("\n");

      try{
        await navigator.clipboard.writeText(summary);
        const btn = $("btnCopySummary");
        btn.textContent="ƒê√£ copy ‚úî";
        setTimeout(()=>btn.textContent="üìã Copy t√≥m t·∫Øt", 1100);
      }catch(e){
        showDiag(summary, "warning");
      }
    });

    $("btnCheckXlsx").addEventListener("click", ()=>{
      const ok = setXlsxStatus();
      if(ok) hideDiag();
      else showDiag("Kh√¥ng th·∫•y th∆∞ vi·ªán XLSX.\n‚û°Ô∏è ƒê·∫∑t file xlsx.full.min.js c√πng th∆∞ m·ª•c v·ªõi index.html (offline/GitHub Pages), ho·∫∑c d√πng CSV.", "danger");
    });

    window.addEventListener("load", ()=>{
      setXlsxStatus();
      if (!canReadExcel()){
        showDiag("L∆∞u √Ω: Kh√¥ng ƒë·ªçc/xu·∫•t Excel v√¨ thi·∫øu xlsx.full.min.js.\nB·∫°n v·∫´n d√πng ƒë∆∞·ª£c CSV: Excel ‚Üí Save As ‚Üí CSV UTF-8.", "warning");
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
